---
title: Annullamento in thread gestiti
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- cancellation in .NET, overview
ms.assetid: eea11fe5-d8b0-4314-bb5d-8a58166fb1c3
ms.openlocfilehash: e56d0f71afdc9281271b7d15316a133e7c720bd0
ms.sourcegitcommit: 33deec3e814238fb18a49b2a7e89278e27888291
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/02/2020
ms.locfileid: "84277882"
---
# <a name="cancellation-in-managed-threads"></a><span data-ttu-id="7d68f-102">Annullamento in thread gestiti</span><span class="sxs-lookup"><span data-stu-id="7d68f-102">Cancellation in Managed Threads</span></span>
<span data-ttu-id="7d68f-103">A partire da .NET Framework 4, .NET Framework usa un modello unificato per l'annullamento cooperativo di operazioni asincrone o di operazioni sincrone a esecuzione prolungata.</span><span class="sxs-lookup"><span data-stu-id="7d68f-103">Starting with the .NET Framework 4, the .NET Framework uses a unified model for cooperative cancellation of asynchronous or long-running synchronous operations.</span></span> <span data-ttu-id="7d68f-104">Questo modello è basato su un oggetto leggero chiamato token di annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-104">This model is based on a lightweight object called a cancellation token.</span></span> <span data-ttu-id="7d68f-105">L'oggetto che richiama una o più operazioni annullabili, ad esempio tramite la creazione di nuovi thread o attività, passa il token a ogni operazione.</span><span class="sxs-lookup"><span data-stu-id="7d68f-105">The object that invokes one or more cancelable operations, for example by creating new threads or tasks, passes the token to each operation.</span></span> <span data-ttu-id="7d68f-106">Singole operazioni possono a loro volta passare copie del token ad altre operazioni.</span><span class="sxs-lookup"><span data-stu-id="7d68f-106">Individual operations can in turn pass copies of the token to other operations.</span></span> <span data-ttu-id="7d68f-107">In un secondo momento, l'oggetto che ha creato il token può usarlo per richiedere che le operazioni arrestino le rispettive attività.</span><span class="sxs-lookup"><span data-stu-id="7d68f-107">At some later time, the object that created the token can use it to request that the operations stop what they are doing.</span></span> <span data-ttu-id="7d68f-108">Solo l'oggetto richiedente può inviare la richiesta di annullamento e ogni listener è responsabile del rilevamento della richiesta e della relativa risposta in modo appropriato e tempestivo.</span><span class="sxs-lookup"><span data-stu-id="7d68f-108">Only the requesting object can issue the cancellation request, and each listener is responsible for noticing the request and responding to it in an appropriate and timely manner.</span></span>  
  
 <span data-ttu-id="7d68f-109">Il criterio generale per implementare il modello di annullamento cooperativo è il seguente:</span><span class="sxs-lookup"><span data-stu-id="7d68f-109">The general pattern for implementing the cooperative cancellation model is:</span></span>  
  
- <span data-ttu-id="7d68f-110">Creare un'istanza di un oggetto <xref:System.Threading.CancellationTokenSource>, che gestisce e invia la notifica di annullamento ai singoli token di annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-110">Instantiate a <xref:System.Threading.CancellationTokenSource> object, which manages and sends cancellation notification to the individual cancellation tokens.</span></span>  
  
- <span data-ttu-id="7d68f-111">Passare il token restituito dalla proprietà <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> a ogni attività o thread in attesa di annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-111">Pass the token returned by the <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> property to each task or thread that listens for cancellation.</span></span>  
  
- <span data-ttu-id="7d68f-112">Specificare un meccanismo per ogni attività o thread per rispondere all'annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-112">Provide a mechanism for each task or thread to respond to cancellation.</span></span>  
  
- <span data-ttu-id="7d68f-113">Chiamare il metodo <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> per fornire la notifica di annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-113">Call the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method to provide notification of cancellation.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="7d68f-114">La classe <xref:System.Threading.CancellationTokenSource> implementa l'interfaccia <xref:System.IDisposable>.</span><span class="sxs-lookup"><span data-stu-id="7d68f-114">The <xref:System.Threading.CancellationTokenSource> class implements the <xref:System.IDisposable> interface.</span></span> <span data-ttu-id="7d68f-115">Assicurarsi di chiamare il metodo <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> dopo aver usato l'origine del token di annullamento per liberare qualsiasi risorsa gestita che contiene.</span><span class="sxs-lookup"><span data-stu-id="7d68f-115">You should be sure to call the <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> method when you have finished using the cancellation token source to free any unmanaged resources it holds.</span></span>  
  
 <span data-ttu-id="7d68f-116">L'immagine seguente mostra la relazione tra l'origine di un token e tutte le copie del token.</span><span class="sxs-lookup"><span data-stu-id="7d68f-116">The following illustration shows the relationship between a token source and all the copies of its token.</span></span>  
  
 <span data-ttu-id="7d68f-117">![CancellationTokenSource e token di annullamento](media/vs-cancellationtoken.png "VS_CancellationToken")</span><span class="sxs-lookup"><span data-stu-id="7d68f-117">![CancellationTokenSource and cancellation tokens](media/vs-cancellationtoken.png "VS_CancellationToken")</span></span>  
  
 <span data-ttu-id="7d68f-118">Il nuovo modello di annullamento semplifica la creazione di applicazioni e librerie in grado di riconoscere l'annullamento e supporta le funzionalità seguenti:</span><span class="sxs-lookup"><span data-stu-id="7d68f-118">The new cancellation model makes it easier to create cancellation-aware applications and libraries, and it supports the following features:</span></span>  
  
- <span data-ttu-id="7d68f-119">L'annullamento è cooperativo e non viene forzato nel listener.</span><span class="sxs-lookup"><span data-stu-id="7d68f-119">Cancellation is cooperative and is not forced on the listener.</span></span> <span data-ttu-id="7d68f-120">Il listener determina come eseguire normalmente la terminazione in risposta a una richiesta di annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-120">The listener determines how to gracefully terminate in response to a cancellation request.</span></span>  
  
- <span data-ttu-id="7d68f-121">La richiesta è diversa dall'ascolto.</span><span class="sxs-lookup"><span data-stu-id="7d68f-121">Requesting is distinct from listening.</span></span> <span data-ttu-id="7d68f-122">Un oggetto che richiama un'operazione annullabile può controllare il momento (se applicabile) in cui è necessario un annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-122">An object that invokes a cancelable operation can control when (if ever) cancellation is requested.</span></span>  
  
- <span data-ttu-id="7d68f-123">L'oggetto richiedente invia la richiesta di annullamento a tutte le copie del token usando solo una chiamata di metodo.</span><span class="sxs-lookup"><span data-stu-id="7d68f-123">The requesting object issues the cancellation request to all copies of the token by using just one method call.</span></span>  
  
- <span data-ttu-id="7d68f-124">Un listener può restare in ascolto di più token simultaneamente unendoli in un *token collegato*.</span><span class="sxs-lookup"><span data-stu-id="7d68f-124">A listener can listen to multiple tokens simultaneously by joining them into one *linked token*.</span></span>  
  
- <span data-ttu-id="7d68f-125">Il codice utente può rilevare e rispondere alle richieste di annullamento dal codice di libreria e il codice di libreria può rilevare e rispondere alle richieste di annullamento dal codice utente.</span><span class="sxs-lookup"><span data-stu-id="7d68f-125">User code can notice and respond to cancellation requests from library code, and library code can notice and respond to cancellation requests from user code.</span></span>  
  
- <span data-ttu-id="7d68f-126">I listener possono ricevere notifiche delle richieste di annullamento tramite polling, registrazione dei callback o attesa di handle di attesa.</span><span class="sxs-lookup"><span data-stu-id="7d68f-126">Listeners can be notified of cancellation requests by polling, callback registration, or waiting on wait handles.</span></span>  
  
## <a name="cancellation-types"></a><span data-ttu-id="7d68f-127">Tipi di annullamento</span><span class="sxs-lookup"><span data-stu-id="7d68f-127">Cancellation Types</span></span>  
 <span data-ttu-id="7d68f-128">Il framework di annullamento viene implementato come set di tipi correlati, elencati nella tabella seguente.</span><span class="sxs-lookup"><span data-stu-id="7d68f-128">The cancellation framework is implemented as a set of related types, which are listed in the following table.</span></span>  
  
|<span data-ttu-id="7d68f-129">Nome tipo</span><span class="sxs-lookup"><span data-stu-id="7d68f-129">Type name</span></span>|<span data-ttu-id="7d68f-130">Descrizione</span><span class="sxs-lookup"><span data-stu-id="7d68f-130">Description</span></span>|  
|---------------|-----------------|  
|<xref:System.Threading.CancellationTokenSource>|<span data-ttu-id="7d68f-131">Oggetto che crea un token di annullamento e che invia inoltre la richiesta di annullamento per tutte le copie del token.</span><span class="sxs-lookup"><span data-stu-id="7d68f-131">Object that creates a cancellation token, and also issues the cancellation request for all copies of that token.</span></span>|  
|<xref:System.Threading.CancellationToken>|<span data-ttu-id="7d68f-132">Tipo di valore leggero passato a uno o più listener, in genere come parametro di un metodo.</span><span class="sxs-lookup"><span data-stu-id="7d68f-132">Lightweight value type passed to one or more listeners, typically as a method parameter.</span></span> <span data-ttu-id="7d68f-133">I listener monitorano il valore della proprietà `IsCancellationRequested` del token tramite polling, callback o handle di attesa.</span><span class="sxs-lookup"><span data-stu-id="7d68f-133">Listeners monitor the value of the `IsCancellationRequested` property of the token by polling, callback, or wait handle.</span></span>|  
|<xref:System.OperationCanceledException>|<span data-ttu-id="7d68f-134">Gli overload del costruttore di questa eccezione accettano un oggetto <xref:System.Threading.CancellationToken> come parametro.</span><span class="sxs-lookup"><span data-stu-id="7d68f-134">Overloads of this exception's constructor accept a <xref:System.Threading.CancellationToken> as a parameter.</span></span> <span data-ttu-id="7d68f-135">I listener possono facoltativamente generare questa eccezione per verificare l'origine dell'annullamento e notificare ad altri che ha risposto a una richiesta di annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-135">Listeners can optionally throw this exception to verify the source of the cancellation and notify others that it has responded to a cancellation request.</span></span>|  
  
 <span data-ttu-id="7d68f-136">Il nuovo modello di annullamento è integrato in .NET Framework in diversi tipi.</span><span class="sxs-lookup"><span data-stu-id="7d68f-136">The new cancellation model is integrated into the .NET Framework in several types.</span></span> <span data-ttu-id="7d68f-137">I più importanti sono <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> e <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="7d68f-137">The most important ones are <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span></span> <span data-ttu-id="7d68f-138">È consigliabile usare questo nuovo modello di annullamento per tutto il nuovo codice di libreria e applicazione.</span><span class="sxs-lookup"><span data-stu-id="7d68f-138">We recommend that you use this new cancellation model for all new library and application code.</span></span>  
  
## <a name="code-example"></a><span data-ttu-id="7d68f-139">Esempio di codice</span><span class="sxs-lookup"><span data-stu-id="7d68f-139">Code Example</span></span>  
 <span data-ttu-id="7d68f-140">Nell'esempio seguente l'oggetto richiedente crea un oggetto <xref:System.Threading.CancellationTokenSource> e quindi ne passa la proprietà <xref:System.Threading.CancellationTokenSource.Token%2A> all'operazione annullabile.</span><span class="sxs-lookup"><span data-stu-id="7d68f-140">In the following example, the requesting object creates a <xref:System.Threading.CancellationTokenSource> object, and then passes its <xref:System.Threading.CancellationTokenSource.Token%2A> property to the cancelable operation.</span></span> <span data-ttu-id="7d68f-141">L'operazione che riceve la richiesta monitora il valore della proprietà <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> del token tramite polling.</span><span class="sxs-lookup"><span data-stu-id="7d68f-141">The operation that receives the request monitors the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token by polling.</span></span> <span data-ttu-id="7d68f-142">Quando il valore diventa `true`, il listener può essere terminato nel modo più appropriato.</span><span class="sxs-lookup"><span data-stu-id="7d68f-142">When the value becomes `true`, the listener can terminate in whatever manner is appropriate.</span></span> <span data-ttu-id="7d68f-143">In questo esempio avviene semplicemente l'uscita del metodo, che nella maggior parte dei casi è tutto ciò che serve.</span><span class="sxs-lookup"><span data-stu-id="7d68f-143">In this example, the method just exits, which is all that is required in many cases.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="7d68f-144">L'esempio usa il metodo <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> per dimostrare che il nuovo framework di annullamento è compatibile con le API legacy.</span><span class="sxs-lookup"><span data-stu-id="7d68f-144">The example uses the <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> method to demonstrate that the new cancellation framework is compatible with legacy APIs.</span></span> <span data-ttu-id="7d68f-145">Per un esempio che usi il nuovo tipo <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> preferito, vedere [Procedura: Annullare un'attività e i relativi figli](../parallel-programming/how-to-cancel-a-task-and-its-children.md).</span><span class="sxs-lookup"><span data-stu-id="7d68f-145">For an example that uses the new, preferred <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> type, see [How to: Cancel a Task and Its Children](../parallel-programming/how-to-cancel-a-task-and-its-children.md).</span></span>  
  
 [!code-csharp[Cancellation#1](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex1.cs#1)]
 [!code-vb[Cancellation#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex1.vb#1)]  
  
## <a name="operation-cancellation-versus-object-cancellation"></a><span data-ttu-id="7d68f-146">Confronto tra l'annullamento di operazioni e l'annullamento di oggetti</span><span class="sxs-lookup"><span data-stu-id="7d68f-146">Operation Cancellation Versus Object Cancellation</span></span>  
 <span data-ttu-id="7d68f-147">Nel nuovo framework di annullamento l'annullamento è riferito alle operazioni e non agli oggetti.</span><span class="sxs-lookup"><span data-stu-id="7d68f-147">In the new cancellation framework, cancellation refers to operations, not objects.</span></span> <span data-ttu-id="7d68f-148">La richiesta di annullamento significa che l'operazione deve essere arrestata il prima possibile dopo l'esecuzione della pulizia necessaria.</span><span class="sxs-lookup"><span data-stu-id="7d68f-148">The cancellation request means that the operation should stop as soon as possible after any required cleanup is performed.</span></span> <span data-ttu-id="7d68f-149">Un token di annullamento deve fare riferimento a una "operazione annullabile", ma tale operazione può essere implementata nel programma.</span><span class="sxs-lookup"><span data-stu-id="7d68f-149">One cancellation token should refer to one "cancelable operation," however that operation may be implemented in your program.</span></span> <span data-ttu-id="7d68f-150">Se la proprietà <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> del token viene impostata su `true`, non può più essere reimpostata su `false`.</span><span class="sxs-lookup"><span data-stu-id="7d68f-150">After the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token has been set to `true`, it cannot be reset to `false`.</span></span> <span data-ttu-id="7d68f-151">Di conseguenza, i token di annullamento non possono essere riutilizzati una volta annullati.</span><span class="sxs-lookup"><span data-stu-id="7d68f-151">Therefore, cancellation tokens cannot be reused after they have been canceled.</span></span>  
  
 <span data-ttu-id="7d68f-152">Se è necessario un meccanismo di annullamento di oggetti, è possibile basarlo sul meccanismo di annullamento di operazioni chiamando il metodo <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType>, come mostrato nell'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="7d68f-152">If you require an object cancellation mechanism, you can base it on the operation cancellation mechanism by calling the <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType> method, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#2](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/objectcancellation1.cs#2)]
 [!code-vb[Cancellation#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/objectcancellation1.vb#2)]  
  
 <span data-ttu-id="7d68f-153">Se un oggetto supporta più operazioni annullabili simultanee, passare un token separato come input a ogni operazione annullabile diversa.</span><span class="sxs-lookup"><span data-stu-id="7d68f-153">If an object supports more than one concurrent cancelable operation, pass a separate token as input to each distinct cancelable operation.</span></span> <span data-ttu-id="7d68f-154">In questo modo, è possibile annullare un'operazione senza influire sulle altre.</span><span class="sxs-lookup"><span data-stu-id="7d68f-154">That way, one operation can be cancelled without affecting the others.</span></span>  
  
## <a name="listening-and-responding-to-cancellation-requests"></a><span data-ttu-id="7d68f-155">Ascolto e risposta alle richieste di annullamento</span><span class="sxs-lookup"><span data-stu-id="7d68f-155">Listening and Responding to Cancellation Requests</span></span>  
 <span data-ttu-id="7d68f-156">Nel delegato dell'utente l'implementatore di un'operazione annullabile determina il modo in cui terminare l'operazione in risposta a una richiesta di annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-156">In the user delegate, the implementer of a cancelable operation determines how to terminate the operation in response to a cancellation request.</span></span> <span data-ttu-id="7d68f-157">In molti casi, il delegato dell'utente può eseguire solo la pulizia necessaria e quindi riprendere immediatamente.</span><span class="sxs-lookup"><span data-stu-id="7d68f-157">In many cases, the user delegate can just perform any required cleanup and then return immediately.</span></span>  
  
 <span data-ttu-id="7d68f-158">Tuttavia, in casi più complessi il delegato dell'utente potrebbe dover notificare al codice di libreria il verificarsi dell'annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-158">However, in more complex cases, it might be necessary for the user delegate to notify library code that cancellation has occurred.</span></span> <span data-ttu-id="7d68f-159">In questi casi, il modo corretto di terminare l'operazione per il delegato consiste nel chiamare il metodo <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A>, che provoca la generazione di un'eccezione <xref:System.OperationCanceledException>.</span><span class="sxs-lookup"><span data-stu-id="7d68f-159">In such cases, the correct way to terminate the operation is for the delegate to call the <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A>, method, which will cause an <xref:System.OperationCanceledException> to be thrown.</span></span> <span data-ttu-id="7d68f-160">Il codice di libreria può rilevare l'eccezione nel thread del delegato dell'utente ed esaminare il token dell'eccezione per determinare se l'eccezione indica l'annullamento cooperativo o un'altra situazione eccezionale.</span><span class="sxs-lookup"><span data-stu-id="7d68f-160">Library code can catch this exception on the user delegate thread and examine the exception's token to determine whether the exception indicates cooperative cancellation or some other exceptional situation.</span></span>  
  
 <span data-ttu-id="7d68f-161">La classe <xref:System.Threading.Tasks.Task> gestisce <xref:System.OperationCanceledException> in questo modo.</span><span class="sxs-lookup"><span data-stu-id="7d68f-161">The <xref:System.Threading.Tasks.Task> class handles <xref:System.OperationCanceledException> in this way.</span></span> <span data-ttu-id="7d68f-162">Per altre informazioni, vedere [Task Cancellation](../parallel-programming/task-cancellation.md).</span><span class="sxs-lookup"><span data-stu-id="7d68f-162">For more information, see [Task Cancellation](../parallel-programming/task-cancellation.md).</span></span>  
  
### <a name="listening-by-polling"></a><span data-ttu-id="7d68f-163">Ascolto tramite polling</span><span class="sxs-lookup"><span data-stu-id="7d68f-163">Listening by Polling</span></span>  
 <span data-ttu-id="7d68f-164">Per calcoli a esecuzione prolungata che eseguono cicli o sono ricorsivi, è possibile restare in ascolto di una richiesta di annullamento eseguendo periodicamente il polling del valore della proprietà <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="7d68f-164">For long-running computations that loop or recurse, you can listen for a cancellation request by periodically polling the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="7d68f-165">Se il valore della proprietà è `true`, il metodo deve eseguire la pulizia e quindi deve essere terminato il più rapidamente possibile.</span><span class="sxs-lookup"><span data-stu-id="7d68f-165">If its value is `true`, the method should clean up and terminate as quickly as possible.</span></span> <span data-ttu-id="7d68f-166">La frequenza di polling ottimale dipende dal tipo di applicazione.</span><span class="sxs-lookup"><span data-stu-id="7d68f-166">The optimal frequency of polling depends on the type of application.</span></span> <span data-ttu-id="7d68f-167">È compito dello sviluppatore determinare la migliore frequenza di polling per qualsiasi programma specifico.</span><span class="sxs-lookup"><span data-stu-id="7d68f-167">It is up to the developer to determine the best polling frequency for any given program.</span></span> <span data-ttu-id="7d68f-168">Il polling in sé non ha un impatto significativo sulle prestazioni.</span><span class="sxs-lookup"><span data-stu-id="7d68f-168">Polling itself does not significantly impact performance.</span></span> <span data-ttu-id="7d68f-169">L'esempio seguente mostra uno dei modi in cui è possibile eseguire il polling.</span><span class="sxs-lookup"><span data-stu-id="7d68f-169">The following example shows one possible way to poll.</span></span>  
  
 [!code-csharp[Cancellation#3](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex11.cs#3)]
 [!code-vb[Cancellation#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex11.vb#3)]  
  
 <span data-ttu-id="7d68f-170">Per un esempio più completo, vedere [Procedura: Mettersi in ascolto di richieste di annullamento tramite polling](how-to-listen-for-cancellation-requests-by-polling.md).</span><span class="sxs-lookup"><span data-stu-id="7d68f-170">For a more complete example, see [How to: Listen for Cancellation Requests by Polling](how-to-listen-for-cancellation-requests-by-polling.md).</span></span>  
  
### <a name="listening-by-registering-a-callback"></a><span data-ttu-id="7d68f-171">Ascolto tramite registrazione di un callback</span><span class="sxs-lookup"><span data-stu-id="7d68f-171">Listening by Registering a Callback</span></span>  
 <span data-ttu-id="7d68f-172">Alcune operazioni possono venire bloccate in modo da non poter controllare il valore del token di annullamento in modo tempestivo.</span><span class="sxs-lookup"><span data-stu-id="7d68f-172">Some operations can become blocked in such a way that they cannot check the value of the cancellation token in a timely manner.</span></span> <span data-ttu-id="7d68f-173">In questi casi, è possibile registrare un metodo di callback che sblocca il metodo quando viene ricevuta una richiesta di annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-173">For these cases, you can register a callback method that unblocks the method when a cancellation request is received.</span></span>  
  
 <span data-ttu-id="7d68f-174">Il metodo <xref:System.Threading.CancellationToken.Register%2A> restituisce un oggetto <xref:System.Threading.CancellationTokenRegistration> che viene usato per questo scopo specifico.</span><span class="sxs-lookup"><span data-stu-id="7d68f-174">The <xref:System.Threading.CancellationToken.Register%2A> method returns a <xref:System.Threading.CancellationTokenRegistration> object that is used specifically for this purpose.</span></span> <span data-ttu-id="7d68f-175">L'esempio seguente mostra come usare il metodo <xref:System.Threading.CancellationToken.Register%2A> per annullare una richiesta Web asincrona.</span><span class="sxs-lookup"><span data-stu-id="7d68f-175">The following example shows how to use the <xref:System.Threading.CancellationToken.Register%2A> method to cancel an asynchronous Web request.</span></span>  
  
 [!code-csharp[Cancellation#4](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex4.cs#4)]
 [!code-vb[Cancellation#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex4.vb#4)]  
  
 <span data-ttu-id="7d68f-176">L'oggetto <xref:System.Threading.CancellationTokenRegistration> gestisce la sincronizzazione dei thread e garantisce l'arresto dell'esecuzione del callback in un momento preciso.</span><span class="sxs-lookup"><span data-stu-id="7d68f-176">The <xref:System.Threading.CancellationTokenRegistration> object manages thread synchronization and ensures that the callback will stop executing at a precise point in time.</span></span>  
  
 <span data-ttu-id="7d68f-177">Per garantire velocità di risposta del sistema ed evitare deadlock, è necessario seguire le linee guida indicate di seguito per la registrazione dei callback:</span><span class="sxs-lookup"><span data-stu-id="7d68f-177">In order to ensure system responsiveness and to avoid deadlocks, the following guidelines must be followed when registering callbacks:</span></span>  
  
- <span data-ttu-id="7d68f-178">Il metodo di callback deve essere rapido perché viene chiamato in modo sincrono e di conseguenza la chiamata a <xref:System.Threading.CancellationTokenSource.Cancel%2A> non viene restituita fino alla restituzione del callback.</span><span class="sxs-lookup"><span data-stu-id="7d68f-178">The callback method should be fast because it is called synchronously and therefore the call to <xref:System.Threading.CancellationTokenSource.Cancel%2A> does not return until the callback returns.</span></span>  
  
- <span data-ttu-id="7d68f-179">Se si chiama <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> durante l'esecuzione del callback e si mantiene un blocco di cui il callback è in attesa, il programma può subire un deadlock.</span><span class="sxs-lookup"><span data-stu-id="7d68f-179">If you call <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> while the callback is running, and you hold a lock that the callback is waiting on, your program can deadlock.</span></span> <span data-ttu-id="7d68f-180">Quando viene restituito `Dispose`, è possibile liberare qualsiasi risorsa necessaria per il callback.</span><span class="sxs-lookup"><span data-stu-id="7d68f-180">After `Dispose` returns, you can free any resources required by the callback.</span></span>  
  
- <span data-ttu-id="7d68f-181">I callback non devono eseguire alcun thread manuale o utilizzo di <xref:System.Threading.SynchronizationContext> in un callback.</span><span class="sxs-lookup"><span data-stu-id="7d68f-181">Callbacks should not perform any manual thread or <xref:System.Threading.SynchronizationContext> usage in a callback.</span></span> <span data-ttu-id="7d68f-182">Se un callback deve essere eseguito in un determinato thread, usare il costruttore <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType>, che permette di specificare che l'oggetto syncContext di destinazione è l'oggetto <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType> attivo.</span><span class="sxs-lookup"><span data-stu-id="7d68f-182">If a callback must run on a particular thread, use the <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType> constructor that enables you to specify that the target syncContext is the active <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="7d68f-183">L'esecuzione manuale di threading in un callback può provocare un deadlock.</span><span class="sxs-lookup"><span data-stu-id="7d68f-183">Performing manual threading in a callback can cause deadlock.</span></span>  
  
 <span data-ttu-id="7d68f-184">Per un esempio più completo, vedere [Procedura: Registrare i callback per le richieste di annullamento](how-to-register-callbacks-for-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="7d68f-184">For a more complete example, see [How to: Register Callbacks for Cancellation Requests](how-to-register-callbacks-for-cancellation-requests.md).</span></span>  
  
### <a name="listening-by-using-a-wait-handle"></a><span data-ttu-id="7d68f-185">Ascolto tramite un handle di attesa</span><span class="sxs-lookup"><span data-stu-id="7d68f-185">Listening by Using a Wait Handle</span></span>  
 <span data-ttu-id="7d68f-186">Quando un'operazione annullabile può restare bloccata mentre è in attesa di una primitiva di sincronizzazione come <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> o <xref:System.Threading.Semaphore?displayProperty=nameWithType>, è possibile usare la proprietà <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> per permettere all'operazione di attendere sia l'evento sia la richiesta di annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-186">When a cancelable operation can block while it waits on a synchronization primitive such as a <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> or <xref:System.Threading.Semaphore?displayProperty=nameWithType>, you can use the <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> property to enable the operation to wait on both the event and the cancellation request.</span></span> <span data-ttu-id="7d68f-187">L'handle di attesa del token di annullamento verrà segnalato in risposta a una richiesta di annullamento e il metodo può usare il valore restituito del metodo <xref:System.Threading.WaitHandle.WaitAny%2A> per determinare se la segnalazione è stata eseguita dal token di annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-187">The wait handle of the cancellation token will become signaled in response to a cancellation request, and the method can use the return value of the <xref:System.Threading.WaitHandle.WaitAny%2A> method to determine whether it was the cancellation token that signaled.</span></span> <span data-ttu-id="7d68f-188">L'operazione può quindi semplicemente uscire oppure generare un'eccezione <xref:System.OperationCanceledException>, a seconda del comportamento più appropriato.</span><span class="sxs-lookup"><span data-stu-id="7d68f-188">The operation can then just exit, or throw a <xref:System.OperationCanceledException>, as appropriate.</span></span>  
  
 [!code-csharp[Cancellation#5](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex9.cs#5)]
 [!code-vb[Cancellation#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex9.vb#5)]  
  
 <span data-ttu-id="7d68f-189">Nel nuovo codice destinato a .NET Framework 4, <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> e <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> supportano entrambi il nuovo framework di annullamento nei rispettivi metodi `Wait`.</span><span class="sxs-lookup"><span data-stu-id="7d68f-189">In new code that targets the .NET Framework 4, <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> and <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> both support the new cancellation framework in their `Wait` methods.</span></span> <span data-ttu-id="7d68f-190">È possibile passare <xref:System.Threading.CancellationToken> al metodo e quando viene richiesto l'annullamento, l'evento viene attivato e genera un'eccezione <xref:System.OperationCanceledException>.</span><span class="sxs-lookup"><span data-stu-id="7d68f-190">You can pass the <xref:System.Threading.CancellationToken> to the method, and when the cancellation is requested, the event wakes up and throws an <xref:System.OperationCanceledException>.</span></span>  
  
 [!code-csharp[Cancellation#6](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex10.cs#6)]
 [!code-vb[Cancellation#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex10.vb#6)]  
  
 <span data-ttu-id="7d68f-191">Per un esempio più completo, vedere [Procedura: Mettersi in ascolto di richieste di annullamento con handle di attesa](how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span><span class="sxs-lookup"><span data-stu-id="7d68f-191">For a more complete example, see [How to: Listen for Cancellation Requests That Have Wait Handles](how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span></span>  
  
### <a name="listening-to-multiple-tokens-simultaneously"></a><span data-ttu-id="7d68f-192">Ascolto di più token simultaneamente</span><span class="sxs-lookup"><span data-stu-id="7d68f-192">Listening to Multiple Tokens Simultaneously</span></span>  
 <span data-ttu-id="7d68f-193">In alcuni casi, un listener può dover essere in ascolto di più token di annullamento simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="7d68f-193">In some cases, a listener may have to listen to multiple cancellation tokens simultaneously.</span></span> <span data-ttu-id="7d68f-194">Ad esempio, un'operazione di annullamento può dover monitorare un token di annullamento interno oltre a un token passato esternamente come argomento al parametro di un metodo.</span><span class="sxs-lookup"><span data-stu-id="7d68f-194">For example, a cancelable operation may have to monitor an internal cancellation token in addition to a token passed in externally as an argument to a method parameter.</span></span> <span data-ttu-id="7d68f-195">A questo scopo, creare l'origine di un token collegato in grado di unire due o più token in uno solo, come mostrato nell'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="7d68f-195">To accomplish this, create a linked token source that can join two or more tokens into one token, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#7](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex13.cs#7)]
 [!code-vb[Cancellation#7](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex13.vb#7)]  
  
 <span data-ttu-id="7d68f-196">Notare che è necessario chiamare `Dispose` nell'origine del token collegato al suo completamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-196">Notice that you must call `Dispose` on the linked token source when you are done with it.</span></span> <span data-ttu-id="7d68f-197">Per un esempio più completo, vedere [Procedura: Ascolto di più richieste di annullamento](how-to-listen-for-multiple-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="7d68f-197">For a more complete example, see [How to: Listen for Multiple Cancellation Requests](how-to-listen-for-multiple-cancellation-requests.md).</span></span>  
  
## <a name="cooperation-between-library-code-and-user-code"></a><span data-ttu-id="7d68f-198">Cooperazione tra codice di libreria e codice utente</span><span class="sxs-lookup"><span data-stu-id="7d68f-198">Cooperation Between Library Code and User Code</span></span>  
 <span data-ttu-id="7d68f-199">Il framework di annullamento unificato permette al codice di libreria di annullare il codice utente e al codice utente di annullare il codice libreria in modo cooperativo.</span><span class="sxs-lookup"><span data-stu-id="7d68f-199">The unified cancellation framework makes it possible for library code to cancel user code, and for user code to cancel library code in a cooperative manner.</span></span> <span data-ttu-id="7d68f-200">Una cooperazione uniforme dipende da ognuno dei due lati in base alle linee guida seguenti:</span><span class="sxs-lookup"><span data-stu-id="7d68f-200">Smooth cooperation depends on each side following these guidelines:</span></span>  
  
- <span data-ttu-id="7d68f-201">Se il codice di libreria fornisce operazioni annullabili, deve anche fornire metodi pubblici che accettano un token di annullamento esterno, in modo che il codice utente possa richiedere l'annullamento.</span><span class="sxs-lookup"><span data-stu-id="7d68f-201">If library code provides cancelable operations, it should also provide public methods that accept an external cancellation token so that user code can request cancellation.</span></span>  
  
- <span data-ttu-id="7d68f-202">Se il codice di libreria esegue chiamate nel codice utente, deve interpretare un oggetto OperationCanceledException(externalToken) come *annullamento cooperativo* e non necessariamente come eccezione di errore.</span><span class="sxs-lookup"><span data-stu-id="7d68f-202">If library code calls into user code, the library code should interpret an OperationCanceledException(externalToken) as *cooperative cancellation*, and not necessarily as a failure exception.</span></span>  
  
- <span data-ttu-id="7d68f-203">I delegati dell'utente devono tentare di rispondere alle richieste di annullamento dal codice di libreria in modo tempestivo.</span><span class="sxs-lookup"><span data-stu-id="7d68f-203">User-delegates should attempt to respond to cancellation requests from library code in a timely manner.</span></span>  
  
 <span data-ttu-id="7d68f-204"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> e <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> sono esempi di classi che seguono queste linee guida.</span><span class="sxs-lookup"><span data-stu-id="7d68f-204"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> are examples of classes that follow these guidelines.</span></span> <span data-ttu-id="7d68f-205">Per altre informazioni, vedere [annullamento delle attività](../parallel-programming/task-cancellation.md) e [procedura: annullare una query PLINQ](../parallel-programming/how-to-cancel-a-plinq-query.md).</span><span class="sxs-lookup"><span data-stu-id="7d68f-205">For more information, see [Task Cancellation](../parallel-programming/task-cancellation.md) and [How to: Cancel a PLINQ Query](../parallel-programming/how-to-cancel-a-plinq-query.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="7d68f-206">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="7d68f-206">See also</span></span>

- [<span data-ttu-id="7d68f-207">Nozioni fondamentali sul threading gestito</span><span class="sxs-lookup"><span data-stu-id="7d68f-207">Managed Threading Basics</span></span>](managed-threading-basics.md)
