---
title: Concatenamento di attività tramite attività di continuazione
ms.date: 02/11/2019
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- tasks, continuations
ms.assetid: 0b45e9a2-de28-46ce-8212-1817280ed42d
ms.openlocfilehash: c6952b4b341a76e15d9699a06cd64ae7b6b4f047
ms.sourcegitcommit: 33deec3e814238fb18a49b2a7e89278e27888291
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/02/2020
ms.locfileid: "84285612"
---
# <a name="chaining-tasks-by-using-continuation-tasks"></a><span data-ttu-id="d6f0a-102">Concatenamento di attività tramite attività di continuazione</span><span class="sxs-lookup"><span data-stu-id="d6f0a-102">Chaining Tasks by Using Continuation Tasks</span></span>
<span data-ttu-id="d6f0a-103">Nella programmazione asincrona è comune che, dopo il completamento, un'operazione asincrona chiami una seconda operazione e passi i dati a tale operazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-103">In asynchronous programming, it is common for one asynchronous operation, on completion, to invoke a second operation and pass data to it.</span></span> <span data-ttu-id="d6f0a-104">Tradizionalmente le continuazioni venivano eseguite tramite metodi di callback.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-104">Traditionally, continuations have been done by using callback methods.</span></span> <span data-ttu-id="d6f0a-105">In Task Parallel Library la stessa funzionalità viene resa possibile dalle *attività di continuazione*.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-105">In the Task Parallel Library, the same functionality is provided by *continuation tasks*.</span></span> <span data-ttu-id="d6f0a-106">Un'attivazione di continuazione, chiamata anche semplicemente continuazione, è un'attività asincrona richiamata da un'altra attività, denominata *attività precedente*, al termine di quest'ultima.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-106">A continuation task (also known just as a continuation) is an asynchronous task that is invoked by another task, which is known as the *antecedent*, when the antecedent finishes.</span></span>  
  
 <span data-ttu-id="d6f0a-107">Le continuazioni sono relativamente facili da usare, ma sono comunque potenti e flessibili.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-107">Continuations are relatively easy to use, but are nevertheless powerful and flexible.</span></span> <span data-ttu-id="d6f0a-108">Ad esempio, è possibile:</span><span class="sxs-lookup"><span data-stu-id="d6f0a-108">For example, you can:</span></span>  
  
- <span data-ttu-id="d6f0a-109">Passare dati dall'attività precedente alla continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-109">Pass data from the antecedent to the continuation.</span></span>  
  
- <span data-ttu-id="d6f0a-110">Specificare le condizioni esatte in cui la continuazione verrà richiamata o non richiamata.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-110">Specify the precise conditions under which the continuation will be invoked or not invoked.</span></span>  
  
- <span data-ttu-id="d6f0a-111">Annullare una continuazione prima del suo avvio o cooperativamente durante la sua esecuzione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-111">Cancel a continuation either before it starts or cooperatively as it is running.</span></span>  
  
- <span data-ttu-id="d6f0a-112">Fornire suggerimenti sul modo in cui pianificare la continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-112">Provide hints about how the continuation should be scheduled.</span></span>  
  
- <span data-ttu-id="d6f0a-113">Richiamare più continuazioni dalla stessa attività precedente.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-113">Invoke multiple continuations from the same antecedent.</span></span>  
  
- <span data-ttu-id="d6f0a-114">Richiamare una continuazione al termine di tutte o una delle attività precedenti.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-114">Invoke one continuation when all or any one of multiple antecedents complete.</span></span>  
  
- <span data-ttu-id="d6f0a-115">Concatenare continuazioni una dopo l'altra a qualsiasi lunghezza arbitraria.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-115">Chain continuations one after another to any arbitrary length.</span></span>  
  
- <span data-ttu-id="d6f0a-116">Usare una continuazione per gestire le eccezioni generate dall'attività precedente.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-116">Use a continuation to handle exceptions thrown by the antecedent.</span></span>  
  
## <a name="about-continuations"></a><span data-ttu-id="d6f0a-117">Informazioni sulle continuazioni</span><span class="sxs-lookup"><span data-stu-id="d6f0a-117">About continuations</span></span>  
 <span data-ttu-id="d6f0a-118">Una continuazione è un'attività creata nello stato <xref:System.Threading.Tasks.TaskStatus.WaitingForActivation> .</span><span class="sxs-lookup"><span data-stu-id="d6f0a-118">A continuation is a task that is created in the <xref:System.Threading.Tasks.TaskStatus.WaitingForActivation> state.</span></span> <span data-ttu-id="d6f0a-119">Questa attività viene automaticamente attivata al termine della o delle attività precedenti.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-119">It is activated automatically when its antecedent task or tasks complete.</span></span> <span data-ttu-id="d6f0a-120">Se si chiama <xref:System.Threading.Tasks.Task.Start%2A?displayProperty=nameWithType> in una continuazione nel codice utente, viene generata un'eccezione <xref:System.InvalidOperationException?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="d6f0a-120">Calling <xref:System.Threading.Tasks.Task.Start%2A?displayProperty=nameWithType> on a continuation in user code throws an <xref:System.InvalidOperationException?displayProperty=nameWithType> exception.</span></span>  
  
 <span data-ttu-id="d6f0a-121">Una continuazione è essa stessa un oggetto <xref:System.Threading.Tasks.Task> e non blocca il thread su cui viene avviata.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-121">A continuation is itself a <xref:System.Threading.Tasks.Task> and does not block the thread on which it is started.</span></span> <span data-ttu-id="d6f0a-122">Chiamare il metodo <xref:System.Threading.Tasks.Task.Wait%2A?displayProperty=nameWithType> per bloccare il thread fino al termine dell'attività di continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-122">Call the <xref:System.Threading.Tasks.Task.Wait%2A?displayProperty=nameWithType> method to block until the continuation task finishes.</span></span>  
  
## <a name="creating-a-continuation-for-a-single-antecedent"></a><span data-ttu-id="d6f0a-123">Creazione di una continuazione per una singola attività precedente</span><span class="sxs-lookup"><span data-stu-id="d6f0a-123">Creating a continuation for a single antecedent</span></span>  
 <span data-ttu-id="d6f0a-124">Per creare una continuazione che viene eseguita una volta completata l'attività precedente, chiamare il metodo <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="d6f0a-124">You create a continuation that executes when its antecedent has completed by calling the <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="d6f0a-125">L'esempio seguente mostra il modello di base. Per chiarezza, viene omessa la gestione delle eccezioni.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-125">The following example shows the basic pattern (for clarity, exception handling is omitted).</span></span> <span data-ttu-id="d6f0a-126">Viene eseguita un'attività precedente, `taskA`, che restituisce un oggetto <xref:System.DayOfWeek> che indica il nome del giorno corrente della settimana.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-126">It executes an antecedent task, `taskA`, that returns a <xref:System.DayOfWeek> object that indicates the name of the current day of the week.</span></span> <span data-ttu-id="d6f0a-127">Al termine dell'attività precedente, all'attività di continuazione `continuation` viene passata l'attività precedente e viene visualizzata una stringa che ne include i risultati.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-127">When the antecedent completes, the continuation task, `continuation`, is passed the antecedent and displays a string that includes its result.</span></span>

> [!NOTE]
> <span data-ttu-id="d6f0a-128">Gli esempi C# in questo articolo usano il modificatore `async` nel metodo `Main`.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-128">The C# samples in this article make use of the `async` modifier on the `Main` method.</span></span> <span data-ttu-id="d6f0a-129">Questa funzionalità è disponibile in C# 7.1 e versioni successive.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-129">That feature is available in C# 7.1 and later.</span></span> <span data-ttu-id="d6f0a-130">Le versioni precedenti generano [`CS5001`](../../csharp/misc/cs5001.md) durante la compilazione di questo codice di esempio.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-130">Previous versions generate [`CS5001`](../../csharp/misc/cs5001.md) when compiling this sample code.</span></span> <span data-ttu-id="d6f0a-131">È necessario impostare la versione del linguaggio C# su 7.1 o versione successiva.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-131">You'll need to set the language version to C# 7.1 or newer.</span></span> <span data-ttu-id="d6f0a-132">Per istruzioni, vedere l'articolo sulla [configurazione della versione del linguaggio](../../csharp/language-reference/configure-language-version.md).</span><span class="sxs-lookup"><span data-stu-id="d6f0a-132">You can learn how to configure the language version in the article on [configure language version](../../csharp/language-reference/configure-language-version.md).</span></span>
  
 [!code-csharp[TPL_Continuations#1](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_continuations/cs/simple1.cs#1)]
 [!code-vb[TPL_Continuations#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/simple1.vb#1)]  
  
## <a name="creating-a-continuation-for-multiple-antecedents"></a><span data-ttu-id="d6f0a-133">Creazione di una continuazione per più attività precedenti</span><span class="sxs-lookup"><span data-stu-id="d6f0a-133">Creating a continuation for multiple antecedents</span></span>  
 <span data-ttu-id="d6f0a-134">È anche possibile creare una continuazione che verrà eseguita al termine di una o tutte le attività di un gruppo di attività.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-134">You can also create a continuation that will run when any or all of a group of tasks has completed.</span></span> <span data-ttu-id="d6f0a-135">Per eseguire una continuazione al termine di tutte le attività precedenti, chiamare il metodo statico (`Shared` in Visual Basic) <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> o il metodo <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> dell'istanza.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-135">To execute a continuation when all antecedent tasks have completed, you call the static (`Shared` in Visual Basic) <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> method or the instance <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="d6f0a-136">Per eseguire una continuazione al termine delle attività precedenti, chiamare il metodo statico (`Shared` in Visual Basic) <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> o il metodo <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAny%2A?displayProperty=nameWithType> dell'istanza.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-136">To execute a continuation when any of the antecedent tasks has completed, you call the static (`Shared` in Visual Basic) <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> method or the instance <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAny%2A?displayProperty=nameWithType> method.</span></span>  
  
 <span data-ttu-id="d6f0a-137">Si noti che le chiamate agli overload <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> e <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> non bloccano il thread chiamante.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-137">Note that calls to the <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> and <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> overloads do not block the calling thread.</span></span>  <span data-ttu-id="d6f0a-138">Tuttavia, in genere si eseguono chiamate a tutti gli elementi ad eccezione dei metodi <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> e  <xref:System.Threading.Tasks.Task.WhenAll%28System.Threading.Tasks.Task%5B%5D%29?displayProperty=nameWithType> per recuperare la proprietà  <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> restituita, che blocca il thread chiamante.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-138">However, you typically call all but the <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> and  <xref:System.Threading.Tasks.Task.WhenAll%28System.Threading.Tasks.Task%5B%5D%29?displayProperty=nameWithType> methods to retrieve the returned  <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property, which does block the calling thread.</span></span>  
  
 <span data-ttu-id="d6f0a-139">Nell'esempio seguente viene chiamato il metodo <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> per creare un'attività di continuazione che riflette il risultato delle 10 attività precedenti.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-139">The following example calls the <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> method to create a continuation task that reflects the results of its 10 antecedent tasks.</span></span> <span data-ttu-id="d6f0a-140">Ogni attività precedente eleva al quadrato un valore di indice compreso tra uno e 10.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-140">Each antecedent task squares an index value that ranges from one to 10.</span></span> <span data-ttu-id="d6f0a-141">Se le attività precedenti vengono completate correttamente (ovvero la relativa proprietà <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> è <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>), la proprietà <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> della continuazione è una matrice dei valori <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> restituiti da ogni attività precedente.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-141">If the antecedents complete successfully (their <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> property is <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>), the <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property of the continuation is an array of the <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> values returned by each antecedent.</span></span> <span data-ttu-id="d6f0a-142">L'esempio somma tali valori per calcolare la somma dei quadrati per tutti i numeri compresi tra uno e 10.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-142">The example adds them to compute the sum of squares for all numbers between one and 10.</span></span>  
  
 [!code-csharp[TPL_Continuations#5](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_continuations/cs/whenall1.cs#5)]
 [!code-vb[TPL_Continuations#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/whenall1.vb#5)]  
  
## <a name="continuation-options"></a><span data-ttu-id="d6f0a-143">Opzioni per le continuazioni</span><span class="sxs-lookup"><span data-stu-id="d6f0a-143">Continuation options</span></span>  
 <span data-ttu-id="d6f0a-144">Quando si crea un continuazione ad attività singola, è possibile usare un overload <xref:System.Threading.Tasks.Task.ContinueWith%2A> che accetta un valore di enumerazione <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> per specificare le condizioni in cui viene avviata la continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-144">When you create a single-task continuation, you can use a <xref:System.Threading.Tasks.Task.ContinueWith%2A> overload that takes a <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> enumeration value to specify the conditions under which the continuation starts.</span></span> <span data-ttu-id="d6f0a-145">Ad esempio, è possibile specificare che la continuazione venga eseguita solo se l'attività precedente viene completata correttamente o se viene completata con uno stato di errore.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-145">For example, you can specify that the continuation is to run only if the antecedent completes successfully, or only if it completes in a faulted state.</span></span> <span data-ttu-id="d6f0a-146">Se la condizione non è true quando l'attività precedente è pronta per chiamare la continuazione, questa passa direttamente allo stato <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> e successivamente non può più essere avviata.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-146">If the condition is not true when the antecedent is ready to invoke the continuation, the continuation transitions directly to the <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> state and subsequently cannot be started.</span></span>  
  
 <span data-ttu-id="d6f0a-147">Alcuni metodi di continuazione multiattività, come gli overload del metodo <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> , includono anche un parametro <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="d6f0a-147">A number of multi-task continuation methods, such as overloads of the <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> method, also include a <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> parameter.</span></span> <span data-ttu-id="d6f0a-148">Tuttavia, è valido solo un subset di tutti i membri dell'enumerazione <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="d6f0a-148">Only a subset of all <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> enumeration members are valid, however.</span></span> <span data-ttu-id="d6f0a-149">È possibile specificare valori <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> per cui esistono controparti nell'enumerazione <xref:System.Threading.Tasks.TaskCreationOptions?displayProperty=nameWithType> , come <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType>, <xref:System.Threading.Tasks.TaskContinuationOptions.LongRunning?displayProperty=nameWithType>e <xref:System.Threading.Tasks.TaskContinuationOptions.PreferFairness?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-149">You can specify <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> values that have counterparts in the <xref:System.Threading.Tasks.TaskCreationOptions?displayProperty=nameWithType> enumeration, such as <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType>, <xref:System.Threading.Tasks.TaskContinuationOptions.LongRunning?displayProperty=nameWithType>, and <xref:System.Threading.Tasks.TaskContinuationOptions.PreferFairness?displayProperty=nameWithType>.</span></span> <span data-ttu-id="d6f0a-150">Se si specifica una qualsiasi delle opzioni `NotOn` o `OnlyOn` con una continuazione multiattività, viene generata un'eccezione <xref:System.ArgumentOutOfRangeException> in fase di esecuzione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-150">If you specify any of the `NotOn` or `OnlyOn` options with a multi-task continuation, an <xref:System.ArgumentOutOfRangeException> exception will be thrown at run time.</span></span>  
  
 <span data-ttu-id="d6f0a-151">Per altre informazioni sulle opzioni per la continuazione delle attività, vedere l'argomento <xref:System.Threading.Tasks.TaskContinuationOptions> .</span><span class="sxs-lookup"><span data-stu-id="d6f0a-151">For more information on task continuation options, see the <xref:System.Threading.Tasks.TaskContinuationOptions> topic.</span></span>  
  
## <a name="passing-data-to-a-continuation"></a><span data-ttu-id="d6f0a-152">Passaggio di dati a una continuazione</span><span class="sxs-lookup"><span data-stu-id="d6f0a-152">Passing Data to a Continuation</span></span>  
 <span data-ttu-id="d6f0a-153">Il metodo <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> passa come argomento un riferimento all'attività precedente al delegato dell'utente della continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-153">The <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> method passes a reference to the antecedent to the user delegate of the continuation as an argument.</span></span> <span data-ttu-id="d6f0a-154">Se l'attività precedente è un oggetto <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> e l'attività è stata eseguita fino al suo completamento, la continuazione può accedere alla proprietà <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> dell'attività.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-154">If the antecedent is a <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> object, and the task ran until it was completed, then the continuation can access the <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property of the task.</span></span>  
  
 <span data-ttu-id="d6f0a-155">La proprietà <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> è bloccata fino al completamento dell'attività.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-155">The <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property blocks until the task has completed.</span></span> <span data-ttu-id="d6f0a-156">Tuttavia, se l'attività è stata annullata o è in errore, il tentativo di accedere alla proprietà <xref:System.Threading.Tasks.Task%601.Result%2A> genera un'eccezione <xref:System.AggregateException> .</span><span class="sxs-lookup"><span data-stu-id="d6f0a-156">However, if the task was canceled or faulted, attempting to access the <xref:System.Threading.Tasks.Task%601.Result%2A> property throws an <xref:System.AggregateException> exception.</span></span> <span data-ttu-id="d6f0a-157">È possibile evitare questo problema usando l'opzione <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnRanToCompletion> , come mostrato nell'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-157">You can avoid this problem by using the <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnRanToCompletion> option, as shown in the following example.</span></span>  
  
 [!code-csharp[TPL_Continuations#2](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_continuations/cs/result1.cs#2)]
 [!code-vb[TPL_Continuations#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/result1.vb#2)]  
  
 <span data-ttu-id="d6f0a-158">Se si vuole che la continuazione venga eseguita anche se l'attività precedente non è stata eseguita fino al completamento, è necessario proteggersi dall'eccezione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-158">If you want the continuation to run even if the antecedent did not run to successful completion, you must guard against the exception.</span></span> <span data-ttu-id="d6f0a-159">Un approccio consiste nel testare la proprietà <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> dell'attività precedente e nel tentare di accedere alla proprietà <xref:System.Threading.Tasks.Task%601.Result%2A> solo se lo stato è diverso da <xref:System.Threading.Tasks.TaskStatus.Faulted> o <xref:System.Threading.Tasks.TaskStatus.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-159">One approach is to test the <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> property of the antecedent, and only attempt to access the <xref:System.Threading.Tasks.Task%601.Result%2A> property if the status is not <xref:System.Threading.Tasks.TaskStatus.Faulted> or <xref:System.Threading.Tasks.TaskStatus.Canceled>.</span></span> <span data-ttu-id="d6f0a-160">È anche possibile esaminare la proprietà <xref:System.Threading.Tasks.Task.Exception%2A> dell'attività precedente.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-160">You can also examine the <xref:System.Threading.Tasks.Task.Exception%2A> property of the antecedent.</span></span> <span data-ttu-id="d6f0a-161">Per altre informazioni, vedere [Gestione delle eccezioni](exception-handling-task-parallel-library.md).</span><span class="sxs-lookup"><span data-stu-id="d6f0a-161">For more information, see [Exception Handling](exception-handling-task-parallel-library.md).</span></span> <span data-ttu-id="d6f0a-162">Nell'esempio seguente viene modificato l'esempio precedente in modo da accedere alla proprietà <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> dell'attività precedente solo se lo stato è <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-162">The following example modifies the previous example to access antecedent's <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property only if its status is <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>.</span></span>  
  
 [!code-csharp[TPL_Continuations#7](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_continuations/cs/result2.cs#7)]
 [!code-vb[TPL_Continuations#7](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/result2.vb#7)]  
  
## <a name="canceling-a-continuation"></a><span data-ttu-id="d6f0a-163">Annullamento di una continuazione</span><span class="sxs-lookup"><span data-stu-id="d6f0a-163">Canceling a Continuation</span></span>  
 <span data-ttu-id="d6f0a-164">La proprietà <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> di una continuazione è impostata su <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> nelle situazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="d6f0a-164">The <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> property of a continuation is set to <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> in the following situations:</span></span>  
  
- <span data-ttu-id="d6f0a-165">Genera un'eccezione <xref:System.OperationCanceledException> in risposta a una richiesta di annullamento.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-165">It throws an <xref:System.OperationCanceledException> exception in response to a cancellation request.</span></span> <span data-ttu-id="d6f0a-166">Come per qualsiasi attività, se l'eccezione contiene lo stesso token passato alla continuazione, viene considerato un acknowledgement di annullamento cooperativo.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-166">As with any task, if the exception contains the same token that was passed to the continuation, it is treated as an acknowledgement of cooperative cancellation.</span></span>  
  
- <span data-ttu-id="d6f0a-167">Alla continuazione viene passato un oggetto <xref:System.Threading.CancellationToken?displayProperty=nameWithType> la cui proprietà <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> è `true`.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-167">The continuation is passed a <xref:System.Threading.CancellationToken?displayProperty=nameWithType> whose <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property is `true`.</span></span> <span data-ttu-id="d6f0a-168">In questo caso, la continuazione non viene avviata e passa allo stato <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="d6f0a-168">In this case, the continuation does not start, and it transitions to the <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> state.</span></span>  
  
- <span data-ttu-id="d6f0a-169">La continuazione non viene mai eseguita perché la condizione impostata dal relativo argomento <xref:System.Threading.Tasks.TaskContinuationOptions> non è stata soddisfatta.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-169">The continuation never runs because the condition set by its <xref:System.Threading.Tasks.TaskContinuationOptions> argument was not met.</span></span> <span data-ttu-id="d6f0a-170">Ad esempio, se un'attività precedente passa a uno stato <xref:System.Threading.Tasks.TaskStatus.Faulted?displayProperty=nameWithType> , la relativa continuazione a cui è stata passata l'opzione <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnFaulted?displayProperty=nameWithType> non verrà eseguita, ma passerà allo stato <xref:System.Threading.Tasks.TaskStatus.Canceled> .</span><span class="sxs-lookup"><span data-stu-id="d6f0a-170">For example, if an antecedent goes into a <xref:System.Threading.Tasks.TaskStatus.Faulted?displayProperty=nameWithType> state, its continuation that was passed the <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnFaulted?displayProperty=nameWithType> option will not run but will transition to the <xref:System.Threading.Tasks.TaskStatus.Canceled> state.</span></span>  
  
 <span data-ttu-id="d6f0a-171">Se un'attività e la relativa continuazione rappresentano due parti della stessa operazione logica, è possibile passare lo stesso token di annullamento a entrambe le attività, come mostrato nell'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-171">If a task and its continuation represent two parts of the same logical operation, you can pass the same cancellation token to both tasks, as shown in the following example.</span></span> <span data-ttu-id="d6f0a-172">L'esempio è costituito da un'attività precedente che genera un elenco di numeri interi divisibili per 33, che viene passato alla continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-172">It consists of an antecedent that generates a list of integers that are divisible by 33, which it passes to the continuation.</span></span> <span data-ttu-id="d6f0a-173">La continuazione visualizza a sua volta l'elenco.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-173">The continuation in turn displays the list.</span></span> <span data-ttu-id="d6f0a-174">L'attività precedente e la continuazione vengono entrambe sospese regolarmente per intervalli casuali.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-174">Both the antecedent and the continuation pause regularly for random intervals.</span></span> <span data-ttu-id="d6f0a-175">Inoltre, viene usato un oggetto <xref:System.Threading.Timer?displayProperty=nameWithType> per eseguire il metodo `Elapsed` dopo un intervallo di timeout di cinque secondi.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-175">In addition, a <xref:System.Threading.Timer?displayProperty=nameWithType> object is used to execute the `Elapsed` method after a five-second timeout interval.</span></span> <span data-ttu-id="d6f0a-176">Questo esempio chiama il metodo <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType>, che fa sì che l'attività attualmente in esecuzione chiami il metodo <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-176">This example calls the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method, which causes the currently executing task to call the <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="d6f0a-177">Il fatto che il metodo <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> venga chiamato durante l'esecuzione dell'attività precedente o della sua continuazione dipende dalla durata delle pause generate casualmente.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-177">Whether the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method is called when the antecedent or its continuation is executing depends on the duration of the randomly generated pauses.</span></span> <span data-ttu-id="d6f0a-178">Se l'attività precedente viene annullata, la continuazione non verrà avviata.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-178">If the antecedent is canceled, the continuation will not start.</span></span> <span data-ttu-id="d6f0a-179">Se l'attività precedente non viene annullata, il token può comunque essere usato per annullare la continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-179">If the antecedent is not canceled, the token can still be used to cancel the continuation.</span></span>  
  
 [!code-csharp[TPL_Continuations#3](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_continuations/cs/cancellation1.cs#3)]
 [!code-vb[TPL_Continuations#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/cancellation1.vb#3)]  
  
 <span data-ttu-id="d6f0a-180">È anche possibile impedire l'esecuzione di una continuazione se la relativa attività precedente viene annullata senza fornire alla continuazione un token di annullamento, specificando l'opzione <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnCanceled?displayProperty=nameWithType> quando si crea la continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-180">You can also prevent a continuation from executing if its antecedent is canceled without supplying the continuation a cancellation token by specifying the <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnCanceled?displayProperty=nameWithType> option when you create the continuation.</span></span> <span data-ttu-id="d6f0a-181">Di seguito è riportato un esempio semplice.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-181">The following is a simple example.</span></span>  
  
 [!code-csharp[TPL_Continuations#8](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_continuations/cs/cancellation2.cs#8)]
 [!code-vb[TPL_Continuations#8](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/cancellation2.vb#8)]  
  
 <span data-ttu-id="d6f0a-182">Dopo che una continuazione passa allo stato <xref:System.Threading.Tasks.TaskStatus.Canceled> , può influire sulle continuazioni successive, a seconda degli oggetti <xref:System.Threading.Tasks.TaskContinuationOptions> specificati per tali continuazioni.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-182">After a continuation goes into the <xref:System.Threading.Tasks.TaskStatus.Canceled> state, it may affect continuations that follow, depending on the <xref:System.Threading.Tasks.TaskContinuationOptions> that were specified for those continuations.</span></span>  
  
 <span data-ttu-id="d6f0a-183">Le continuazioni eliminate non verranno avviate.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-183">Continuations that are disposed will not start.</span></span>  
  
## <a name="continuations-and-child-tasks"></a><span data-ttu-id="d6f0a-184">Continuazioni e attività figlio</span><span class="sxs-lookup"><span data-stu-id="d6f0a-184">Continuations and Child Tasks</span></span>  
 <span data-ttu-id="d6f0a-185">Una continuazione non viene eseguita fino al completamento dell'attività precedente e di tutte le attività figlio collegate.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-185">A continuation does not run until the antecedent and all of its attached child tasks have completed.</span></span> <span data-ttu-id="d6f0a-186">La continuazione non attende il completamento delle attività figlio scollegate.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-186">The continuation does not wait for detached child tasks to finish.</span></span> <span data-ttu-id="d6f0a-187">I due esempi seguenti mostrano attività figlio collegate e scollegate da un'attività precedente che crea una continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-187">The following two examples illustrate child tasks that are attached to and detached from an antecedent that creates a continuation.</span></span> <span data-ttu-id="d6f0a-188">Nell'esempio seguente la continuazione viene eseguita solo dopo il completamento di tutte le attività figlio e se l'esempio viene eseguito più volte, produce lo stesso output ogni volta.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-188">In the following example, the continuation runs only after all child tasks have completed, and running the example multiple times produces identical output each time.</span></span> <span data-ttu-id="d6f0a-189">Nell'esempio viene avviata l'attività precedente chiamando il metodo <xref:System.Threading.Tasks.TaskFactory.StartNew%2A?displayProperty=nameWithType>, perché per impostazione predefinita il metodo <xref:System.Threading.Tasks.Task.Run%2A?displayProperty=nameWithType> crea un'attività padre la cui opzione di creazione di attività predefinita è <xref:System.Threading.Tasks.TaskCreationOptions.DenyChildAttach?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-189">The example launches the antecedent by calling the <xref:System.Threading.Tasks.TaskFactory.StartNew%2A?displayProperty=nameWithType> method, since by default the <xref:System.Threading.Tasks.Task.Run%2A?displayProperty=nameWithType> method creates a parent task whose default task creation option is <xref:System.Threading.Tasks.TaskCreationOptions.DenyChildAttach?displayProperty=nameWithType>.</span></span>  
  
 [!code-csharp[TPL_Continuations#9](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_continuations/cs/attached1.cs#9)]
 [!code-vb[TPL_Continuations#9](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/attached1.vb#9)]  
  
 <span data-ttu-id="d6f0a-190">Se le attività figlio sono scollegate dall'attività precedente, tuttavia, la continuazione viene eseguita non appena termina l'attività precedente, indipendentemente dallo stato delle attività figlio.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-190">If child tasks are detached from the antecedent, however, the continuation runs as soon as the antecedent has terminated, regardless of the state of the child tasks.</span></span> <span data-ttu-id="d6f0a-191">Di conseguenza, se l'esempio precedente viene eseguito più volte, può produrre output variabile che dipende dal modo in cui il l'utilità di pianificazione delle attività ha gestito ogni singola attività figlio.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-191">As a result, multiple runs of the following example can produce variable output that depends on how the task scheduler handled each child task.</span></span>  
  
 [!code-csharp[TPL_Continuations#10](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_continuations/cs/detached1.cs#10)]
 [!code-vb[TPL_Continuations#10](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/detached1.vb#10)]  
  
 <span data-ttu-id="d6f0a-192">Lo stato finale dell'attività precedente dipende dallo stato finale di tutte le attività figlio scollegate.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-192">The final status of the antecedent task depends on the final status of any attached child tasks.</span></span> <span data-ttu-id="d6f0a-193">Lo stato delle attività figlio scollegate non influisce sull'attività padre.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-193">The status of detached child tasks does not affect the parent.</span></span> <span data-ttu-id="d6f0a-194">Per altre informazioni, vedere [Attività figlio connesse e disconnesse](attached-and-detached-child-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="d6f0a-194">For more information, see [Attached and Detached Child Tasks](attached-and-detached-child-tasks.md).</span></span>  
  
## <a name="associating-state-with-continuations"></a><span data-ttu-id="d6f0a-195">Associazione dello stato alle continuazioni</span><span class="sxs-lookup"><span data-stu-id="d6f0a-195">Associating State with Continuations</span></span>  
 <span data-ttu-id="d6f0a-196">È possibile associare uno stato arbitrario a una continuazione di attività.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-196">You can associate arbitrary state with a task continuation.</span></span> <span data-ttu-id="d6f0a-197">Il metodo <xref:System.Threading.Tasks.Task.ContinueWith%2A> fornisce versioni di overload, ciascuna delle quali può accettare un valore <xref:System.Object> che rappresenta lo stato della continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-197">The <xref:System.Threading.Tasks.Task.ContinueWith%2A> method provides overloaded versions that each take an <xref:System.Object> value that represents the state of the continuation.</span></span> <span data-ttu-id="d6f0a-198">Successivamente, è possibile accedere a questo oggetto stato usando la proprietà <xref:System.Threading.Tasks.Task.AsyncState%2A?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="d6f0a-198">You can later access this state object by using the <xref:System.Threading.Tasks.Task.AsyncState%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="d6f0a-199">Questo oggetto stato è `null` se non si specifica un valore.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-199">This state object is `null` if you do not provide a value.</span></span>  
  
 <span data-ttu-id="d6f0a-200">Lo stato della continuazione è utile quando si converte codice esistente che usa il [modello di programmazione asincrono (APM)](../asynchronous-programming-patterns/asynchronous-programming-model-apm.md) per usare TPL.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-200">Continuation state is useful when you convert existing code that uses the [Asynchronous Programming Model (APM)](../asynchronous-programming-patterns/asynchronous-programming-model-apm.md) to use the TPL.</span></span> <span data-ttu-id="d6f0a-201">Nel modello APM l'oggetto stato viene specificato in genere nel metodo **Begin**_Metodo_. In seguito è possibile accedere a tale stato usando la proprietà <xref:System.IAsyncResult.AsyncState%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-201">In the APM, you typically provide object state in the **Begin**_Method_ method and later access that state by using the <xref:System.IAsyncResult.AsyncState%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="d6f0a-202">Tramite il metodo <xref:System.Threading.Tasks.Task.ContinueWith%2A> è possibile mantenere questo stato quando si converte il codice che usa il modello APM per usare TPL.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-202">By using the <xref:System.Threading.Tasks.Task.ContinueWith%2A> method, you can preserve this state when you convert code that uses the APM to use the TPL.</span></span>  
  
 <span data-ttu-id="d6f0a-203">Lo stato della continuazione può essere utile anche quando si usano oggetti <xref:System.Threading.Tasks.Task> nel debugger di Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-203">Continuation state can also be useful when you work with <xref:System.Threading.Tasks.Task> objects in the Visual Studio debugger.</span></span> <span data-ttu-id="d6f0a-204">Ad esempio, nella finestra **Attività in parallelo** la colonna **Attività** mostra la rappresentazione di stringa dell'oggetto stato per ogni attività.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-204">For example, in the **Parallel Tasks** window, the **Task** column displays the string representation of the state object for each task.</span></span> <span data-ttu-id="d6f0a-205">Per altre informazioni sulla finestra **Attività in parallelo**, vedere [Uso della finestra Attività](/visualstudio/debugger/using-the-tasks-window).</span><span class="sxs-lookup"><span data-stu-id="d6f0a-205">For more information about the **Parallel Tasks** window, see [Using the Tasks Window](/visualstudio/debugger/using-the-tasks-window).</span></span>  
  
 <span data-ttu-id="d6f0a-206">L'esempio seguente mostra come usare lo stato della continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-206">The following example shows how to use continuation state.</span></span> <span data-ttu-id="d6f0a-207">Viene creata una catena di attività di continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-207">It creates a chain of continuation tasks.</span></span> <span data-ttu-id="d6f0a-208">Ogni attività indica la data e l'ora correnti, tramite un oggetto <xref:System.DateTime> , per il parametro `state` del metodo <xref:System.Threading.Tasks.Task.ContinueWith%2A> .</span><span class="sxs-lookup"><span data-stu-id="d6f0a-208">Each task provides the current time, a <xref:System.DateTime> object, for the `state` parameter of the <xref:System.Threading.Tasks.Task.ContinueWith%2A> method.</span></span> <span data-ttu-id="d6f0a-209">Ogni oggetto <xref:System.DateTime> rappresenta la data e l'ora in cui è stata creata l'attività di continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-209">Each <xref:System.DateTime> object represents the time at which the continuation task is created.</span></span> <span data-ttu-id="d6f0a-210">Ogni attività produce come risultato un secondo oggetto <xref:System.DateTime> che rappresenta la data e l'ora di fine dell'attività.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-210">Each task produces as its result a second <xref:System.DateTime> object that represents the time at which the task finishes.</span></span> <span data-ttu-id="d6f0a-211">Al termine di tutte le attività, questo esempio visualizza la data e l'ora di creazione e la data e l'ora di fine di ogni attività di continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-211">After all tasks finish, this example displays the creation time and the time at which each continuation task finishes.</span></span>  
  
 [!code-csharp[TPL_ContinuationState#1](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_continuationstate/cs/continuationstate.cs#1)]
 [!code-vb[TPL_ContinuationState#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuationstate/vb/continuationstate.vb#1)]  
  
## <a name="handling-exceptions-thrown-from-continuations"></a><span data-ttu-id="d6f0a-212">Gestione delle eccezioni generate dalle continuazioni</span><span class="sxs-lookup"><span data-stu-id="d6f0a-212">Handling Exceptions Thrown from Continuations</span></span>  
 <span data-ttu-id="d6f0a-213">Una relazione tra attività precedenti e attività di continuazione non è una relazione padre-figlio.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-213">An antecedent-continuation relationship is not a parent-child relationship.</span></span> <span data-ttu-id="d6f0a-214">Le eccezioni generate dalle continuazioni non vengono propagate all'attività precedente.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-214">Exceptions thrown by continuations are not propagated to the antecedent.</span></span> <span data-ttu-id="d6f0a-215">Di conseguenza, gestire le eccezioni generate dalle continuazioni allo stesso modo in cui si gestisce qualsiasi altra attività, nel modo seguente:</span><span class="sxs-lookup"><span data-stu-id="d6f0a-215">Therefore, handle exceptions thrown by continuations as you would handle them in any other task, as follows:</span></span>  
  
- <span data-ttu-id="d6f0a-216">È possibile usare il metodo <xref:System.Threading.Tasks.Task.Wait%2A>, <xref:System.Threading.Tasks.Task.WaitAll%2A>o <xref:System.Threading.Tasks.Task.WaitAny%2A> , o la controparte generica, per restare in attesa della continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-216">You can use the <xref:System.Threading.Tasks.Task.Wait%2A>, <xref:System.Threading.Tasks.Task.WaitAll%2A>, or <xref:System.Threading.Tasks.Task.WaitAny%2A> method, or its generic counterpart, to wait on the continuation.</span></span> <span data-ttu-id="d6f0a-217">È possibile attendere un'attività precedente e la sua continuazione nella stessa istruzione `try`, come mostrato nell'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-217">You can wait for an antecedent and its continuations in the same `try` statement, as shown in the following example.</span></span>  
  
     [!code-csharp[TPL_Continuations#6](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_continuations/cs/exception1.cs#6)]
     [!code-vb[TPL_Continuations#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/exception1.vb#6)]  
  
- <span data-ttu-id="d6f0a-218">È possibile usare una seconda continuazione per osservare la proprietà <xref:System.Threading.Tasks.Task.Exception%2A> della prima continuazione.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-218">You can use a second continuation to observe the <xref:System.Threading.Tasks.Task.Exception%2A> property of the first continuation.</span></span> <span data-ttu-id="d6f0a-219">Nell'esempio seguente un'attività tenta di leggere da un file inesistente.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-219">In the following example, a task attempts to read from a non-existent file.</span></span> <span data-ttu-id="d6f0a-220">La continuazione visualizza quindi informazioni sull'eccezione nell'attività precedente.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-220">The continuation then displays information about the exception in the antecedent task.</span></span>  
  
     [!code-csharp[TPL_Continuations#4](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_continuations/cs/exception2.cs#4)]
     [!code-vb[TPL_Continuations#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/exception2.vb#4)]  
  
     <span data-ttu-id="d6f0a-221">Poiché è stata usata l'opzione <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnFaulted?displayProperty=nameWithType> , la continuazione viene eseguita solo se si verifica un'eccezione nell'attività precedente e di conseguenza può presupporre che la proprietà <xref:System.Threading.Tasks.Task.Exception%2A> dell'attività precedente non è `null`.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-221">Because it was run with the <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnFaulted?displayProperty=nameWithType> option, the continuation executes only if an exception occurs in the antecedent, and therefore it can assume that the antecedent's <xref:System.Threading.Tasks.Task.Exception%2A> property is not `null`.</span></span> <span data-ttu-id="d6f0a-222">Se la continuazione viene eseguita sia se viene generata un'eccezione nell'attività precedente sia in caso contrario, deve verificare se la proprietà <xref:System.Threading.Tasks.Task.Exception%2A> dell'attività precedente è non `null` prima di tentare di gestire l'eccezione, come mostra il frammento di codice seguente.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-222">If the continuation executes whether or not an exception is thrown in the antecedent, it would have to check whether the antecedent's <xref:System.Threading.Tasks.Task.Exception%2A> property is not `null` before attempting to handle the exception, as the following code fragment shows.</span></span>  
  
     [!code-csharp[TPL_Continuations#11](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_continuations/cs/exception2.cs#11)]
     [!code-vb[TPL_Continuations#11](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/exception2.vb#11)]  
  
     <span data-ttu-id="d6f0a-223">Per altre informazioni, vedere [Gestione delle eccezioni](exception-handling-task-parallel-library.md).</span><span class="sxs-lookup"><span data-stu-id="d6f0a-223">For more information, see [Exception Handling](exception-handling-task-parallel-library.md).</span></span>  
  
- <span data-ttu-id="d6f0a-224">Se la continuazione è un'attività figlio collegata creata usando l'opzione <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType> , le eccezioni verranno propagate dall'attività padre di nuovo al thread di chiamata, come nel caso di qualsiasi altra attività figlio collegata.</span><span class="sxs-lookup"><span data-stu-id="d6f0a-224">If the continuation is an attached child task that was created by using the <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType> option, its exceptions will be propagated by the parent back to the calling thread, as is the case in any other attached child.</span></span> <span data-ttu-id="d6f0a-225">Per altre informazioni, vedere [Attività figlio connesse e disconnesse](attached-and-detached-child-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="d6f0a-225">For more information, see [Attached and Detached Child Tasks](attached-and-detached-child-tasks.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="d6f0a-226">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="d6f0a-226">See also</span></span>

- [<span data-ttu-id="d6f0a-227">Task Parallel Library (TPL)</span><span class="sxs-lookup"><span data-stu-id="d6f0a-227">Task Parallel Library (TPL)</span></span>](task-parallel-library-tpl.md)
