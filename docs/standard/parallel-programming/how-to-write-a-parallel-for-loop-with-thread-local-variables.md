---
title: 'Procedura: Scrivere un ciclo Parallel.For con variabili di thread locali'
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel for loops, how to use local state
ms.assetid: 68384064-7ee7-41e2-90e3-71f00bde01bb
ms.openlocfilehash: bb6ac1a64c3a71646946d1af894d1124b12e4769
ms.sourcegitcommit: 33deec3e814238fb18a49b2a7e89278e27888291
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/02/2020
ms.locfileid: "84290759"
---
# <a name="how-to-write-a-parallelfor-loop-with-thread-local-variables"></a><span data-ttu-id="04c8f-102">Procedura: Scrivere un ciclo Parallel.For con variabili di thread locali</span><span class="sxs-lookup"><span data-stu-id="04c8f-102">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>
<span data-ttu-id="04c8f-103">Questo esempio illustra come usare le variabili locali di thread per archiviare e recuperare lo stato in ogni attività separata creata da un ciclo <xref:System.Threading.Tasks.Parallel.For%2A>.</span><span class="sxs-lookup"><span data-stu-id="04c8f-103">This example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <xref:System.Threading.Tasks.Parallel.For%2A> loop.</span></span> <span data-ttu-id="04c8f-104">L'uso dei dati locali di thread permette di evitare il sovraccarico dovuto alla sincronizzazione di un numero elevato di accessi a uno stato condiviso.</span><span class="sxs-lookup"><span data-stu-id="04c8f-104">By using thread-local data, you can avoid the overhead of synchronizing a large number of accesses to shared state.</span></span> <span data-ttu-id="04c8f-105">Invece di scrivere in una risorsa condivisa a ogni iterazione, si calcola e si archivia il valore fino al completamento di tutte le iterazioni per l'attività.</span><span class="sxs-lookup"><span data-stu-id="04c8f-105">Instead of writing to a shared resource on each iteration, you compute and store the value until all iterations for the task are complete.</span></span> <span data-ttu-id="04c8f-106">È quindi possibile scrivere il risultato finale una volta sola nella risorsa condivisa oppure passarlo a un altro metodo.</span><span class="sxs-lookup"><span data-stu-id="04c8f-106">You can then write the final result once to the shared resource, or pass it to another method.</span></span>  
  
## <a name="example"></a><span data-ttu-id="04c8f-107">Esempio</span><span class="sxs-lookup"><span data-stu-id="04c8f-107">Example</span></span>  
 <span data-ttu-id="04c8f-108">L'esempio seguente chiama il metodo <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> per calcolare la somma dei valori in una matrice contenente un milione di elementi.</span><span class="sxs-lookup"><span data-stu-id="04c8f-108">The following example calls the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method to calculate the sum of the values in an array that contains one million elements.</span></span> <span data-ttu-id="04c8f-109">Il valore di ogni elemento è uguale all'indice corrispondente.</span><span class="sxs-lookup"><span data-stu-id="04c8f-109">The value of each element is equal to its index.</span></span>  
  
 [!code-csharp[TPL_Parallel#05](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/forandforeach_simple.cs#05)]
 [!code-vb[TPL_Parallel#05](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/forwiththreadlocal.vb#05)]  
  
 <span data-ttu-id="04c8f-110">I primi due parametri di ogni metodo <xref:System.Threading.Tasks.Parallel.For%2A> specificano i valori di iterazione iniziali e finali.</span><span class="sxs-lookup"><span data-stu-id="04c8f-110">The first two parameters of every <xref:System.Threading.Tasks.Parallel.For%2A> method specify the beginning and ending iteration values.</span></span> <span data-ttu-id="04c8f-111">In questo overload del metodo, il terzo parametro corrisponde alla posizione di inizializzazione dello stato locale.</span><span class="sxs-lookup"><span data-stu-id="04c8f-111">In this overload of the method, the third parameter is where you initialize your local state.</span></span> <span data-ttu-id="04c8f-112">In questo contesto lo stato locale indica una variabile la cui durata si estende da immediatamente prima della prima iterazione del ciclo nel thread corrente a immediatamente dopo l'ultima iterazione.</span><span class="sxs-lookup"><span data-stu-id="04c8f-112">In this context, local state means a variable whose lifetime extends from just before the first iteration of the loop on the current thread, to just after the last iteration.</span></span>  
  
 <span data-ttu-id="04c8f-113">Il tipo del terzo parametro è <xref:System.Func%601>, dove `TResult` indica il tipo della variabile in cui sarà archiviato lo stato locale di thread.</span><span class="sxs-lookup"><span data-stu-id="04c8f-113">The type of the third parameter is a <xref:System.Func%601> where `TResult` is the type of the variable that will store the thread-local state.</span></span> <span data-ttu-id="04c8f-114">Il tipo corrispondente è definito dall'argomento tipo generico fornito quando si chiama il metodo <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> generico, che in questo caso è <xref:System.Int64>.</span><span class="sxs-lookup"><span data-stu-id="04c8f-114">Its type is defined by the generic type argument supplied when calling the generic <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method, which in this case is <xref:System.Int64>.</span></span> <span data-ttu-id="04c8f-115">L'argomento tipo indica al compilatore il tipo di variabile temporanea che sarà usata per l'archiviazione dello stato locale di thread.</span><span class="sxs-lookup"><span data-stu-id="04c8f-115">The type argument tells the compiler the type of the temporary variable that will be used to store the thread-local state.</span></span> <span data-ttu-id="04c8f-116">In questo esempio l'espressione `() => 0` (o `Function() 0` in Visual Basic) inizializza la variabile locale di thread su zero.</span><span class="sxs-lookup"><span data-stu-id="04c8f-116">In this example, the expression `() => 0` (or `Function() 0` in Visual Basic) initializes the thread-local variable to zero.</span></span> <span data-ttu-id="04c8f-117">Se un argomento tipo generico è un tipo di riferimento o un tipo di valore definito dall'utente, l'espressione avrà un aspetto analogo al seguente:</span><span class="sxs-lookup"><span data-stu-id="04c8f-117">If the generic type argument is a reference type or user-defined value type, the expression would look like this:</span></span>  
  
```csharp  
() => new MyClass()  
```  
  
```vb  
Function() new MyClass()  
```  
  
 <span data-ttu-id="04c8f-118">Il quarto parametro definisce la logica del ciclo.</span><span class="sxs-lookup"><span data-stu-id="04c8f-118">The fourth parameter defines the loop logic.</span></span> <span data-ttu-id="04c8f-119">Deve essere un delegato o un'espressione lambda con firma `Func<int, ParallelLoopState, long, long>` in C# o `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="04c8f-119">It must be a delegate or lambda expression whose signature is `Func<int, ParallelLoopState, long, long>` in C# or `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic.</span></span> <span data-ttu-id="04c8f-120">Il primo parametro è il valore del contatore di cicli per quell'iterazione del ciclo.</span><span class="sxs-lookup"><span data-stu-id="04c8f-120">The first parameter is the value of the loop counter for that iteration of the loop.</span></span> <span data-ttu-id="04c8f-121">Il secondo è un oggetto <xref:System.Threading.Tasks.ParallelLoopState> che può essere usato per uscire dal ciclo. L'oggetto è fornito dalla classe <xref:System.Threading.Tasks.Parallel> a ogni occorrenza del ciclo.</span><span class="sxs-lookup"><span data-stu-id="04c8f-121">The second is a <xref:System.Threading.Tasks.ParallelLoopState> object that can be used to break out of the loop; this object is provided by the <xref:System.Threading.Tasks.Parallel> class to each occurrence of the loop.</span></span> <span data-ttu-id="04c8f-122">Il terzo parametro è la variabile locale di thread.</span><span class="sxs-lookup"><span data-stu-id="04c8f-122">The third parameter is the thread-local variable.</span></span> <span data-ttu-id="04c8f-123">L'ultimo parametro è il tipo restituito.</span><span class="sxs-lookup"><span data-stu-id="04c8f-123">The last parameter is the return type.</span></span> <span data-ttu-id="04c8f-124">In questo caso il tipo è <xref:System.Int64>, poiché questo è il tipo specificato nell'argomento tipo <xref:System.Threading.Tasks.Parallel.For%2A>.</span><span class="sxs-lookup"><span data-stu-id="04c8f-124">In this case, the type is <xref:System.Int64> because that is the type we specified in the <xref:System.Threading.Tasks.Parallel.For%2A> type argument.</span></span> <span data-ttu-id="04c8f-125">Questa variabile è denominata `subtotal` ed è restituita dall'espressione lambda.</span><span class="sxs-lookup"><span data-stu-id="04c8f-125">That variable is named `subtotal` and is returned by the lambda expression.</span></span> <span data-ttu-id="04c8f-126">Il valore restituito è usato per inizializzare `subtotal` in ogni iterazione successiva del ciclo.</span><span class="sxs-lookup"><span data-stu-id="04c8f-126">The return value is used to initialize `subtotal` on each subsequent iteration of the loop.</span></span> <span data-ttu-id="04c8f-127">È anche possibile considerare quest'ultimo parametro come un valore passato a ogni iterazione e quindi passato al delegato `localFinally` al completamento dell'ultima iterazione.</span><span class="sxs-lookup"><span data-stu-id="04c8f-127">You can also think of this last parameter as a value that is passed to each iteration, and then passed to the `localFinally` delegate when the last iteration is complete.</span></span>  
  
 <span data-ttu-id="04c8f-128">Il quinto parametro definisce il metodo chiamato una volta, dopo il completamento di tutte le iterazioni in un determinato thread.</span><span class="sxs-lookup"><span data-stu-id="04c8f-128">The fifth parameter defines the method that is called once, after all the iterations on a particular thread have completed.</span></span> <span data-ttu-id="04c8f-129">Il tipo di argomento di input corrisponde di nuovo all'argomento di tipo del metodo <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> e al tipo restituito dall'espressione lambda del corpo.</span><span class="sxs-lookup"><span data-stu-id="04c8f-129">The type of the input argument again corresponds to the type argument of the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method and the type returned by the body lambda expression.</span></span> <span data-ttu-id="04c8f-130">In questo esempio il valore è aggiunto a una variabile nell'ambito delle classi in un modo thread-safe chiamando il metodo <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="04c8f-130">In this example, the value is added to a variable at class scope in a thread safe way by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="04c8f-131">L'uso di una variabile locale di thread permette di evitare di scrivere nella variabile della classe a ogni iterazione del ciclo.</span><span class="sxs-lookup"><span data-stu-id="04c8f-131">By using a thread-local variable, we have avoided writing to this class variable on every iteration of the loop.</span></span>  
  
 <span data-ttu-id="04c8f-132">Per altre informazioni su come usare le espressioni lambda, vedere [Espressioni lambda in PLINQ e TPL](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="04c8f-132">For more information about how to use lambda expressions, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="04c8f-133">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="04c8f-133">See also</span></span>

- [<span data-ttu-id="04c8f-134">Parallelismo dei dati</span><span class="sxs-lookup"><span data-stu-id="04c8f-134">Data Parallelism</span></span>](data-parallelism-task-parallel-library.md)
- [<span data-ttu-id="04c8f-135">Programmazione parallela</span><span class="sxs-lookup"><span data-stu-id="04c8f-135">Parallel Programming</span></span>](index.md)
- [<span data-ttu-id="04c8f-136">Task Parallel Library (TPL)</span><span class="sxs-lookup"><span data-stu-id="04c8f-136">Task Parallel Library (TPL)</span></span>](task-parallel-library-tpl.md)
- [<span data-ttu-id="04c8f-137">Espressioni lambda in PLINQ e TPL</span><span class="sxs-lookup"><span data-stu-id="04c8f-137">Lambda Expressions in PLINQ and TPL</span></span>](lambda-expressions-in-plinq-and-tpl.md)
