---
title: 'Procedura: Scrivere un ciclo Parallel.For semplice'
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- Parallel.For, How to Write
- for loop, parallel construction in .NET
- parallel for loops, how to use
ms.assetid: 9029ba7f-a9d1-4526-8c84-c88716dba5d4
ms.openlocfilehash: b18e110b86389dd5d28bbc370e207aaaf7571aaf
ms.sourcegitcommit: 33deec3e814238fb18a49b2a7e89278e27888291
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/02/2020
ms.locfileid: "84290733"
---
# <a name="how-to-write-a-simple-parallelfor-loop"></a><span data-ttu-id="419b0-102">Procedura: Scrivere un ciclo Parallel.For semplice</span><span class="sxs-lookup"><span data-stu-id="419b0-102">How to: Write a Simple Parallel.For Loop</span></span>

<span data-ttu-id="419b0-103">Questo argomento contiene due esempi che mostrano il metodo <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="419b0-103">This topic contains two examples that illustrate the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="419b0-104">Il primo usa l'overload del metodo <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType>, mentre il secondo usa l'overload <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType>, ovvero i due overload più semplici del metodo <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="419b0-104">The first uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType> method overload, and the second uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType> overload, the two simplest overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="419b0-105">È possibile usare questi due overload del metodo <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> quando non è necessario annullare il ciclo, interrompere le iterazioni del ciclo o mantenere qualsiasi stato locale dei thread.</span><span class="sxs-lookup"><span data-stu-id="419b0-105">You can use these two overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method when you do not need to cancel the loop, break out of the loop iterations, or maintain any thread-local state.</span></span>

> [!NOTE]
> <span data-ttu-id="419b0-106">Questa documentazione usa espressioni lambda per definire delegati in TPL.</span><span class="sxs-lookup"><span data-stu-id="419b0-106">This documentation uses lambda expressions to define delegates in TPL.</span></span> <span data-ttu-id="419b0-107">Se non si ha familiarità con le espressioni lambda in C# o Visual Basic, vedere [espressioni lambda in PLINQ e TPL](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="419b0-107">If you are not familiar with lambda expressions in C# or Visual Basic, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>

<span data-ttu-id="419b0-108">Il primo esempio calcola le dimensioni dei file in una singola directory.</span><span class="sxs-lookup"><span data-stu-id="419b0-108">The first example calculates the size of files in a single directory.</span></span> <span data-ttu-id="419b0-109">Il secondo calcola il prodotto di due matrici.</span><span class="sxs-lookup"><span data-stu-id="419b0-109">The second computes the product of two matrices.</span></span>

## <a name="directory-size-example"></a><span data-ttu-id="419b0-110">Esempio relativo alle dimensioni di una directory</span><span class="sxs-lookup"><span data-stu-id="419b0-110">Directory size example</span></span>

<span data-ttu-id="419b0-111">Questo esempio è una semplice utilità da riga di comando che calcola le dimensioni totali dei file in una directory.</span><span class="sxs-lookup"><span data-stu-id="419b0-111">This example is a simple command-line utility that calculates the total size of files in a directory.</span></span> <span data-ttu-id="419b0-112">È previsto un singolo percorso di directory come argomento e l'esempio indica il numero e le dimensioni totali dei file presenti nella directory.</span><span class="sxs-lookup"><span data-stu-id="419b0-112">It expects a single directory path as an argument, and reports the number and total size of the files in that directory.</span></span> <span data-ttu-id="419b0-113">Dopo aver verificato l'esistenza della directory, l'esempio usa il metodo <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> per enumerare i file nella directory e determinarne le dimensioni.</span><span class="sxs-lookup"><span data-stu-id="419b0-113">After verifying that the directory exists, it uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to enumerate the files in the directory and determine their file sizes.</span></span> <span data-ttu-id="419b0-114">Le dimensioni di ogni file vengono quindi aggiunte alla variabile `totalSize`.</span><span class="sxs-lookup"><span data-stu-id="419b0-114">Each file size is then added to the `totalSize` variable.</span></span> <span data-ttu-id="419b0-115">Tenere presente che l'aggiunta viene eseguita chiamando il metodo <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType>, in modo che sia un'operazione atomica.</span><span class="sxs-lookup"><span data-stu-id="419b0-115">Note that the addition is performed by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> so that the addition is performed as an atomic operation.</span></span> <span data-ttu-id="419b0-116">In caso contrario, più attività potrebbero tentare di aggiornare la variabile `totalSize` contemporaneamente.</span><span class="sxs-lookup"><span data-stu-id="419b0-116">Otherwise, multiple tasks could try to update the `totalSize` variable simultaneously.</span></span>

[!code-csharp[Conceptual.Parallel.For#1](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.parallel.for/cs/for1.cs#1)]
[!code-vb[Conceptual.Parallel.For#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.parallel.for/vb/for1.vb#1)]

## <a name="matrix-and-stopwatch-example"></a><span data-ttu-id="419b0-117">Esempio relativo alle matrici e a Stopwatch</span><span class="sxs-lookup"><span data-stu-id="419b0-117">Matrix and stopwatch example</span></span>

<span data-ttu-id="419b0-118">Questo esempio usa il metodo <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> per calcolare il prodotto di due matrici.</span><span class="sxs-lookup"><span data-stu-id="419b0-118">This example uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to compute the product of two matrices.</span></span> <span data-ttu-id="419b0-119">L'esempio mostra anche come usare la classe <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType> per confrontare le prestazioni di un ciclo parallelo con uno non parallelo.</span><span class="sxs-lookup"><span data-stu-id="419b0-119">It also shows how to use the <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType> class to compare the performance of a parallel loop with a non-parallel loop.</span></span> <span data-ttu-id="419b0-120">Poiché può generare un volume elevato di output, l'esempio permette il reindirizzamento dell'output a un file.</span><span class="sxs-lookup"><span data-stu-id="419b0-120">Note that, because it can generate a large volume of output, the example allows output to be redirected to a file.</span></span>

[!code-csharp[TPL_Parallel#01](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/simpleparallelfor.cs#01)]
[!code-vb[TPL_Parallel#01](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/simpleparallelfor.vb#01)]

<span data-ttu-id="419b0-121">Quando si parallelizza qualsiasi codice, inclusi i cicli, un obiettivo importante consiste nell'utilizzare i processori quanto più possibile senza eseguire una parallelizzazione eccessiva che faccia sì che l'overhead per l'elaborazione parallela vanifichi qualsiasi vantaggio in termini di prestazioni.</span><span class="sxs-lookup"><span data-stu-id="419b0-121">When parallelizing any code, including loops, one important goal is to utilize the processors as much as possible without over parallelizing to the point where the overhead for parallel processing negates any performance benefits.</span></span> <span data-ttu-id="419b0-122">In questo esempio specifico viene parallelizzato solo il ciclo esterno, perché nel ciclo interno non vengono eseguite molte attività.</span><span class="sxs-lookup"><span data-stu-id="419b0-122">In this particular example, only the outer loop is parallelized because there is not very much work performed in the inner loop.</span></span> <span data-ttu-id="419b0-123">La combinazione di una quantità ridotta di attività e di effetti della cache indesiderati può provocare un peggioramento delle prestazioni nei cicli paralleli annidati.</span><span class="sxs-lookup"><span data-stu-id="419b0-123">The combination of a small amount of work and undesirable cache effects can result in performance degradation in nested parallel loops.</span></span> <span data-ttu-id="419b0-124">Di conseguenza, la parallelizzazione del solo ciclo esterno è il modo migliore per ottimizzare i vantaggi della concorrenza sulla maggior parte dei sistemi.</span><span class="sxs-lookup"><span data-stu-id="419b0-124">Therefore, parallelizing the outer loop only is the best way to maximize the benefits of concurrency on most systems.</span></span>

## <a name="the-delegate"></a><span data-ttu-id="419b0-125">Delegato</span><span class="sxs-lookup"><span data-stu-id="419b0-125">The Delegate</span></span>

<span data-ttu-id="419b0-126">Il terzo parametro di questo overload di <xref:System.Threading.Tasks.Parallel.For%2A> è un delegato di tipo `Action<int>` in C# o `Action(Of Integer)` in Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="419b0-126">The third parameter of this overload of <xref:System.Threading.Tasks.Parallel.For%2A> is a delegate of type `Action<int>` in C# or `Action(Of Integer)` in Visual Basic.</span></span> <span data-ttu-id="419b0-127">Un delegato `Action`, che abbia nessuno, uno o sedici parametri di tipo, restituisce sempre void.</span><span class="sxs-lookup"><span data-stu-id="419b0-127">An `Action` delegate, whether it has zero, one or sixteen type parameters, always returns void.</span></span> <span data-ttu-id="419b0-128">In Visual Basic il comportamento di un delegato `Action` viene definito con un oggetto `Sub`.</span><span class="sxs-lookup"><span data-stu-id="419b0-128">In Visual Basic, the behavior of an `Action` is defined with a `Sub`.</span></span> <span data-ttu-id="419b0-129">L'esempio usa un'espressione lambda per creare il delegato, ma è possibile creare il delegato anche in altri modi.</span><span class="sxs-lookup"><span data-stu-id="419b0-129">The example uses a lambda expression to create the delegate, but you can create the delegate in other ways as well.</span></span> <span data-ttu-id="419b0-130">Per altre informazioni, vedere [Espressioni lambda in PLINQ e TPL](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="419b0-130">For more information, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>

## <a name="the-iteration-value"></a><span data-ttu-id="419b0-131">Valore di iterazione</span><span class="sxs-lookup"><span data-stu-id="419b0-131">The Iteration Value</span></span>

<span data-ttu-id="419b0-132">Il delegato accetta un singolo parametro di input il cui valore è l'iterazione corrente.</span><span class="sxs-lookup"><span data-stu-id="419b0-132">The delegate takes a single input parameter whose value is the current iteration.</span></span> <span data-ttu-id="419b0-133">Questo valore di iterazione viene fornito dal runtime e il suo valore iniziale è l'indice del primo elemento nel segmento (partizione) dell'origine elaborata nel thread corrente.</span><span class="sxs-lookup"><span data-stu-id="419b0-133">This iteration value is supplied by the runtime and its starting value is the index of the first element on the segment (partition) of the source that is being processed on the current thread.</span></span>

<span data-ttu-id="419b0-134">Se si vuole esercitare maggiore controllo sul livello di concorrenza, usare uno degli overload che accetta un parametro di input <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType>, come <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="419b0-134">If you require more control over the concurrency level, use one of the overloads that takes a <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType> input parameter, such as: <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span></span>

## <a name="return-value-and-exception-handling"></a><span data-ttu-id="419b0-135">Valore restituito e gestione delle eccezioni</span><span class="sxs-lookup"><span data-stu-id="419b0-135">Return Value and Exception Handling</span></span>

<span data-ttu-id="419b0-136"><xref:System.Threading.Tasks.Parallel.For%2A> restituisce un oggetto <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType> al completamento di tutti i thread.</span><span class="sxs-lookup"><span data-stu-id="419b0-136"><xref:System.Threading.Tasks.Parallel.For%2A> returns a <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType> object when all threads have completed.</span></span> <span data-ttu-id="419b0-137">Questo valore restituito è utile quando si arresta o si interrompe l'iterazione del ciclo manualmente, perché l'oggetto <xref:System.Threading.Tasks.ParallelLoopResult> archivia informazioni come l'ultima iterazione eseguita fino al completamento.</span><span class="sxs-lookup"><span data-stu-id="419b0-137">This return value is useful when you are stopping or breaking loop iteration manually, because the <xref:System.Threading.Tasks.ParallelLoopResult> stores information such as the last iteration that ran to completion.</span></span> <span data-ttu-id="419b0-138">Se si verificano una o più eccezioni in uno dei thread, verrà generato un oggetto <xref:System.AggregateException?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="419b0-138">If one or more exceptions occur on one of the threads, a <xref:System.AggregateException?displayProperty=nameWithType> will be thrown.</span></span>

<span data-ttu-id="419b0-139">Nel codice di questo esempio il valore restituito di <xref:System.Threading.Tasks.Parallel.For%2A> non viene usato.</span><span class="sxs-lookup"><span data-stu-id="419b0-139">In the code in this example, the return value of <xref:System.Threading.Tasks.Parallel.For%2A> is not used.</span></span>

## <a name="analysis-and-performance"></a><span data-ttu-id="419b0-140">Analisi e prestazioni</span><span class="sxs-lookup"><span data-stu-id="419b0-140">Analysis and Performance</span></span>

<span data-ttu-id="419b0-141">È possibile usare la Creazione guidata sessione di prestazioni per visualizzare l'utilizzo CPU nel computer.</span><span class="sxs-lookup"><span data-stu-id="419b0-141">You can use the Performance Wizard to view CPU usage on your computer.</span></span> <span data-ttu-id="419b0-142">Come esperimento, aumentare il numero di colonne e righe nelle matrici.</span><span class="sxs-lookup"><span data-stu-id="419b0-142">As an experiment, increase the number of columns and rows in the matrices.</span></span> <span data-ttu-id="419b0-143">Più grandi sono le matrici, maggiore sarà la differenza in termini di prestazioni tra le versioni parallela e sequenziale del calcolo.</span><span class="sxs-lookup"><span data-stu-id="419b0-143">The larger the matrices, the greater the performance difference between the parallel and sequential versions of the computation.</span></span> <span data-ttu-id="419b0-144">Quando la matrice è di dimensioni ridotte, la versione sequenziale verrà eseguita più rapidamente a causa dell'overhead durante la configurazione del ciclo parallelo.</span><span class="sxs-lookup"><span data-stu-id="419b0-144">When the matrix is small, the sequential version will run faster because of the overhead in setting up the parallel loop.</span></span>

<span data-ttu-id="419b0-145">Le chiamate sincrone a risorse condivise, come la console o il file system, riducono significativamente le prestazioni di un ciclo parallelo.</span><span class="sxs-lookup"><span data-stu-id="419b0-145">Synchronous calls to shared resources, like the Console or the File System, will significantly degrade the performance of a parallel loop.</span></span> <span data-ttu-id="419b0-146">Per la misurazione delle prestazioni, provare a evitare chiamate come <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> all'interno del ciclo.</span><span class="sxs-lookup"><span data-stu-id="419b0-146">When measuring performance, try to avoid calls such as <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> within the loop.</span></span>

## <a name="compile-the-code"></a><span data-ttu-id="419b0-147">Compilare il codice</span><span class="sxs-lookup"><span data-stu-id="419b0-147">Compile the Code</span></span>

<span data-ttu-id="419b0-148">Copiare e incollare questo codice in un progetto di Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="419b0-148">Copy and paste this code into a Visual Studio project.</span></span>

## <a name="see-also"></a><span data-ttu-id="419b0-149">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="419b0-149">See also</span></span>

- <xref:System.Threading.Tasks.Parallel.For%2A>
- <xref:System.Threading.Tasks.Parallel.ForEach%2A>
- [<span data-ttu-id="419b0-150">Parallelismo dei dati</span><span class="sxs-lookup"><span data-stu-id="419b0-150">Data Parallelism</span></span>](data-parallelism-task-parallel-library.md)
- [<span data-ttu-id="419b0-151">Programmazione parallela</span><span class="sxs-lookup"><span data-stu-id="419b0-151">Parallel Programming</span></span>](index.md)
