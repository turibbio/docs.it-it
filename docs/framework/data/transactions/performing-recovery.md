---
title: Esecuzione del ripristino
description: Eseguire il ripristino in .NET. Resource Manager consente di risolvere gli elenchi durevoli delle transazioni riintegrando il partecipante alla transazione dopo un errore di risorsa.
ms.date: 03/30/2017
ms.assetid: 6dd17bf6-ba42-460a-a44b-8046f52b10d0
ms.openlocfilehash: bb00d2f574cc2651b733f3308cf2ffc6b430cc31
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141965"
---
# <a name="performing-recovery"></a><span data-ttu-id="654e8-104">Esecuzione del ripristino</span><span class="sxs-lookup"><span data-stu-id="654e8-104">Performing Recovery</span></span>
<span data-ttu-id="654e8-105">In caso di errore delle risorse, la gestione risorse consente di ripristinare le integrazioni durevoli di una transazione mediante la reintegrazione dei partecipanti della transazione.</span><span class="sxs-lookup"><span data-stu-id="654e8-105">A resource manager facilitates resolution of durable enlistments in a transaction by reenlisting the transaction participant after resource failure.</span></span>  
  
## <a name="the-recovery-process"></a><span data-ttu-id="654e8-106">Descrizione del processo di ripristino</span><span class="sxs-lookup"><span data-stu-id="654e8-106">The Recovery Process</span></span>  
 <span data-ttu-id="654e8-107">Per eseguire l'integrazione durevole di una risorsa (definita da un'implementazione dell'interfaccia <xref:System.Transactions.IEnlistmentNotification>) che in seguito può essere ripristinata, è necessario chiamare il metodo <xref:System.Transactions.Transaction.EnlistDurable%2A>.</span><span class="sxs-lookup"><span data-stu-id="654e8-107">To durably enlist a resource (described by an implementation of the <xref:System.Transactions.IEnlistmentNotification> interface) that can later be eligible for recovery, you should call the <xref:System.Transactions.Transaction.EnlistDurable%2A> method.</span></span> <span data-ttu-id="654e8-108">È inoltre necessario fornire al metodo <xref:System.Transactions.Transaction.EnlistDurable%2A> un identificatore del gestore di risorse (ovvero un oggetto <xref:System.Guid>), che viene utilizzato per identificare in modo coerente il partecipante della transazione in caso di errore delle risorse.</span><span class="sxs-lookup"><span data-stu-id="654e8-108">In addition, you must provide the <xref:System.Transactions.Transaction.EnlistDurable%2A> method with a resource manager identifier (a <xref:System.Guid>) that is used to consistently label the participant of the transaction in the event of a resource failure.</span></span> <span data-ttu-id="654e8-109">Per questo motivo, la proprietà <xref:System.Guid> fornita alla chiamata di integrazione iniziale deve essere identica al parametro *resourceManagerIdentifier* nella <xref:System.Transactions.TransactionManager.Reenlist%2A> chiamata durante il ripristino.</span><span class="sxs-lookup"><span data-stu-id="654e8-109">For this reason, the <xref:System.Guid> that is provided to the initial Enlist call should be identical to the *resourceManagerIdentifier* parameter in the <xref:System.Transactions.TransactionManager.Reenlist%2A> call during recovery.</span></span> <span data-ttu-id="654e8-110">In caso contrario, viene generata un'eccezione <xref:System.Transactions.TransactionException>.</span><span class="sxs-lookup"><span data-stu-id="654e8-110">Otherwise, <xref:System.Transactions.TransactionException> is thrown.</span></span> <span data-ttu-id="654e8-111">Per ulteriori informazioni sulle integrazioni durevoli, vedere [integrazione di risorse come partecipanti in una transazione](enlisting-resources-as-participants-in-a-transaction.md) .</span><span class="sxs-lookup"><span data-stu-id="654e8-111">For more information on durable enlistments, see [Enlisting Resources as Participants in a Transaction](enlisting-resources-as-participants-in-a-transaction.md) .</span></span>  
  
 <span data-ttu-id="654e8-112">Nella fase di preparazione (fase 1) del protocollo 2PC, l'implementazione del gestore di risorse durevole deve registrare il proprio record di preparazione non appena riceve la notifica di preparazione tramite il metodo <xref:System.Transactions.IEnlistmentNotification.Prepare%2A>.</span><span class="sxs-lookup"><span data-stu-id="654e8-112">In the prepare phase (phase 1) of the 2PC protocol, when your implementation of a durable resource manager receives the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification, it should log its prepare record during this phase.</span></span> <span data-ttu-id="654e8-113">Il record deve contenere tutte le informazioni necessarie a completare la transazione in caso di commit.</span><span class="sxs-lookup"><span data-stu-id="654e8-113">The record should contain all the information that is necessary to complete the transaction on commit.</span></span> <span data-ttu-id="654e8-114">Il record di preparazione può essere eseguito in un secondo momento durante il ripristino recuperando la <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> proprietà del callback *preparingEnlistment* .</span><span class="sxs-lookup"><span data-stu-id="654e8-114">The prepare record can later be accessed during recovery by retrieving the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the *preparingEnlistment* callback.</span></span> <span data-ttu-id="654e8-115">Non è necessario eseguire la registrazione del record all'interno del metodo <xref:System.Transactions.IEnlistmentNotification.Prepare%2A>, in quanto il gestore di risorse può eseguire questa operazione in un thread di lavoro.</span><span class="sxs-lookup"><span data-stu-id="654e8-115">The record logging does not need to be performed within the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> method as the RM can do this on a worker thread.</span></span>  
  
 <span data-ttu-id="654e8-116">Il processo di ripristino è costituito dai due passaggi seguenti:</span><span class="sxs-lookup"><span data-stu-id="654e8-116">The recovery process consists of the following two steps:</span></span>  
  
### <a name="step-1---reenlist"></a><span data-ttu-id="654e8-117">Passaggio 1: reintegrazione</span><span class="sxs-lookup"><span data-stu-id="654e8-117">Step 1 - ReEnlist</span></span>  
 <span data-ttu-id="654e8-118">Il gestore di risorse esamina le informazioni contenute nel record di preparazione di ogni integrazione incerta, ovvero nello stato InDoubt.</span><span class="sxs-lookup"><span data-stu-id="654e8-118">The resource manager examines the prepare information record for each enlistment that is in-doubt.</span></span> <span data-ttu-id="654e8-119">A tale scopo, esamina la proprietà <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> del callback <xref:System.Transactions.PreparingEnlistment> passata durante la fase 1 al gestore di risorse nella notifica basata sul metodo <xref:System.Transactions.IEnlistmentNotification.Prepare%2A>.</span><span class="sxs-lookup"><span data-stu-id="654e8-119">This is done by examining the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the <xref:System.Transactions.PreparingEnlistment> callback, which is passed to the resource manager in the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification during phase 1.</span></span>  
  
 <span data-ttu-id="654e8-120">Per ogni integrazione di questo tipo, il gestore di risorse richiama il metodo <xref:System.Transactions.TransactionManager.Reenlist%2A> sulla gestione transazioni.</span><span class="sxs-lookup"><span data-stu-id="654e8-120">For each such enlistment it examines, it invokes <xref:System.Transactions.TransactionManager.Reenlist%2A> on the transaction manager.</span></span> <span data-ttu-id="654e8-121">Questo metodo passa una matrice di byte contenente l'identificatore univoco <xref:System.Guid> del gestore di risorse nonché le informazioni relative all'integrazione.</span><span class="sxs-lookup"><span data-stu-id="654e8-121">This method passes on a unique <xref:System.Guid> that identifies the resource manager, as well as the enlistment's information in a byte array.</span></span> <span data-ttu-id="654e8-122">Viene quindi restituito un nuovo oggetto <xref:System.Transactions.Enlistment>.</span><span class="sxs-lookup"><span data-stu-id="654e8-122">A new <xref:System.Transactions.Enlistment> object is returned.</span></span> <span data-ttu-id="654e8-123">Se la reintegrazione non riesce e viene generata un'eccezione, il gestore di risorse deve provare in seguito a eseguire nuovamente questo passaggio.</span><span class="sxs-lookup"><span data-stu-id="654e8-123">If the reenlistment fails with an exception, the resource manager will need to retry at a later time.</span></span>  
  
 <span data-ttu-id="654e8-124">Il metodo <xref:System.Transactions.TransactionManager.Reenlist%2A> deve essere chiamato soltanto quando un gestore delle risorse viene riavviato dopo un errore.</span><span class="sxs-lookup"><span data-stu-id="654e8-124">You should only call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method when a resource manager restarts from failure.</span></span> <span data-ttu-id="654e8-125">Inoltre, la reintegrazione deve riguardare esclusivamente le transazioni non ripristinate registrate da un gestore di risorse durante la fase iniziale di preparazione di un commit a due fasi.</span><span class="sxs-lookup"><span data-stu-id="654e8-125">In addition, you should only reenlist unresolved transactions logged by a resource manager during the initial Prepare phase of a two-phase commit.</span></span> <span data-ttu-id="654e8-126">Qualsiasi tentativo di chiamata a questo metodo in casi non validi può produrre risultati imprevisti.</span><span class="sxs-lookup"><span data-stu-id="654e8-126">Any attempt to call this method at invalid times can produce erroneous results.</span></span>  
  
 <span data-ttu-id="654e8-127">Dopo aver utilizzato questo metodo per reintegrare un partecipante, il sistema chiama il metodo della fase 2 dell'interfaccia <xref:System.Transactions.IEnlistmentNotification> corrispondente al risultato della transazione (ovvero <xref:System.Transactions.IEnlistmentNotification.Commit%2A>, <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> o <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A>).</span><span class="sxs-lookup"><span data-stu-id="654e8-127">When a participant is reenlisted using this method, the phase 2 methods of <xref:System.Transactions.IEnlistmentNotification> that correspond to the transaction's outcome (that is, <xref:System.Transactions.IEnlistmentNotification.Commit%2A> , <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> or <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A> ) are called as appropriate.</span></span>  
  
### <a name="step-2---completing-the-recovery"></a><span data-ttu-id="654e8-128">Passaggio 2: completamento del ripristino</span><span class="sxs-lookup"><span data-stu-id="654e8-128">Step 2 - Completing the recovery</span></span>  
 <span data-ttu-id="654e8-129">Al termine di tutte le reintegrazioni, il gestore di risorse chiama il metodo <xref:System.Transactions.TransactionManager.RecoveryComplete%2A>.</span><span class="sxs-lookup"><span data-stu-id="654e8-129">When all the reenlistments are finished, the resource manager calls the <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> method.</span></span> <span data-ttu-id="654e8-130">Questo metodo consente di completare il ripristino e di comunicare alla gestione transazioni che il gestore di risorse non presenta più alcuna transazione incerta.</span><span class="sxs-lookup"><span data-stu-id="654e8-130">This method completes the recovery and informs the transaction manager that the resource manager has no more in-doubt transactions.</span></span> <span data-ttu-id="654e8-131">Ciò consente al gestore di risorse di garantire che non richiamerà più il metodo <xref:System.Transactions.TransactionManager.Reenlist%2A>.</span><span class="sxs-lookup"><span data-stu-id="654e8-131">By doing so, the resource manager guarantees that it will not invoke the <xref:System.Transactions.TransactionManager.Reenlist%2A> method again.</span></span>  
  
 <span data-ttu-id="654e8-132">Un gestore di risorse può integrarsi in altre transazioni anche se non ha ancora risolto tutte le transazioni incerte.</span><span class="sxs-lookup"><span data-stu-id="654e8-132">A resource manager is not required to resolve all in-doubt transactions before enlisting in new transactions.</span></span> <span data-ttu-id="654e8-133">Il primo passaggio può essere eseguito in qualsiasi momento dopo che Gestione risorse ha stabilito una relazione con la gestione transazioni, ma dopo che <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> è stato richiamato (passaggio 2); non è possibile eseguire di nuovo il passaggio 1.</span><span class="sxs-lookup"><span data-stu-id="654e8-133">The first step can be performed at any time after the resource manager establishes a relationship with the transaction manager, but after <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> has been invoked (step 2); step 1 cannot be performed again.</span></span> <span data-ttu-id="654e8-134">Il passaggio 2 può essere ripetuto più volte senza che ciò influisca sul risultato delle transazioni.</span><span class="sxs-lookup"><span data-stu-id="654e8-134">Step 2 can be repeated multiple times without affecting the outcome of transactions.</span></span>
