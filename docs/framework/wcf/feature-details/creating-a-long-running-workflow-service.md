---
title: Creazione di un servizio flusso di lavoro a esecuzione prolungata
ms.date: 03/30/2017
ms.assetid: 4c39bd04-5b8a-4562-a343-2c63c2821345
ms.openlocfilehash: 4ae01201230bf848c045158424db60097d8dd767
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/09/2020
ms.locfileid: "84599347"
---
# <a name="create-a-long-running-workflow-service"></a><span data-ttu-id="e02c5-102">Creazione di un servizio flusso di lavoro con esecuzione prolungata</span><span class="sxs-lookup"><span data-stu-id="e02c5-102">Create a Long-running Workflow Service</span></span>

<span data-ttu-id="e02c5-103">In questo argomento viene descritto come creare un servizio di flusso di lavoro a esecuzione prolungata.</span><span class="sxs-lookup"><span data-stu-id="e02c5-103">This topic describes how to create a long-running workflow service.</span></span> <span data-ttu-id="e02c5-104">L'esecuzione di tali servizi può durare molto tempo.</span><span class="sxs-lookup"><span data-stu-id="e02c5-104">Long running workflow services may run for long periods of time.</span></span> <span data-ttu-id="e02c5-105">A un certo punto, è possibile che il flusso di lavoro diventi inattivo a causa dell'attesa di informazioni aggiuntive.</span><span class="sxs-lookup"><span data-stu-id="e02c5-105">At some point the workflow may go idle waiting for some additional information.</span></span> <span data-ttu-id="e02c5-106">In tal caso, il flusso di lavoro viene salvato in modo permanente in un database SQL e rimosso dalla memoria.</span><span class="sxs-lookup"><span data-stu-id="e02c5-106">When this occurs the workflow is persisted to a SQL database and is removed from memory.</span></span> <span data-ttu-id="e02c5-107">Quando le informazioni aggiuntive diventano disponibili, l'istanza del flusso di lavoro viene caricata di nuovo in memoria e ne viene continuata l'esecuzione.</span><span class="sxs-lookup"><span data-stu-id="e02c5-107">When the additional information becomes available the workflow instance is loaded back into memory and continues executing.</span></span>  <span data-ttu-id="e02c5-108">In questo scenario viene implementato un sistema di ordini molto semplificato.</span><span class="sxs-lookup"><span data-stu-id="e02c5-108">In this scenario you are implementing a very simplified ordering system.</span></span>  <span data-ttu-id="e02c5-109">Per avviare la procedura di ordine, dal client viene inviato un messaggio iniziale al servizio di flusso di lavoro che, a sua volta,</span><span class="sxs-lookup"><span data-stu-id="e02c5-109">The client sends an initial message to the workflow service to start the order.</span></span> <span data-ttu-id="e02c5-110">consente la restituzione di un ID ordine al client.</span><span class="sxs-lookup"><span data-stu-id="e02c5-110">It returns an order ID to the client.</span></span> <span data-ttu-id="e02c5-111">A questo punto, a causa dell'attesa di un altro messaggio inviato dal client, il servizio di flusso di lavoro diventa inattivo e viene salvato in modo permanente in un database SQL Server.</span><span class="sxs-lookup"><span data-stu-id="e02c5-111">At this point the workflow service is waiting for another message from the client and goes into the idle state and is persisted to a SQL Server database.</span></span>  <span data-ttu-id="e02c5-112">Quando dal client viene inviato il messaggio successivo per ordinare un elemento, il servizio di flusso di lavoro viene caricato di nuovo in memoria consentendo il completamento dell'elaborazione dell'ordine.</span><span class="sxs-lookup"><span data-stu-id="e02c5-112">When the client sends the next message to order an item, the workflow service is loaded back into memory and finishes processing the order.</span></span> <span data-ttu-id="e02c5-113">Nell'esempio di codice viene restituita una stringa in cui viene indicato che l'elemento è stato aggiunto all'ordine.</span><span class="sxs-lookup"><span data-stu-id="e02c5-113">In the code sample it returns a string stating the item has been added to the order.</span></span> <span data-ttu-id="e02c5-114">L'esempio di codice non è stato ideato per corrispondere a un'applicazione reale della tecnologia, ma piuttosto per fornire un esempio semplice in cui vengono illustrati i servizi di flusso di lavoro a esecuzione prolungata.</span><span class="sxs-lookup"><span data-stu-id="e02c5-114">The code sample is not meant to be a real world application of the technology, but rather a simple sample that illustrates long running workflow services.</span></span> <span data-ttu-id="e02c5-115">In questo argomento si presuppone che si sappia come creare progetti e soluzioni di Visual Studio 2012.</span><span class="sxs-lookup"><span data-stu-id="e02c5-115">This topic assumes you know how to create Visual Studio 2012 projects and solutions.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="e02c5-116">Prerequisiti</span><span class="sxs-lookup"><span data-stu-id="e02c5-116">Prerequisites</span></span>

<span data-ttu-id="e02c5-117">Per utilizzare questa procedura dettagliata è necessario aver installato i software seguenti:</span><span class="sxs-lookup"><span data-stu-id="e02c5-117">You must have the following software installed to use this walkthrough:</span></span>

1. <span data-ttu-id="e02c5-118">Microsoft SQL Server 2008</span><span class="sxs-lookup"><span data-stu-id="e02c5-118">Microsoft SQL Server 2008</span></span>

2. <span data-ttu-id="e02c5-119">Visual Studio 2012</span><span class="sxs-lookup"><span data-stu-id="e02c5-119">Visual Studio 2012</span></span>

3. <span data-ttu-id="e02c5-120">Microsoft [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]</span><span class="sxs-lookup"><span data-stu-id="e02c5-120">Microsoft  [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]</span></span>

4. <span data-ttu-id="e02c5-121">Si ha familiarità con WCF e Visual Studio 2012 e si sa come creare progetti/soluzioni.</span><span class="sxs-lookup"><span data-stu-id="e02c5-121">You are familiar with WCF and Visual Studio 2012 and know how to create projects/solutions.</span></span>

## <a name="set-up-the-sql-database"></a><span data-ttu-id="e02c5-122">Configurare il database SQL</span><span class="sxs-lookup"><span data-stu-id="e02c5-122">Set up the SQL Database</span></span>

1. <span data-ttu-id="e02c5-123">Per salvare in modo permanente le istanze del servizio di flusso di lavoro è necessario disporre di Microsoft SQL Server e configurare un database per archiviare le istanze del flusso di lavoro salvate in modo permanente.</span><span class="sxs-lookup"><span data-stu-id="e02c5-123">In order for workflow service instances to be persisted you must have Microsoft SQL Server installed and you must configure a database to store the persisted workflow instances.</span></span> <span data-ttu-id="e02c5-124">Eseguire Microsoft SQL Management Studio facendo clic sul pulsante **Start** , selezionando **tutti i programmi**, **Microsoft SQL Server 2008**e **Microsoft SQL Management Studio**.</span><span class="sxs-lookup"><span data-stu-id="e02c5-124">Run Microsoft SQL Management Studio by clicking the **Start** button, selecting **All Programs**, **Microsoft SQL Server 2008**, and **Microsoft SQL Management Studio**.</span></span>

2. <span data-ttu-id="e02c5-125">Fare clic sul pulsante **Connetti** per accedere all'istanza di SQL Server</span><span class="sxs-lookup"><span data-stu-id="e02c5-125">Click the **Connect** button to log on to the SQL Server instance</span></span>

3. <span data-ttu-id="e02c5-126">Fare clic con il pulsante destro del mouse su **database** nella visualizzazione albero e selezionare **nuovo database.**</span><span class="sxs-lookup"><span data-stu-id="e02c5-126">Right click **Databases** in the tree view and select **New Database..**</span></span> <span data-ttu-id="e02c5-127">per creare un nuovo database denominato `SQLPersistenceStore` .</span><span class="sxs-lookup"><span data-stu-id="e02c5-127">to create a new database called `SQLPersistenceStore`.</span></span>

4. <span data-ttu-id="e02c5-128">Eseguire il file di script SqlWorkflowInstanceStoreSchema.sql presente nella directory C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en del database SQLPersistenceStore per configurare gli schemi del database necessari.</span><span class="sxs-lookup"><span data-stu-id="e02c5-128">Run the SqlWorkflowInstanceStoreSchema.sql script file located in the C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en directory on the SQLPersistenceStore database to set up the needed database schemas.</span></span>

5. <span data-ttu-id="e02c5-129">Eseguire il file di script SqlWorkflowInstanceStoreLogic.sql presente nella directory C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en del database SQLPersistenceStore per configurare la logica del database necessaria.</span><span class="sxs-lookup"><span data-stu-id="e02c5-129">Run the SqlWorkflowInstanceStoreLogic.sql script file located in the C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en directory on the SQLPersistenceStore database to set up the needed database logic.</span></span>

## <a name="create-the-web-hosted-workflow-service"></a><span data-ttu-id="e02c5-130">Creare il servizio del flusso di lavoro ospitato sul Web</span><span class="sxs-lookup"><span data-stu-id="e02c5-130">Create the Web Hosted Workflow Service</span></span>

1. <span data-ttu-id="e02c5-131">Creare una soluzione Visual Studio 2012 vuota, denominarla `OrderProcessing` .</span><span class="sxs-lookup"><span data-stu-id="e02c5-131">Create an empty Visual Studio 2012 solution, name it `OrderProcessing`.</span></span>

2. <span data-ttu-id="e02c5-132">Aggiungere un nuovo progetto Applicazione di servizi flusso di lavoro WCF denominato `OrderService` alla soluzione.</span><span class="sxs-lookup"><span data-stu-id="e02c5-132">Add a new WCF Workflow Service Application project called `OrderService` to the solution.</span></span>

3. <span data-ttu-id="e02c5-133">Nella finestra di dialogo Proprietà progetto selezionare la scheda **Web** .</span><span class="sxs-lookup"><span data-stu-id="e02c5-133">In the project properties dialog, select the **Web** tab.</span></span>

    1. <span data-ttu-id="e02c5-134">In **azione di avvio** selezionare **pagina specifica** e specificare `Service1.xamlx` .</span><span class="sxs-lookup"><span data-stu-id="e02c5-134">Under **Start Action** select **Specific Page** and specify `Service1.xamlx`.</span></span>

        <span data-ttu-id="e02c5-135">![Proprietà del progetto servizio Web flusso di lavoro](./media/creating-a-long-running-workflow-service/start-action-specific-page-option.png "Creare l'opzione di pagina specifica del servizio del flusso di lavoro ospitato sul Web")</span><span class="sxs-lookup"><span data-stu-id="e02c5-135">![Workflow Service Project Web Properties](./media/creating-a-long-running-workflow-service/start-action-specific-page-option.png "Create the web hosted workflow service - Specific Page option")</span></span>

    2. <span data-ttu-id="e02c5-136">In **Server** selezionare **Usa server Web IIS locale**.</span><span class="sxs-lookup"><span data-stu-id="e02c5-136">Under **Servers** select **Use Local IIS Web server**.</span></span>

        <span data-ttu-id="e02c5-137">![Impostazioni dei server Web locali](./media/creating-a-long-running-workflow-service/use-local-web-server.png "Creare il servizio flusso di lavoro ospitato sul Web: usare l'opzione server Web IIS locale")</span><span class="sxs-lookup"><span data-stu-id="e02c5-137">![Local Web Server Settings](./media/creating-a-long-running-workflow-service/use-local-web-server.png "Create the web hosted workflow service - Use Local IIS Web Server option")</span></span>

        > [!WARNING]
        > <span data-ttu-id="e02c5-138">Per impostare questa impostazione, è necessario eseguire Visual Studio 2012 in modalità amministratore.</span><span class="sxs-lookup"><span data-stu-id="e02c5-138">You must run Visual Studio 2012 in administrator mode to make this setting.</span></span>

        <span data-ttu-id="e02c5-139">Questi due passaggi consentono di configurare il progetto del servizio di flusso di lavoro che deve essere ospitato da IIS.</span><span class="sxs-lookup"><span data-stu-id="e02c5-139">These two steps configure the workflow service project to be hosted by IIS.</span></span>

4. <span data-ttu-id="e02c5-140">Aprire `Service1.xamlx` se non è già aperto ed eliminare le attività **ReceiveRequest** e **SendResponse** esistenti.</span><span class="sxs-lookup"><span data-stu-id="e02c5-140">Open `Service1.xamlx` if it is not open already and delete the existing **ReceiveRequest** and **SendResponse** activities.</span></span>

5. <span data-ttu-id="e02c5-141">Selezionare l'attività **sequenziale del servizio** e fare clic sul collegamento **variabili** e aggiungere le variabili illustrate nella figura seguente.</span><span class="sxs-lookup"><span data-stu-id="e02c5-141">Select the **Sequential Service** activity and click the **Variables** link and add the variables shown in the following illustration.</span></span> <span data-ttu-id="e02c5-142">In questo modo verranno aggiunte alcune variabili che saranno utilizzate successivamente nel servizio di flusso di lavoro.</span><span class="sxs-lookup"><span data-stu-id="e02c5-142">Doing this adds some variables that will be used later on in the workflow service.</span></span>

    > [!NOTE]
    > <span data-ttu-id="e02c5-143">Se CorrelationHandle non è presente nell'elenco a discesa tipo di variabile, selezionare **Cerca tipi** dall'elenco a discesa.</span><span class="sxs-lookup"><span data-stu-id="e02c5-143">If CorrelationHandle is not in the Variable Type drop-down, select **Browse for types** from the drop-down.</span></span> <span data-ttu-id="e02c5-144">Digitare CorrelationHandle nella casella **nome tipo** , selezionare CorrelationHandle nella casella di riepilogo e fare clic su **OK**.</span><span class="sxs-lookup"><span data-stu-id="e02c5-144">Type CorrelationHandle in the **Type name** box, select CorrelationHandle from the listbox and click **OK**.</span></span>

    <span data-ttu-id="e02c5-145">![Aggiungi variabili](./media/creating-a-long-running-workflow-service/add-variables-sequential-service-activity.gif "Aggiungere variabili all'attività sequenziale del servizio.")</span><span class="sxs-lookup"><span data-stu-id="e02c5-145">![Add Variables](./media/creating-a-long-running-workflow-service/add-variables-sequential-service-activity.gif "Add variables to the Sequential Service activity.")</span></span>

6. <span data-ttu-id="e02c5-146">Trascinare e rilasciare un modello di attività **ReceiveAndSendReply** nell'attività **sequenziale del servizio** .</span><span class="sxs-lookup"><span data-stu-id="e02c5-146">Drag and drop a **ReceiveAndSendReply** activity template into the **Sequential Service** activity.</span></span> <span data-ttu-id="e02c5-147">Un messaggio inviato da un client verrà ricevuto da questo set di attività tramite cui, a sua volta, verrà restituita una risposta.</span><span class="sxs-lookup"><span data-stu-id="e02c5-147">This set of activities will receive a message from a client and send a reply back.</span></span>

    1. <span data-ttu-id="e02c5-148">Selezionare l'attività **Receive** e impostare le proprietà evidenziate nella figura seguente.</span><span class="sxs-lookup"><span data-stu-id="e02c5-148">Select the **Receive** activity and set the properties highlighted in the following illustration.</span></span>

        <span data-ttu-id="e02c5-149">![Impostare le proprietà dell'attività Receive](./media/creating-a-long-running-workflow-service/set-receive-activity-properties.png "Impostare le proprietà dell'attività Receive.")</span><span class="sxs-lookup"><span data-stu-id="e02c5-149">![Set Receive Activity Properties](./media/creating-a-long-running-workflow-service/set-receive-activity-properties.png "Set the Receive activity properties.")</span></span>

        <span data-ttu-id="e02c5-150">La proprietà DisplayName consente di impostare il nome visualizzato per l'attività Receive nella finestra di progettazione.</span><span class="sxs-lookup"><span data-stu-id="e02c5-150">The DisplayName property sets the name displayed for the Receive activity in the designer.</span></span> <span data-ttu-id="e02c5-151">Le proprietà ServiceContractName e OperationName specificano il nome del contratto di servizio e della relativa operazione implementati dall'attività Receive.</span><span class="sxs-lookup"><span data-stu-id="e02c5-151">The ServiceContractName and OperationName properties specify the name of the service contract and operation that are implemented by the Receive activity.</span></span> <span data-ttu-id="e02c5-152">Per ulteriori informazioni sul modo in cui vengono utilizzati i contratti nei servizi flusso di lavoro, vedere [utilizzo di contratti nel flusso di lavoro](using-contracts-in-workflow.md).</span><span class="sxs-lookup"><span data-stu-id="e02c5-152">For more information about how contracts are used in Workflow services see [Using Contracts in Workflow](using-contracts-in-workflow.md).</span></span>

    2. <span data-ttu-id="e02c5-153">Fare clic sul collegamento **Definisci** nell'attività **ReceiveStartOrder** e impostare le proprietà mostrate nella figura seguente.</span><span class="sxs-lookup"><span data-stu-id="e02c5-153">Click the **Define...** link in the **ReceiveStartOrder** activity and set the properties shown in the following illustration.</span></span>  <span data-ttu-id="e02c5-154">Si noti che il pulsante di opzione **parametri** è selezionato, un parametro denominato `p_customerName` è associato alla `customerName` variabile.</span><span class="sxs-lookup"><span data-stu-id="e02c5-154">Notice that the **Parameters** radio button is selected, a parameter named `p_customerName` is bound to the `customerName` variable.</span></span> <span data-ttu-id="e02c5-155">In questo modo l'attività **Receive** viene configurata in modo da ricevere alcuni dati e associare tali dati alle variabili locali.</span><span class="sxs-lookup"><span data-stu-id="e02c5-155">This configures the **Receive** activity to receive some data and bind that data to local variables.</span></span>

        <span data-ttu-id="e02c5-156">![Impostazione dei dati ricevuti dall'attività di ricezione](./media/creating-a-long-running-workflow-service/set-properties-for-receive-content.png "Impostare le proprietà per i dati ricevuti dall'attività Receive.")</span><span class="sxs-lookup"><span data-stu-id="e02c5-156">![Setting the data received by the Receive activity](./media/creating-a-long-running-workflow-service/set-properties-for-receive-content.png "Set the properties for data received by the Receive activity.")</span></span>

    3. <span data-ttu-id="e02c5-157">Selezionare l'attività **SendReplyToReceive** e impostare la proprietà evidenziata mostrata nella figura seguente.</span><span class="sxs-lookup"><span data-stu-id="e02c5-157">Select The **SendReplyToReceive** activity and set the highlighted property shown in the following illustration.</span></span>

        <span data-ttu-id="e02c5-158">![Impostazione delle proprietà dell'attività SendReply](./media/creating-a-long-running-workflow-service/set-properties-for-reply-activities.png "SetReplyProperties")</span><span class="sxs-lookup"><span data-stu-id="e02c5-158">![Setting the properties of the SendReply activity](./media/creating-a-long-running-workflow-service/set-properties-for-reply-activities.png "SetReplyProperties")</span></span>

    4. <span data-ttu-id="e02c5-159">Fare clic sul collegamento **Definisci** nell'attività **SendReplyToStartOrder** e impostare le proprietà mostrate nella figura seguente.</span><span class="sxs-lookup"><span data-stu-id="e02c5-159">Click the **Define...** link in the **SendReplyToStartOrder** activity and set the properties shown in the following illustration.</span></span> <span data-ttu-id="e02c5-160">Si noti che il pulsante di opzione **parametri** è selezionato; un parametro denominato `p_orderId` è associato alla `orderId` variabile.</span><span class="sxs-lookup"><span data-stu-id="e02c5-160">Notice that the **Parameters** radio button is selected; a parameter named `p_orderId` is bound to the `orderId` variable.</span></span> <span data-ttu-id="e02c5-161">Questa impostazione consente di specificare che tramite l'attività SendReplyToStartOrder verrà restituito un valore di tipo stringa al chiamante.</span><span class="sxs-lookup"><span data-stu-id="e02c5-161">This setting specifies that the SendReplyToStartOrder activity will return a value of type string to the caller.</span></span>

        <span data-ttu-id="e02c5-162">![Configurazione dei dati di contenuto dell'attività SendReply](./media/creating-a-long-running-workflow-service/setreplycontent-for-sendreplytostartorder-activity.png "Configurare l'impostazione per l'attività SetReplyToStartOrder.")</span><span class="sxs-lookup"><span data-stu-id="e02c5-162">![Configuring the SendReply activity content data](./media/creating-a-long-running-workflow-service/setreplycontent-for-sendreplytostartorder-activity.png "Configure setting for SetReplyToStartOrder activity.")</span></span>

    5. <span data-ttu-id="e02c5-163">Trascinare e rilasciare un'attività Assign tra le attività **Receive** e **SendReply** e impostare le proprietà come illustrato nella figura seguente:</span><span class="sxs-lookup"><span data-stu-id="e02c5-163">Drag and drop an Assign activity in between the **Receive** and **SendReply** activities and set the properties as shown in the following illustration:</span></span>

        <span data-ttu-id="e02c5-164">![Aggiunta di un'attività di assegnazione](./media/creating-a-long-running-workflow-service/add-an-assign-activity.png "Aggiungere un'attività Assign.")</span><span class="sxs-lookup"><span data-stu-id="e02c5-164">![Adding an assign activity](./media/creating-a-long-running-workflow-service/add-an-assign-activity.png "Add an assign activity.")</span></span>

        <span data-ttu-id="e02c5-165">In questo modo viene creato un nuovo ID ordine e il valore viene inserito nella variabile orderId.</span><span class="sxs-lookup"><span data-stu-id="e02c5-165">This creates a new order ID and places the value in the orderId variable.</span></span>

    6. <span data-ttu-id="e02c5-166">Selezionare l'attività **ReplyToStartOrder** .</span><span class="sxs-lookup"><span data-stu-id="e02c5-166">Select the **ReplyToStartOrder** activity.</span></span> <span data-ttu-id="e02c5-167">Nella finestra Proprietà fare clic sul pulsante con i puntini di sospensione per **CorrelationInitializers**.</span><span class="sxs-lookup"><span data-stu-id="e02c5-167">In the properties window click the ellipsis button for **CorrelationInitializers**.</span></span> <span data-ttu-id="e02c5-168">Selezionare il collegamento **Aggiungi inizializzatore** , immettere `orderIdHandle` nella casella di testo dell'inizializzatore, selezionare inizializzatore di correlazione query per il tipo di correlazione e selezionare p_orderId nella casella a discesa query XPath.</span><span class="sxs-lookup"><span data-stu-id="e02c5-168">Select the **Add initializer** link, enter `orderIdHandle` in the Initializer text box, select Query correlation initializer for the Correlation type, and select p_orderId under the XPATH Queries dropdown box.</span></span> <span data-ttu-id="e02c5-169">Queste impostazioni sono mostrate nella figura seguente.</span><span class="sxs-lookup"><span data-stu-id="e02c5-169">These settings are shown in the following illustration.</span></span> <span data-ttu-id="e02c5-170">Fare clic su **OK**.</span><span class="sxs-lookup"><span data-stu-id="e02c5-170">Click **OK**.</span></span>  <span data-ttu-id="e02c5-171">Tale operazione consente di inizializzare una correlazione tra il client e questa istanza del servizio di flusso di lavoro.</span><span class="sxs-lookup"><span data-stu-id="e02c5-171">This initializes a correlation between the client and this instance of the workflow service.</span></span> <span data-ttu-id="e02c5-172">Quando viene ricevuto un messaggio contenente questo ID ordine, viene indirizzato a questa istanza del servizio di flusso di lavoro.</span><span class="sxs-lookup"><span data-stu-id="e02c5-172">When a message containing this order ID is received it is routed to this instance of the workflow service.</span></span>

        <span data-ttu-id="e02c5-173">![Aggiunta di un inizializzatore di correlazione](./media/creating-a-long-running-workflow-service/add-correlationinitializers.png "Aggiungere un inizializzatore di correlazione.")</span><span class="sxs-lookup"><span data-stu-id="e02c5-173">![Adding a correlation initializer](./media/creating-a-long-running-workflow-service/add-correlationinitializers.png "Add a correlation initializer.")</span></span>

7. <span data-ttu-id="e02c5-174">Trascinare e rilasciare un'altra attività **ReceiveAndSendReply** alla fine del flusso di lavoro (all'esterno della **sequenza** contenente le prime attività **Receive** e **SendReply** ).</span><span class="sxs-lookup"><span data-stu-id="e02c5-174">Drag and drop another **ReceiveAndSendReply** activity to the end of the workflow (outside the **Sequence** containing the first **Receive** and **SendReply** activities).</span></span> <span data-ttu-id="e02c5-175">Un secondo messaggio inviato dal client verrà ricevuto dal flusso di lavoro tramite cui, a sua volta, verrà fornita una risposta.</span><span class="sxs-lookup"><span data-stu-id="e02c5-175">This will receive the second message sent by the client and respond to it.</span></span>

    1. <span data-ttu-id="e02c5-176">Selezionare la **sequenza** che contiene le attività **Receive** e **SendReply** appena aggiunte, quindi fare clic sul pulsante **variabili** .</span><span class="sxs-lookup"><span data-stu-id="e02c5-176">Select the **Sequence** that contains the newly added **Receive** and **SendReply** activities and click the **Variables** button.</span></span> <span data-ttu-id="e02c5-177">Aggiungere la variabile evidenziata nell'immagine seguente:</span><span class="sxs-lookup"><span data-stu-id="e02c5-177">Add the variable highlighted in the following illustration:</span></span>

        <span data-ttu-id="e02c5-178">![Aggiunta di nuove variabili](./media/creating-a-long-running-workflow-service/add-the-itemid-variable.png "Aggiungere la variabile ItemId.")</span><span class="sxs-lookup"><span data-stu-id="e02c5-178">![Adding new variables](./media/creating-a-long-running-workflow-service/add-the-itemid-variable.png "Add the ItemId variable.")</span></span>

        <span data-ttu-id="e02c5-179">Aggiungere anche `orderResult` come **stringa** nell' `Sequence` ambito.</span><span class="sxs-lookup"><span data-stu-id="e02c5-179">Also add `orderResult` as **String** in the `Sequence` scope.</span></span>

    2. <span data-ttu-id="e02c5-180">Selezionare l'attività **Receive** e impostare le proprietà mostrate nella figura seguente:</span><span class="sxs-lookup"><span data-stu-id="e02c5-180">Select the **Receive** activity and set the properties shown in the following illustration:</span></span>

        <span data-ttu-id="e02c5-181">![Impostare le proprietà dell'attività Receive](./media/creating-a-long-running-workflow-service/set-receive-activities-properties.png "Impostare le proprietà delle attività di ricezione.")</span><span class="sxs-lookup"><span data-stu-id="e02c5-181">![Set the Receive activity properties](./media/creating-a-long-running-workflow-service/set-receive-activities-properties.png "Set the Receive activities properties.")</span></span>

        > [!NOTE]
        > <span data-ttu-id="e02c5-182">Non dimenticare di modificare il campo **ServiceContractName** con `../IAddItem` .</span><span class="sxs-lookup"><span data-stu-id="e02c5-182">Don't forget to change **ServiceContractName** field with `../IAddItem`.</span></span>

    3. <span data-ttu-id="e02c5-183">Fare clic sul collegamento **Definisci** nell'attività **ReceiveAddItem** e aggiungere i parametri mostrati nella figura seguente: in questo modo l'attività Receive viene configurata in modo da accettare due parametri, l'ID dell'ordine e l'ID dell'elemento ordinato.</span><span class="sxs-lookup"><span data-stu-id="e02c5-183">Click the **Define...** link in the **ReceiveAddItem** activity and add the parameters shown in the following illustration:This configures the receive activity to accept two parameters, the order ID and the ID of the item being ordered.</span></span>

        <span data-ttu-id="e02c5-184">![Specifica di parametri per la seconda ricezione](./media/creating-a-long-running-workflow-service/add-receive-two-parameters.png "Configurare l'attività Receive per ricevere due parametri.")</span><span class="sxs-lookup"><span data-stu-id="e02c5-184">![Specifying parameters for the second receive](./media/creating-a-long-running-workflow-service/add-receive-two-parameters.png "Configure the receive activity to receive two parameters.")</span></span>

    4. <span data-ttu-id="e02c5-185">Fare clic sul pulsante con i puntini di sospensione **CorrelateOn** e immettere `orderIdHandle` .</span><span class="sxs-lookup"><span data-stu-id="e02c5-185">Click the **CorrelateOn** ellipsis button and enter `orderIdHandle`.</span></span> <span data-ttu-id="e02c5-186">In **query XPath**fare clic sulla freccia a discesa e selezionare `p_orderId` .</span><span class="sxs-lookup"><span data-stu-id="e02c5-186">Under **XPath Queries**, click the drop down arrow and select `p_orderId`.</span></span> <span data-ttu-id="e02c5-187">In questo modo la correlazione viene configurata sulla seconda attività Receive.</span><span class="sxs-lookup"><span data-stu-id="e02c5-187">This configures the correlation on the second receive activity.</span></span> <span data-ttu-id="e02c5-188">Per ulteriori informazioni sulla correlazione, vedere [correlazione](correlation.md).</span><span class="sxs-lookup"><span data-stu-id="e02c5-188">For more information about correlation see [Correlation](correlation.md).</span></span>

        <span data-ttu-id="e02c5-189">![Impostazione della proprietà CorrelatesOn](./media/creating-a-long-running-workflow-service/correlateson-setting.png "Impostare la proprietà CorrelatesOn.")</span><span class="sxs-lookup"><span data-stu-id="e02c5-189">![Setting the CorrelatesOn property](./media/creating-a-long-running-workflow-service/correlateson-setting.png "Set the CorrelatesOn property.")</span></span>

    5. <span data-ttu-id="e02c5-190">Trascinare e rilasciare un'attività **if** immediatamente dopo l'attività **ReceiveAddItem** .</span><span class="sxs-lookup"><span data-stu-id="e02c5-190">Drag and drop an **If** activity immediately after the **ReceiveAddItem** activity.</span></span> <span data-ttu-id="e02c5-191">Il comportamento di questa attività è uguale a quello di un'istruzione IF.</span><span class="sxs-lookup"><span data-stu-id="e02c5-191">This activity acts just like an if statement.</span></span>

        1. <span data-ttu-id="e02c5-192">Impostare la proprietà **Condition** su`itemId=="Zune HD" (itemId="Zune HD" for Visual Basic)`</span><span class="sxs-lookup"><span data-stu-id="e02c5-192">Set the **Condition** property to `itemId=="Zune HD" (itemId="Zune HD" for Visual Basic)`</span></span>

        2. <span data-ttu-id="e02c5-193">Trascinare e rilasciare un'attività **assign** nella sezione **then** e un'altra nella sezione **else** per impostare le proprietà delle attività **assign** , come illustrato nella figura seguente.</span><span class="sxs-lookup"><span data-stu-id="e02c5-193">Drag and drop an **Assign** activity in to the **Then** section and another into the **Else** section set the properties of the **Assign** activities as shown in the following illustration.</span></span>

            <span data-ttu-id="e02c5-194">![Assegnazione del risultato della chiamata a servizio](./media/creating-a-long-running-workflow-service/assign-result-of-service-call.png "Assegnare il risultato della chiamata al servizio.")</span><span class="sxs-lookup"><span data-stu-id="e02c5-194">![Assigning the result of the service call](./media/creating-a-long-running-workflow-service/assign-result-of-service-call.png "Assign the result of the service call.")</span></span>

            <span data-ttu-id="e02c5-195">Se la condizione è `true` la sezione **then** verrà eseguita.</span><span class="sxs-lookup"><span data-stu-id="e02c5-195">If the condition is `true` the **Then** section will be executed.</span></span> <span data-ttu-id="e02c5-196">Se la condizione è `false` la sezione **else** viene eseguita.</span><span class="sxs-lookup"><span data-stu-id="e02c5-196">If the condition is `false` the **Else** section is executed.</span></span>

        3. <span data-ttu-id="e02c5-197">Selezionare l'attività **SendReplyToReceive** e impostare la proprietà **DisplayName** mostrata nella figura seguente.</span><span class="sxs-lookup"><span data-stu-id="e02c5-197">Select the **SendReplyToReceive** activity and set the **DisplayName** property shown in the following illustration.</span></span>

            <span data-ttu-id="e02c5-198">![Impostazione delle proprietà dell'attività SendReply](./media/creating-a-long-running-workflow-service/send-reply-activity-property.png "Impostare la proprietà dell'attività SendReply.")</span><span class="sxs-lookup"><span data-stu-id="e02c5-198">![Setting the SendReply activity properties](./media/creating-a-long-running-workflow-service/send-reply-activity-property.png "Set the SendReply activity property.")</span></span>

        4. <span data-ttu-id="e02c5-199">Fare clic sul collegamento **Definisci** nell'attività **SetReplyToAddItem** e configurarlo come illustrato nella figura seguente.</span><span class="sxs-lookup"><span data-stu-id="e02c5-199">Click the **Define ...** link in the **SetReplyToAddItem** activity and configure it as shown in the following illustration.</span></span> <span data-ttu-id="e02c5-200">In questo modo viene configurata l'attività **SendReplyToAddItem** per restituire il valore nella `orderResult` variabile.</span><span class="sxs-lookup"><span data-stu-id="e02c5-200">This configures the **SendReplyToAddItem** activity to return the value in the `orderResult` variable.</span></span>

            <span data-ttu-id="e02c5-201">![Impostazione della data binding per l'attività SendReply](./media/creating-a-long-running-workflow-service/set-property-for-sendreplytoadditem.gif "Imposta la proprietà per l'attività SendReplyToAddItem.")</span><span class="sxs-lookup"><span data-stu-id="e02c5-201">![Setting the data binding for the SendReply activity](./media/creating-a-long-running-workflow-service/set-property-for-sendreplytoadditem.gif "Set property for SendReplyToAddItem activity.")</span></span>

8. <span data-ttu-id="e02c5-202">Aprire il file Web. config e aggiungere i seguenti elementi nella \<behavior> sezione per abilitare la persistenza del flusso di lavoro.</span><span class="sxs-lookup"><span data-stu-id="e02c5-202">Open the web.config file and add the following elements in the \<behavior> section to enable workflow persistence.</span></span>

    ```xml
    <sqlWorkflowInstanceStore connectionString="Data Source=your-machine\SQLExpress;Initial Catalog=SQLPersistenceStore;Integrated Security=True;Asynchronous Processing=True" instanceEncodingOption="None" instanceCompletionAction="DeleteAll" instanceLockedExceptionAction="BasicRetry" hostLockRenewalPeriod="00:00:30" runnableInstancesDetectionPeriod="00:00:02" />
              <workflowIdle timeToUnload="0"/>
    ```

    > [!WARNING]
    > <span data-ttu-id="e02c5-203">Assicurarsi di sostituire l'host e il nome dell'istanza di SQL Server nel frammento di codice precedente.</span><span class="sxs-lookup"><span data-stu-id="e02c5-203">Make sure to replace your host and SQL server instance name in the previous code snippet.</span></span>

9. <span data-ttu-id="e02c5-204">Compilare la soluzione.</span><span class="sxs-lookup"><span data-stu-id="e02c5-204">Build the solution.</span></span>

## <a name="create-a-client-application-to-call-the-workflow-service"></a><span data-ttu-id="e02c5-205">Creare un'applicazione client per chiamare il servizio del flusso di lavoro</span><span class="sxs-lookup"><span data-stu-id="e02c5-205">Create a Client Application to Call the Workflow Service</span></span>

1. <span data-ttu-id="e02c5-206">Aggiungere un nuovo progetto di applicazione console denominato `OrderClient` alla soluzione.</span><span class="sxs-lookup"><span data-stu-id="e02c5-206">Add a new Console application project called `OrderClient` to the solution.</span></span>

2. <span data-ttu-id="e02c5-207">Aggiungere riferimenti agli assembly seguenti al progetto `OrderClient`</span><span class="sxs-lookup"><span data-stu-id="e02c5-207">Add references to the following assemblies to the `OrderClient` project</span></span>

    1. <span data-ttu-id="e02c5-208">System.ServiceModel.dll</span><span class="sxs-lookup"><span data-stu-id="e02c5-208">System.ServiceModel.dll</span></span>

    2. <span data-ttu-id="e02c5-209">System.ServiceModel.Activities.dll</span><span class="sxs-lookup"><span data-stu-id="e02c5-209">System.ServiceModel.Activities.dll</span></span>

3. <span data-ttu-id="e02c5-210">Aggiungere un riferimento al servizio di flusso di lavoro e specificare `OrderService` come spazio dei nomi.</span><span class="sxs-lookup"><span data-stu-id="e02c5-210">Add a service reference to the workflow service and specify `OrderService` as the namespace.</span></span>

4. <span data-ttu-id="e02c5-211">Nel metodo `Main()` del progetto client aggiungere il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="e02c5-211">In the `Main()` method of the client project add the following code:</span></span>

    ```csharp
    static void Main(string[] args)
    {
       // Send initial message to start the workflow service
       Console.WriteLine("Sending start message");
       StartOrderClient startProxy = new StartOrderClient();
       string orderId = startProxy.StartOrder("Kim Abercrombie");

       // The workflow service is now waiting for the second message to be sent
       Console.WriteLine("Workflow service is idle...");
       Console.WriteLine("Press [ENTER] to send an add item message to reactivate the workflow service...");
       Console.ReadLine();

       // Send the second message
       Console.WriteLine("Sending add item message");
       AddItemClient addProxy = new AddItemClient();
       AddItem item = new AddItem();
       item.p_itemId = "Zune HD";
       item.p_orderId = orderId;

       string orderResult = addProxy.AddItem(item);
       Console.WriteLine("Service returned: " + orderResult);
    }
    ```

5. <span data-ttu-id="e02c5-212">Compilare la soluzione ed eseguire l'applicazione `OrderClient`.</span><span class="sxs-lookup"><span data-stu-id="e02c5-212">Build the solution and run the `OrderClient` application.</span></span> <span data-ttu-id="e02c5-213">Nel client verrà visualizzato il testo seguente:</span><span class="sxs-lookup"><span data-stu-id="e02c5-213">The client will display the following text:</span></span>

    ```output
    Sending start messageWorkflow service is idle...Press [ENTER] to send an add item message to reactivate the workflow service...
    ```

6. <span data-ttu-id="e02c5-214">Per verificare che il servizio del flusso di lavoro sia stato salvato in modo permanente, avviare il SQL Server Management Studio dal menu **Start** , selezionando **tutti i programmi**, **Microsoft SQL Server 2008** **SQL Server Management Studio**.</span><span class="sxs-lookup"><span data-stu-id="e02c5-214">To verify that the workflow service has been persisted, start the SQL Server Management Studio by going to the **Start** menu, Selecting **All Programs**, **Microsoft SQL Server 2008**, **SQL Server Management Studio**.</span></span>

    1. <span data-ttu-id="e02c5-215">Nel riquadro a sinistra espandere **database**, **SQLPersistenceStore**, **viste** e fare clic con il pulsante destro del mouse su **System. Activities. DurableInstancing. instances** e scegliere **Seleziona le prime 1000 righe**.</span><span class="sxs-lookup"><span data-stu-id="e02c5-215">In the left hand pane expand, **Databases**, **SQLPersistenceStore**, **Views** and right click **System.Activities.DurableInstancing.Instances** and select **Select Top 1000 Rows**.</span></span> <span data-ttu-id="e02c5-216">Nel riquadro **dei risultati** verificare che sia elencata almeno un'istanza.</span><span class="sxs-lookup"><span data-stu-id="e02c5-216">In the **Results** pane verify you see at least one instance listed.</span></span> <span data-ttu-id="e02c5-217">Se durante l'esecuzione si è verificata un'eccezione potrebbero essere presenti altre istanze di esecuzioni precedenti.</span><span class="sxs-lookup"><span data-stu-id="e02c5-217">There may be other instances from prior runs if an exception occurred while running.</span></span> <span data-ttu-id="e02c5-218">È possibile eliminare le righe esistenti facendo clic con il pulsante destro del mouse su **System. Activities. DurableInstancing. Instances** e selezionando **modifica le prime 200 righe**, premendo il pulsante **Esegui** , selezionando tutte le righe nel riquadro risultati e selezionando **Elimina**.</span><span class="sxs-lookup"><span data-stu-id="e02c5-218">You can delete existing rows by right clicking **System.Activities.DurableInstancing.Instances** and selecting **Edit Top 200 rows**, pressing the **Execute** button, selecting all rows in the results pane and selecting **delete**.</span></span>  <span data-ttu-id="e02c5-219">Per verificare che l'istanza visualizzata nel database sia l'istanza creata dall'applicazione, controllare che la visualizzazione delle istanze sia vuota prima di eseguire il client.</span><span class="sxs-lookup"><span data-stu-id="e02c5-219">To verify the instance displayed in the database is the instance your application created, verify the instances view is empty prior to running the client.</span></span> <span data-ttu-id="e02c5-220">Quando il client è in esecuzione, eseguire di nuovo la query (Seleziona le prime 1000 righe) e verificare che sia stata aggiunta una nuova istanza.</span><span class="sxs-lookup"><span data-stu-id="e02c5-220">Once the client is running re-run the query (Select Top 1000 Rows) and verify a new instance has been added.</span></span>

7. <span data-ttu-id="e02c5-221">Premere INVIO per inviare il messaggio relativo all'aggiunta di elementi al servizio di flusso di lavoro.</span><span class="sxs-lookup"><span data-stu-id="e02c5-221">Press enter to send the add item message to the workflow service.</span></span> <span data-ttu-id="e02c5-222">Nel client verrà visualizzato il testo seguente:</span><span class="sxs-lookup"><span data-stu-id="e02c5-222">The client will display the following text:</span></span>

    ```output
    Sending add item messageService returned: Item added to orderPress any key to continue . . .
    ```

## <a name="see-also"></a><span data-ttu-id="e02c5-223">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="e02c5-223">See also</span></span>

- [<span data-ttu-id="e02c5-224">Servizi flusso di lavoro</span><span class="sxs-lookup"><span data-stu-id="e02c5-224">Workflow Services</span></span>](workflow-services.md)
