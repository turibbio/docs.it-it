---
title: Uso di code di messaggi non recapitabili per gestire errori di trasferimento dei messaggi
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 9e891c6a-d960-45ea-904f-1a00e202d61a
ms.openlocfilehash: f07397b4c10ffec4902dbde37b622978d00f5b63
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/09/2020
ms.locfileid: "84594985"
---
# <a name="using-dead-letter-queues-to-handle-message-transfer-failures"></a><span data-ttu-id="29b19-102">Uso di code di messaggi non recapitabili per gestire errori di trasferimento dei messaggi</span><span class="sxs-lookup"><span data-stu-id="29b19-102">Using Dead-Letter Queues to Handle Message Transfer Failures</span></span>
<span data-ttu-id="29b19-103">È possibile che i messaggi in coda non vengano recapitati.</span><span class="sxs-lookup"><span data-stu-id="29b19-103">Queued messages can fail delivery.</span></span> <span data-ttu-id="29b19-104">Tali messaggi con errori vengono registrati in una coda di messaggi non recapitabili.</span><span class="sxs-lookup"><span data-stu-id="29b19-104">These failed messages are recorded in a dead-letter queue.</span></span> <span data-ttu-id="29b19-105">Il mancato recapito può essere dovuto a errori della rete, all'eliminazione di una coda, a una coda completa, a un errore di autenticazione o alla scadenza del tempo disponibile per il recapito.</span><span class="sxs-lookup"><span data-stu-id="29b19-105">The failed delivery can be caused by reasons such as network failures, a deleted queue, a full queue, authentication failure, or a failure to deliver on time.</span></span>  
  
 <span data-ttu-id="29b19-106">I messaggi in coda possono rimanere nella coda per molto tempo se l'applicazione ricevente non li legge tempestivamente.</span><span class="sxs-lookup"><span data-stu-id="29b19-106">Queued messages can remain in the queue for a long time if the receiving application does not read them from the queue in a timely fashion.</span></span> <span data-ttu-id="29b19-107">Questo comportamento potrebbe non essere adatto per i messaggi a scadenza.</span><span class="sxs-lookup"><span data-stu-id="29b19-107">This behavior may not be appropriate for time-sensitive messages.</span></span> <span data-ttu-id="29b19-108">Nell'associazione in coda la proprietà TTL (Time to Live) dei messaggi a scadenza è impostata, a indicare la durata della permanenza dei messaggi nella coda prima che scadano.</span><span class="sxs-lookup"><span data-stu-id="29b19-108">Time-sensitive messages have a Time to Live (TTL) property set in the queued binding, which indicates how long the messages can be in the queue before they must expire.</span></span> <span data-ttu-id="29b19-109">I messaggi scaduti vengono inviati a una coda speciale denominata coda dei messaggi non recapitabili.</span><span class="sxs-lookup"><span data-stu-id="29b19-109">Expired messages are sent to a special queue called the dead-letter queue.</span></span> <span data-ttu-id="29b19-110">I messaggi possono essere inoltre inseriti in una coda di messaggi non recapitabili per altri motivi, ad esempio se viene superata una quota della coda o se si verifica un errore di autenticazione.</span><span class="sxs-lookup"><span data-stu-id="29b19-110">Messages can also be put in a dead-letter queue for other reasons, such as exceeding a queue quota or because of authentication failure.</span></span>  
  
 <span data-ttu-id="29b19-111">In genere le applicazioni scrivono logica di compensazione per leggere i messaggi dalla coda dei messaggi non recapitabili e le motivazioni dell'errore.</span><span class="sxs-lookup"><span data-stu-id="29b19-111">Generally, applications write compensation logic to read messages from the dead-letter queue and failure reasons.</span></span> <span data-ttu-id="29b19-112">La logica di compensazione dipende dalla causa dell'errore.</span><span class="sxs-lookup"><span data-stu-id="29b19-112">The compensation logic depends on the cause of the failure.</span></span> <span data-ttu-id="29b19-113">Nel caso di un errore di autenticazione, ad esempio, è possibile correggere il certificato allegato al messaggio e inviare di nuovo il messaggio.</span><span class="sxs-lookup"><span data-stu-id="29b19-113">For example, in the case of authentication failure, you can correct the certificate attached with the message and resend the message.</span></span> <span data-ttu-id="29b19-114">Se il messaggio non è stato recapitato a causa del raggiungimento della quota della coda di destinazione, è possibile tentare di recapitare di nuovo il messaggio nella speranza che il problema della quota sia stato risolto.</span><span class="sxs-lookup"><span data-stu-id="29b19-114">If delivery failed because the target queue quota was reached, you can reattempt delivery in the hope that the quota problem was resolved.</span></span>  
  
 <span data-ttu-id="29b19-115">La maggior parte dei sistemi di accodamento dispongono di una coda di messaggi non recapitabili a livello di sistema nella quale vengono archiviati tutti i messaggi con errori provenienti dal sistema.</span><span class="sxs-lookup"><span data-stu-id="29b19-115">Most queuing systems have a system-wide dead-letter queue where all failed messages from that system are stored.</span></span> <span data-ttu-id="29b19-116">In MSMQ (Accodamento messaggi) sono presenti due code di messaggi non recapitabili a livello di sistema: una coda di messaggi non recapitabili relativi a transazioni in cui sono archiviati messaggi non recapitati alla coda transazionale e una coda di messaggi non recapitabili in cui sono archiviati messaggi non recapitati alla coda non transazionale.</span><span class="sxs-lookup"><span data-stu-id="29b19-116">Message Queuing (MSMQ) provides two system-wide dead-letter queues: a transactional system-wide dead-letter queue that stores messages that failed delivery to the transactional queue and a non-transactional system-wide dead-letter queue that stores messages that failed delivery to the non-transactional queue.</span></span> <span data-ttu-id="29b19-117">Se due client inviano messaggi a due servizi diversi e pertanto code diverse in WCF condividono lo stesso servizio MSMQ per l'invio, è possibile che nella coda dei messaggi non recapitabili di sistema sia presente una combinazione di messaggi.</span><span class="sxs-lookup"><span data-stu-id="29b19-117">If two clients are sending messages to two different services, and therefore different queues in WCF are sharing the same MSMQ service to send, then it is possible to have a mix of messages in the system dead-letter queue.</span></span> <span data-ttu-id="29b19-118">Non è sempre una situazione ottimale.</span><span class="sxs-lookup"><span data-stu-id="29b19-118">This is not always optimal.</span></span> <span data-ttu-id="29b19-119">In molti casi (di sicurezza, ad esempio), non è opportuno che un client legga i messaggi di un altro client da una coda di messaggi non recapitabili.</span><span class="sxs-lookup"><span data-stu-id="29b19-119">In several cases (security, for example), you may not want one client to read another client's messages from a dead-letter queue.</span></span> <span data-ttu-id="29b19-120">Una coda di messaggi non recapitabili condivisa, inoltre, impone ai client di scorrere la coda per trovare un messaggio inviato, operazione potenzialmente laboriosa in base al numero dei messaggi contenuti nella coda.</span><span class="sxs-lookup"><span data-stu-id="29b19-120">A shared dead-letter queue also requires clients to browse through the queue to find a message that they sent, which can be prohibitively expensive based on the number of messages in the dead-letter queue.</span></span> <span data-ttu-id="29b19-121">Pertanto, in WCF `NetMsmqBinding` `MsmqIntegrationBinding,` e MSMQ in Windows Vista forniscono una coda di messaggi non recapitabili personalizzata (talvolta definita coda dei messaggi non recapitabili specifica dell'applicazione).</span><span class="sxs-lookup"><span data-stu-id="29b19-121">Therefore, in WCF`NetMsmqBinding`, `MsmqIntegrationBinding,` and MSMQ on Windows Vista provide a custom dead-letter queue (sometimes referred to as an application-specific dead-letter queue).</span></span>  
  
 <span data-ttu-id="29b19-122">La coda di messaggi non recapitabili personalizzata fornisce l'isolamento tra client che condividono lo stesso servizio MSMQ per l'invio dei messaggi.</span><span class="sxs-lookup"><span data-stu-id="29b19-122">The custom dead-letter queue provides isolation between clients that share the same MSMQ service to send messages.</span></span>  
  
 <span data-ttu-id="29b19-123">In Windows Server 2003 e Windows XP, Windows Communication Foundation (WCF) fornisce una coda di messaggi non recapitabili a livello di sistema per tutte le applicazioni client in coda.</span><span class="sxs-lookup"><span data-stu-id="29b19-123">On Windows Server 2003 and Windows XP, Windows Communication Foundation (WCF) provides a system-wide dead-letter queue for all queued client applications.</span></span> <span data-ttu-id="29b19-124">In Windows Vista, WCF fornisce una coda di messaggi non recapitabili per ogni applicazione client in coda.</span><span class="sxs-lookup"><span data-stu-id="29b19-124">On Windows Vista, WCF provides a dead-letter queue for each queued client application.</span></span>  
  
## <a name="specifying-use-of-the-dead-letter-queue"></a><span data-ttu-id="29b19-125">Specificazione dell'utilizzo della coda dei messaggi non recapitabili</span><span class="sxs-lookup"><span data-stu-id="29b19-125">Specifying Use of the Dead-Letter Queue</span></span>  
 <span data-ttu-id="29b19-126">La coda dei messaggi non recapitabili si trova nel gestore delle code dell'applicazione mittente.</span><span class="sxs-lookup"><span data-stu-id="29b19-126">A dead-letter queue is in the queue manager of the sending application.</span></span> <span data-ttu-id="29b19-127">Archivia messaggi scaduti o che non è stato possibile trasferire o recapitare.</span><span class="sxs-lookup"><span data-stu-id="29b19-127">It stores messages that have expired or that have failed transfer or delivery.</span></span>  
  
 <span data-ttu-id="29b19-128">L'associazione dispone delle proprietà della coda di messaggi non recapitabili seguenti:</span><span class="sxs-lookup"><span data-stu-id="29b19-128">The binding has the following dead-letter queue properties:</span></span>  
  
- <xref:System.ServiceModel.MsmqBindingBase.DeadLetterQueue%2A>  
  
- <xref:System.ServiceModel.MsmqBindingBase.CustomDeadLetterQueue%2A>  
  
## <a name="reading-messages-from-the-dead-letter-queue"></a><span data-ttu-id="29b19-129">Lettura dalla coda dei messaggi non recapitabili</span><span class="sxs-lookup"><span data-stu-id="29b19-129">Reading Messages from the Dead-Letter Queue</span></span>  
 <span data-ttu-id="29b19-130">Un'applicazione che legge i messaggi da una coda di messaggi non recapitabili è simile a un servizio WCF che legge da una coda dell'applicazione, ad eccezione delle differenze minime seguenti:</span><span class="sxs-lookup"><span data-stu-id="29b19-130">An application that reads messages out of a dead-letter queue is similar to a WCF service that reads from an application queue, except for the following minor differences:</span></span>  
  
- <span data-ttu-id="29b19-131">Per leggere messaggi da una coda di sistema di messaggi non recapitabili relativi a transazioni, l'URI (Uniform Resource Identifier) deve presentarsi nel formato net.msmq://localhost/system$;DeadXact.</span><span class="sxs-lookup"><span data-stu-id="29b19-131">To read messages from a system transactional dead-letter queue, the Uniform Resource Identifier (URI) must be of the form: net.msmq://localhost/system$;DeadXact.</span></span>  
  
- <span data-ttu-id="29b19-132">Per leggere messaggi da una coda di sistema di messaggi non recapitabili non relativi a transazioni, l'URI deve presentarsi nel formato net.msmq://localhost/system$;DeadLetter.</span><span class="sxs-lookup"><span data-stu-id="29b19-132">To read messages from a system non-transactional dead-letter queue, the URI must be of the form: net.msmq://localhost/system$;DeadLetter.</span></span>  
  
- <span data-ttu-id="29b19-133">Per leggere i messaggi da una coda di messaggi non recapitabili personalizzata, l'URI deve avere il formato: NET. MSMQ://localhost/private/ \<*custom-dlq-name*> dove *Custom-coda DLQ-Name* è il nome della coda dei messaggi non recapitabili personalizzata.</span><span class="sxs-lookup"><span data-stu-id="29b19-133">To read messages from a custom dead-letter queue, the URI must be of the form:net.msmq://localhost/private/\<*custom-dlq-name*> where *custom-dlq-name* is the name of the custom dead-letter queue.</span></span>  
  
 <span data-ttu-id="29b19-134">Per ulteriori informazioni su come indirizzare le code, vedere [endpoint di servizio e indirizzamento delle code](service-endpoints-and-queue-addressing.md).</span><span class="sxs-lookup"><span data-stu-id="29b19-134">For more information about how to address queues, see [Service Endpoints and Queue Addressing](service-endpoints-and-queue-addressing.md).</span></span>  
  
 <span data-ttu-id="29b19-135">Lo stack WCF sul ricevitore corrisponde agli indirizzi su cui il servizio è in ascolto con l'indirizzo del messaggio.</span><span class="sxs-lookup"><span data-stu-id="29b19-135">The WCF stack on the receiver matches addresses that the service is listening on with the address on the message.</span></span> <span data-ttu-id="29b19-136">Se gli indirizzi corrispondono, il messaggio viene inviato. In caso contrario, il messaggio non viene inviato.</span><span class="sxs-lookup"><span data-stu-id="29b19-136">If the addresses match, the message is dispatched; if not, the message is not dispatched.</span></span> <span data-ttu-id="29b19-137">Ciò può provocare problemi in caso di lettura dalla coda di messaggi non recapitabili, perché i messaggi in essa contenuti sono solitamente indirizzati al servizio, non al servizio della coda di messaggi non recapitabili.</span><span class="sxs-lookup"><span data-stu-id="29b19-137">This can cause problems when reading from the dead-letter queue, because messages in the dead-letter queue are typically addressed to the service and not the dead-letter queue service.</span></span> <span data-ttu-id="29b19-138">Pertanto, il servizio che legge dalla coda di messaggi non recapitabili deve installare un `ServiceBehavior` di filtro di indirizzi che indichi allo stack di far corrispondere tutti i messaggi contenuti nella coda indipendentemente dal destinatario.</span><span class="sxs-lookup"><span data-stu-id="29b19-138">Therefore, the service reading from the dead-letter queue must install an address filter `ServiceBehavior` that instructs the stack to match all messages in the queue independently of the addressee.</span></span> <span data-ttu-id="29b19-139">In particolare è necessario aggiungere un `ServiceBehavior` con il parametro <xref:System.ServiceModel.AddressFilterMode.Any> al servizio che legge messaggi dalla coda di messaggi non recapitabili.</span><span class="sxs-lookup"><span data-stu-id="29b19-139">Specifically, you must add a `ServiceBehavior` with the <xref:System.ServiceModel.AddressFilterMode.Any> parameter to the service reading messages from the dead-letter queue.</span></span>  
  
## <a name="poison-message-handling-from-the-dead-letter-queue"></a><span data-ttu-id="29b19-140">Gestione dei messaggi non elaborabili dalla coda dei messaggi non recapitabili</span><span class="sxs-lookup"><span data-stu-id="29b19-140">Poison Message Handling from the Dead-Letter Queue</span></span>  
 <span data-ttu-id="29b19-141">La gestione dei messaggi non elaborabili è disponibile nelle code dei messaggi non recapitabili, ad alcune condizioni.</span><span class="sxs-lookup"><span data-stu-id="29b19-141">Poison message handling is available on dead-letter queues, with some conditions.</span></span> <span data-ttu-id="29b19-142">Poiché non è possibile creare code secondarie dalle code di sistema, durante la lettura dalla coda di sistema dei messaggi non recapitabili `ReceiveErrorHandling` non può essere impostato su `Move`.</span><span class="sxs-lookup"><span data-stu-id="29b19-142">Because you cannot create sub-queues from system queues, when reading from the system dead-letter queue, the `ReceiveErrorHandling` cannot be set to `Move`.</span></span> <span data-ttu-id="29b19-143">Si noti che se si legge da una coda di messaggi non recapitabili personalizzata, è possibile avere code secondarie e, quindi, `Move` è una disposizione valida per il messaggio non elaborabile.</span><span class="sxs-lookup"><span data-stu-id="29b19-143">Note that if you are reading from a custom dead-letter queue, you can have sub-queues and, therefore, `Move` is a valid disposition for the poison message.</span></span>  
  
 <span data-ttu-id="29b19-144">Quando `ReceiveErrorHandling` è impostato su `Reject`, durante la lettura dalla coda di messaggi non recapitabili personalizzata il messaggio non elaborabile viene inserito nella coda di sistema dei messaggi non recapitabili.</span><span class="sxs-lookup"><span data-stu-id="29b19-144">When `ReceiveErrorHandling` is set to `Reject`, when reading from the custom dead letter queue, the poison message is put in the system dead-letter queue.</span></span> <span data-ttu-id="29b19-145">Nel caso di lettura dalla coda di sistema dei messaggi non recapitabili, il messaggio viene rilasciato (eliminato).</span><span class="sxs-lookup"><span data-stu-id="29b19-145">If reading from the system dead-letter queue, the message is dropped (purged).</span></span> <span data-ttu-id="29b19-146">Un rifiuto da una coda di sistema di messaggi non recapitabili in MSMQ comporta il rilascio (eliminazione) del messaggio.</span><span class="sxs-lookup"><span data-stu-id="29b19-146">A reject from a system dead-letter queue in MSMQ drops (purges) the message.</span></span>  
  
## <a name="example"></a><span data-ttu-id="29b19-147">Esempio</span><span class="sxs-lookup"><span data-stu-id="29b19-147">Example</span></span>  
 <span data-ttu-id="29b19-148">Nell'esempio seguente viene descritto come creare una coda di messaggi non recapitabili e come utilizzarla per elaborare messaggi scaduti.</span><span class="sxs-lookup"><span data-stu-id="29b19-148">The following example shows how to create a dead-letter queue and how to use it to process expired messages.</span></span> <span data-ttu-id="29b19-149">L'esempio è basato sull'esempio in [procedura: scambiare messaggi in coda con endpoint WCF](how-to-exchange-queued-messages-with-wcf-endpoints.md).</span><span class="sxs-lookup"><span data-stu-id="29b19-149">The example is based on the example in [How to: Exchange Queued Messages with WCF Endpoints](how-to-exchange-queued-messages-with-wcf-endpoints.md).</span></span> <span data-ttu-id="29b19-150">Nell'esempio seguente viene descritto come scrivere il codice client nel servizio di elaborazione ordini che utilizza una coda di messaggi non recapitabili per ogni applicazione.</span><span class="sxs-lookup"><span data-stu-id="29b19-150">The following example shows how to write the client code to the order processing service that uses a dead-letter queue for each application.</span></span> <span data-ttu-id="29b19-151">Nell'esempio viene inoltre mostrato come elaborare messaggi dalla coda di messaggi non recapitabili.</span><span class="sxs-lookup"><span data-stu-id="29b19-151">The example also shows how to process messages from the dead-letter queue.</span></span>  
  
 <span data-ttu-id="29b19-152">Il codice seguente si riferisce a un client che specifica una coda di messaggi non recapitabili per ogni applicazione.</span><span class="sxs-lookup"><span data-stu-id="29b19-152">The following is code for a client that specifies a dead-letter queue for each application.</span></span>  
  
 [!code-csharp[S_DeadLetter#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/client.cs#1)]
 [!code-vb[S_DeadLetter#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/client.vb#1)]  
  
 <span data-ttu-id="29b19-153">Il codice seguente è per un file di configurazione client.</span><span class="sxs-lookup"><span data-stu-id="29b19-153">The following is code for the client configuration file.</span></span>  

 <span data-ttu-id="29b19-154">Il codice seguente si riferisce a un servizio che elabora messaggi da una coda di messaggi non recapitabili.</span><span class="sxs-lookup"><span data-stu-id="29b19-154">The following is code for a service processing messages from a dead-letter queue.</span></span>  
  
 [!code-csharp[S_DeadLetter#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/dlservice.cs#3)]
 [!code-vb[S_DeadLetter#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/dlservice.vb#3)]  
  
 <span data-ttu-id="29b19-155">Il codice seguente è per il file di configurazione del servizio della coda di messaggi non recapitabili.</span><span class="sxs-lookup"><span data-stu-id="29b19-155">The following is code for the dead-letter queue service configuration file.</span></span>  

## <a name="see-also"></a><span data-ttu-id="29b19-156">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="29b19-156">See also</span></span>

- [<span data-ttu-id="29b19-157">Panoramica delle code</span><span class="sxs-lookup"><span data-stu-id="29b19-157">Queues Overview</span></span>](queues-overview.md)
- [<span data-ttu-id="29b19-158">Procedura: scambiare messaggi in coda con endpoint WCF</span><span class="sxs-lookup"><span data-stu-id="29b19-158">How to: Exchange Queued Messages with WCF Endpoints</span></span>](how-to-exchange-queued-messages-with-wcf-endpoints.md)
- [<span data-ttu-id="29b19-159">Gestione dei messaggi non elaborabili</span><span class="sxs-lookup"><span data-stu-id="29b19-159">Poison Message Handling</span></span>](poison-message-handling.md)
