---
title: Raggruppamento di messaggi in una transazione
ms.date: 03/30/2017
helpviewer_keywords:
- batching messages [WCF]
ms.assetid: 53305392-e82e-4e89-aedc-3efb6ebcd28c
ms.openlocfilehash: 3b35d1de76587ce750bf73189eb37658c3d87a90
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/09/2020
ms.locfileid: "84593620"
---
# <a name="batching-messages-in-a-transaction"></a><span data-ttu-id="d4b22-102">Raggruppamento di messaggi in una transazione</span><span class="sxs-lookup"><span data-stu-id="d4b22-102">Batching Messages in a Transaction</span></span>
<span data-ttu-id="d4b22-103">Le applicazioni in coda utilizzano le transazioni per garantire che i messaggi siano corretti e che vengano recapitati in modo affidabile.</span><span class="sxs-lookup"><span data-stu-id="d4b22-103">Queued applications use transactions to ensure correctness and reliable delivery of messages.</span></span> <span data-ttu-id="d4b22-104">Tuttavia, le transazioni sono operazioni che richiedono un'elevata quantità di risorse e che pertanto possono comportare una notevole riduzione della velocità effettiva di recapito dei messaggi.</span><span class="sxs-lookup"><span data-stu-id="d4b22-104">Transactions, however, are expensive operations and can dramatically reduce message throughput.</span></span> <span data-ttu-id="d4b22-105">Un modo per migliorare questa velocità è configurare un'applicazione affinché legga ed elabori più messaggi in un'unica transazione.</span><span class="sxs-lookup"><span data-stu-id="d4b22-105">One way to improve message throughput is to have an application read and process multiple messages within a single transaction.</span></span> <span data-ttu-id="d4b22-106">Il compromesso è tra prestazioni e ripristino: il numero di messaggi raggruppati in un batch è infatti direttamente proporzionale alla quantità di operazioni di ripristino necessarie in caso di rollback delle transazioni.</span><span class="sxs-lookup"><span data-stu-id="d4b22-106">The trade-off is between performance and recovery: as the number of messages in a batch increases, so does the amount of recovery work that required if transactions are rolled back.</span></span> <span data-ttu-id="d4b22-107">È importante notare la differenza tra raggruppare i messaggi in una transazione e raggruppare i messaggi in una sessione.</span><span class="sxs-lookup"><span data-stu-id="d4b22-107">It is important to note the difference between batching messages in a transaction and sessions.</span></span> <span data-ttu-id="d4b22-108">Una *sessione* è un raggruppamento di messaggi correlati elaborati da un'unica applicazione e di cui è stato eseguito il commit come singola unità.</span><span class="sxs-lookup"><span data-stu-id="d4b22-108">A *session* is a grouping of related messages that are processed by a single application and committed as a single unit.</span></span> <span data-ttu-id="d4b22-109">In genere le sessioni vengono utilizzate quando occorre elaborare nello stesso contesto un gruppo di messaggi correlati.</span><span class="sxs-lookup"><span data-stu-id="d4b22-109">Sessions are generally used when a group of related messages must be processed together.</span></span> <span data-ttu-id="d4b22-110">Ad esempio, questo tipo di elaborazione viene utilizzato nei siti Web che consentono di fare acquisti in linea.</span><span class="sxs-lookup"><span data-stu-id="d4b22-110">An example of this is an online shopping Web site.</span></span> <span data-ttu-id="d4b22-111">I *batch* vengono utilizzati per elaborare più messaggi non correlati in modo da aumentare la velocità effettiva del messaggio.</span><span class="sxs-lookup"><span data-stu-id="d4b22-111">*Batches* are used to process multiple, unrelated messages in a way that increases message throughput.</span></span> <span data-ttu-id="d4b22-112">Per ulteriori informazioni sulle sessioni, vedere [raggruppamento di messaggi in coda in una sessione](grouping-queued-messages-in-a-session.md).</span><span class="sxs-lookup"><span data-stu-id="d4b22-112">For more information about sessions, see [Grouping Queued Messages in a Session](grouping-queued-messages-in-a-session.md).</span></span> <span data-ttu-id="d4b22-113">Anche per i messaggi raggruppati in batch l'elaborazione viene eseguita da un'unica applicazione e il commit viene svolto in un'unica operazione. A differenza delle sessioni, tuttavia, fra i messaggi di un batch è possibile che non sussista alcuna correlazione.</span><span class="sxs-lookup"><span data-stu-id="d4b22-113">Messages in a batch are also processed by a single application and committed as a single unit, but there may be no relationship between the messages in the batch.</span></span> <span data-ttu-id="d4b22-114">Il raggruppamento dei messaggi in una transazione è un'ottimizzazione che non influisce sulla modalità di esecuzione dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="d4b22-114">Batching messages in a transaction is an optimization that does not change how the application runs.</span></span>  
  
## <a name="entering-batching-mode"></a><span data-ttu-id="d4b22-115">Passaggio in modalità batch</span><span class="sxs-lookup"><span data-stu-id="d4b22-115">Entering Batching Mode</span></span>  
 <span data-ttu-id="d4b22-116">Il comportamento dell'endpoint <xref:System.ServiceModel.Description.TransactedBatchingBehavior> controlla la funzionalità di batch.</span><span class="sxs-lookup"><span data-stu-id="d4b22-116">The <xref:System.ServiceModel.Description.TransactedBatchingBehavior> endpoint behavior controls batching.</span></span> <span data-ttu-id="d4b22-117">L'aggiunta di questo comportamento dell'endpoint a un endpoint del servizio indica Windows Communication Foundation (WCF) di inviare in batch i messaggi in una transazione.</span><span class="sxs-lookup"><span data-stu-id="d4b22-117">Adding this endpoint behavior to a service endpoint tells Windows Communication Foundation (WCF) to batch messages in a transaction.</span></span> <span data-ttu-id="d4b22-118">Non tutti i messaggi richiedono una transazione, quindi solo i messaggi che richiedono una transazione vengono inseriti in un batch e solo i messaggi inviati dalle operazioni contrassegnate con `TransactionScopeRequired`  =  `true` e `TransactionAutoComplete`  =  `true` vengono considerati per un batch.</span><span class="sxs-lookup"><span data-stu-id="d4b22-118">Not all messages require a transaction, so only messages that require a transaction are placed in a batch, and only messages sent from operations marked with `TransactionScopeRequired` = `true` and `TransactionAutoComplete` = `true` are considered for a batch.</span></span> <span data-ttu-id="d4b22-119">Se tutte le operazioni nel contratto di servizio sono contrassegnate con `TransactionScopeRequired`  =  `false` e `TransactionAutoComplete`  =  `false` , la modalità batch non viene mai immessa.</span><span class="sxs-lookup"><span data-stu-id="d4b22-119">If all operations on the service contract are marked with `TransactionScopeRequired` = `false` and `TransactionAutoComplete` = `false`, then batching mode is never entered.</span></span>  
  
## <a name="committing-a-transaction"></a><span data-ttu-id="d4b22-120">Esecuzione del commit di una transazione</span><span class="sxs-lookup"><span data-stu-id="d4b22-120">Committing a Transaction</span></span>  
 <span data-ttu-id="d4b22-121">Il commit di una transazione eseguita in batch viene eseguito nei casi seguenti:</span><span class="sxs-lookup"><span data-stu-id="d4b22-121">A batched transaction is committed based on the following:</span></span>  
  
- <span data-ttu-id="d4b22-122">`MaxBatchSize`.</span><span class="sxs-lookup"><span data-stu-id="d4b22-122">`MaxBatchSize`.</span></span> <span data-ttu-id="d4b22-123">Si tratta di una proprietà del comportamento <xref:System.ServiceModel.Description.TransactedBatchingBehavior>.</span><span class="sxs-lookup"><span data-stu-id="d4b22-123">A property of the <xref:System.ServiceModel.Description.TransactedBatchingBehavior> behavior.</span></span> <span data-ttu-id="d4b22-124">Questa proprietà determina il numero massimo di messaggi raggruppati in un batch.</span><span class="sxs-lookup"><span data-stu-id="d4b22-124">This property determines the maximum number of messages that are placed into a batch.</span></span> <span data-ttu-id="d4b22-125">Quando questo numero viene raggiunto, il sistema esegue il commit del batch.</span><span class="sxs-lookup"><span data-stu-id="d4b22-125">When this number is reached, the batch is committed.</span></span> <span data-ttu-id="d4b22-126">Questo valore non rappresenta un limite rigido: è infatti possibile eseguire il commit di un batch prima che venga raggiunto il numero specificato di messaggi.</span><span class="sxs-lookup"><span data-stu-id="d4b22-126">This is value is not a strict limit, it is possible to commit a batch before receiving this number of messages.</span></span>  
  
- <span data-ttu-id="d4b22-127">`Transaction Timeout`.</span><span class="sxs-lookup"><span data-stu-id="d4b22-127">`Transaction Timeout`.</span></span> <span data-ttu-id="d4b22-128">Dopo aver atteso per un periodo di tempo corrispondente all'80% del timeout della transazione, il sistema esegue il commit del batch e ne crea uno nuovo.</span><span class="sxs-lookup"><span data-stu-id="d4b22-128">After 80 percent of the transaction's time-out has elapsed, the batch is committed and a new batch is created.</span></span> <span data-ttu-id="d4b22-129">Ciò significa che se resta il 20% o meno del tempo previsto per il completamento della transazione, il sistema esegue il commit del batch.</span><span class="sxs-lookup"><span data-stu-id="d4b22-129">This means that if 20 percent or less of the time given for a transaction to complete remains, the batch is committed.</span></span>  
  
- <span data-ttu-id="d4b22-130">`TransactionScopeRequired`.</span><span class="sxs-lookup"><span data-stu-id="d4b22-130">`TransactionScopeRequired`.</span></span> <span data-ttu-id="d4b22-131">Quando si elabora un batch di messaggi, se WCF ne trova uno `TransactionScopeRequired`  =  `false` con, esegue il commit del batch e riapre un nuovo batch alla ricezione del primo messaggio con `TransactionScopeRequired`  =  `true` e `TransactionAutoComplete`  =  `true` .</span><span class="sxs-lookup"><span data-stu-id="d4b22-131">When processing a batch of messages, if WCF finds one that has `TransactionScopeRequired` = `false`, it commits the batch and reopens a new batch on receipt of the first message with `TransactionScopeRequired` = `true` and `TransactionAutoComplete` = `true`.</span></span>  
  
- <span data-ttu-id="d4b22-132">Se nella coda non esistono più messaggi, il sistema esegue il commit del batch corrente. Ciò si verifica anche se non è stato raggiunto il limite `MaxBatchSize` e se non è trascorso l'80% del timeout della transazione.</span><span class="sxs-lookup"><span data-stu-id="d4b22-132">If no more messages exist in the queue, then the current batch is committed, even if the `MaxBatchSize` has not been reached or 80 percent of the transaction's time-out has not elapsed.</span></span>  
  
## <a name="leaving-batching-mode"></a><span data-ttu-id="d4b22-133">Uscita dalla modalità batch</span><span class="sxs-lookup"><span data-stu-id="d4b22-133">Leaving Batching Mode</span></span>  
 <span data-ttu-id="d4b22-134">Se una transazione viene interrotta a causa di un messaggio appartenente a un batch, si verifica la sequenza di eventi seguente:</span><span class="sxs-lookup"><span data-stu-id="d4b22-134">If a message in a batch causes the transaction to abort, the following steps occur:</span></span>  
  
1. <span data-ttu-id="d4b22-135">Viene eseguito il rollback dell'intero batch di messaggi.</span><span class="sxs-lookup"><span data-stu-id="d4b22-135">The entire batch of messages is rolled back.</span></span>  
  
2. <span data-ttu-id="d4b22-136">I messaggi vengono letti uno alla volta fino al superamento di un limite pari al doppio della dimensione massima di batch.</span><span class="sxs-lookup"><span data-stu-id="d4b22-136">Messages are read one at a time until the number of messages read exceeds twice the maximum batch size.</span></span>  
  
3. <span data-ttu-id="d4b22-137">Il sistema passa nuovamente in modalità batch.</span><span class="sxs-lookup"><span data-stu-id="d4b22-137">Batch mode is re-entered.</span></span>  
  
## <a name="choosing-the-batch-size"></a><span data-ttu-id="d4b22-138">Scelta della dimensione di batch</span><span class="sxs-lookup"><span data-stu-id="d4b22-138">Choosing the Batch Size</span></span>  
 <span data-ttu-id="d4b22-139">La dimensione di batch dipende dall'applicazione utilizzata.</span><span class="sxs-lookup"><span data-stu-id="d4b22-139">The size of a batch is application-dependent.</span></span> <span data-ttu-id="d4b22-140">Il metodo empirico è il miglior modo per determinare la dimensione di batch ottimale per l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="d4b22-140">The empirical method is the best way to arrive at an optimal batch size for the application.</span></span> <span data-ttu-id="d4b22-141">La scelta della dimensione di batch deve essere eseguita in base al modello effettivo di distribuzione dell'applicazione utilizzata.</span><span class="sxs-lookup"><span data-stu-id="d4b22-141">It is important to remember when choosing a batch size to choose the size according to your application's actual deployment model.</span></span> <span data-ttu-id="d4b22-142">Ad esempio, si supponga che il modello di distribuzione dell'applicazione preveda un server SLQ in un computer remoto e una transazione che coinvolge sia la coda sia il server SQL. In tal caso, per ottimizzare la scelta della dimensione di batch, è necessario eseguire l'applicazione attenendosi rigidamente alla configurazione appena descritta.</span><span class="sxs-lookup"><span data-stu-id="d4b22-142">For example, when deploying the application, if you need an SQL server on a remote machine and a transaction that spans the queue and the SQL server, then the batch size is best determined by running this exact configuration.</span></span>  
  
## <a name="concurrency-and-batching"></a><span data-ttu-id="d4b22-143">Esecuzione di più batch simultanei</span><span class="sxs-lookup"><span data-stu-id="d4b22-143">Concurrency and Batching</span></span>  
 <span data-ttu-id="d4b22-144">Per aumentare la velocità effettiva è inoltre possibile eseguire più batch contemporaneamente.</span><span class="sxs-lookup"><span data-stu-id="d4b22-144">To increase throughput, you can also have many batches run concurrently.</span></span> <span data-ttu-id="d4b22-145">Per attivare questa funzionalità occorre impostare l'elemento `ConcurrencyMode.Multiple` dell'attributo `ServiceBehaviorAttribute`.</span><span class="sxs-lookup"><span data-stu-id="d4b22-145">By setting `ConcurrencyMode.Multiple` in `ServiceBehaviorAttribute`, you enable concurrent batching.</span></span>  
  
 <span data-ttu-id="d4b22-146">La *limitazione del servizio* è un comportamento del servizio che viene utilizzato per indicare il numero massimo di chiamate simultanee che è possibile eseguire nel servizio.</span><span class="sxs-lookup"><span data-stu-id="d4b22-146">*Service throttling* is a service behavior that is used to indicate how many maximum concurrent calls can be made on the service.</span></span> <span data-ttu-id="d4b22-147">Quando viene utilizzato con la funzionalità di batch, questo numero viene interpretato come numero massimo di batch eseguibili simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="d4b22-147">When used with batching, this is interpreted as how many concurrent batches can be run.</span></span> <span data-ttu-id="d4b22-148">Se la limitazione del servizio non è impostata, WCF imposta come valore predefinito il numero massimo di chiamate simultanee a 16.</span><span class="sxs-lookup"><span data-stu-id="d4b22-148">If the service throttling is not set, WCF defaults the maximum concurrent calls to 16.</span></span> <span data-ttu-id="d4b22-149">Pertanto, se viene aggiunto il comportamento dell'invio in batch per impostazione predefinita, può essere attivo un massimo di 16 batch contemporaneamente.</span><span class="sxs-lookup"><span data-stu-id="d4b22-149">Thus, if batching behavior were added by default, a maximum of 16 batches can be active at the same time.</span></span> <span data-ttu-id="d4b22-150">Le impostazioni della limitazione di servizio e della funzionalità di batch devono essere scelte in base alla capacità del sistema.</span><span class="sxs-lookup"><span data-stu-id="d4b22-150">It is best to tune the service throttling and batching based on your capacity.</span></span> <span data-ttu-id="d4b22-151">Si consideri ad esempio il caso di una coda da 100 messaggi per cui si desidera un batch da 20 messaggi. In tal caso, un limite massimo di chiamate simultanee pari a 16 risulta essere poco conveniente. Infatti, a seconda della velocità effettiva, è possibile che siano attive 16 transazioni. Ovvero, è quasi come non aver attivato la funzionalità di batch.</span><span class="sxs-lookup"><span data-stu-id="d4b22-151">For example, if the queue has 100 messages and a batch of 20 is desired, having the maximum concurrent calls set to 16 is not useful because, depending on throughput, 16 transactions could be active, similar to not having batching turned on.</span></span> <span data-ttu-id="d4b22-152">Pertanto, quando si ottimizzano le prestazioni, è consigliabile evitare batch simultanei oppure utilizzarli impostando correttamente le dimensioni della limitazione di servizio.</span><span class="sxs-lookup"><span data-stu-id="d4b22-152">Therefore, when fine-tuning for performance, either do not have concurrent batching or have concurrent batching with the correct service throttle size.</span></span>  
  
## <a name="batching-and-multiple-endpoints"></a><span data-ttu-id="d4b22-153">Impostazione della dimensione di batch in caso di endpoint multipli</span><span class="sxs-lookup"><span data-stu-id="d4b22-153">Batching and Multiple Endpoints</span></span>  
 <span data-ttu-id="d4b22-154">Un endpoint è costituito da un indirizzo e un contratto.</span><span class="sxs-lookup"><span data-stu-id="d4b22-154">An endpoint is composed of an address and a contract.</span></span> <span data-ttu-id="d4b22-155">È possibile che più endpoint condividano la stessa associazione.</span><span class="sxs-lookup"><span data-stu-id="d4b22-155">There may be multiple endpoints that share the same binding.</span></span> <span data-ttu-id="d4b22-156">In particolare, è possibile che due endpoint condividano la stessa associazione e lo stesso URI (Uniform Resource Identifier) di attesa, ovvero lo stesso indirizzo di coda.</span><span class="sxs-lookup"><span data-stu-id="d4b22-156">It is possible for two endpoints to share the same binding and listen Uniform Resource Identifier (URI), or queue address.</span></span> <span data-ttu-id="d4b22-157">Se due endpoint leggono dalla stessa coda ed entrambi presentano il comportamento di batch transazionale, è possibile che si verifichi un conflitto fra le dimensioni di batch specificate.</span><span class="sxs-lookup"><span data-stu-id="d4b22-157">If two endpoints are reading from the same queue, and transacted batching behavior is added to both endpoints, a conflict in the batch sizes specified could arise.</span></span> <span data-ttu-id="d4b22-158">Per risolvere questo problema è possibile implementare la funzionalità di batch utilizzando la dimensione di batch minore fra quelle specificate nei comportanti di batch transazionale.</span><span class="sxs-lookup"><span data-stu-id="d4b22-158">This is resolved by implementing batching using the minimal batch size specified between the two transacted batching behaviors.</span></span> <span data-ttu-id="d4b22-159">In questo scenario, se uno degli endpoint non specifica la funzionalità di batch transazionale, nessuno dei due endpoint implementa la funzionalità di batch.</span><span class="sxs-lookup"><span data-stu-id="d4b22-159">In this scenario, if one of the endpoints does not specify transacted batching, then both endpoints would not use batching.</span></span>  
  
## <a name="example"></a><span data-ttu-id="d4b22-160">Esempio</span><span class="sxs-lookup"><span data-stu-id="d4b22-160">Example</span></span>  
 <span data-ttu-id="d4b22-161">Nell'esempio seguente viene illustrato come specificare il comportamento `TransactedBatchingBehavior` in un file di configurazione.</span><span class="sxs-lookup"><span data-stu-id="d4b22-161">The following example shows how to specify the `TransactedBatchingBehavior` in a configuration file.</span></span>  
  
```xml  
<behaviors>
  <endpointBehaviors>
    <behavior name="TransactedBatchingBehavior"
              maxBatchSize="100" />
  </endpointBehaviors>
</behaviors>
```  
  
 <span data-ttu-id="d4b22-162">Nell'esempio seguente viene illustrato come specificare il comportamento <xref:System.ServiceModel.Description.TransactedBatchingBehavior> in codice.</span><span class="sxs-lookup"><span data-stu-id="d4b22-162">The following example shows how to specify the <xref:System.ServiceModel.Description.TransactedBatchingBehavior> in code.</span></span>  
  
```csharp
using (ServiceHost serviceHost = new ServiceHost(typeof(OrderProcessorService)))
{
     ServiceEndpoint sep = ServiceHost.AddServiceEndpoint(typeof(IOrderProcessor), new NetMsmqBinding(), "net.msmq://localhost/private/ServiceModelSamplesTransacted");
     sep.Behaviors.Add(new TransactedBatchingBehavior(100));

     // Open the ServiceHost to create listeners and start listening for messages.
    serviceHost.Open();
  
    // The service can now be accessed.
    Console.WriteLine("The service is ready.");
    Console.WriteLine("Press <ENTER> to terminate service.");
    Console.WriteLine();
    Console.ReadLine();
  
    // Close the ServiceHostB to shut down the service.
    serviceHost.Close();
}  
```  
  
## <a name="see-also"></a><span data-ttu-id="d4b22-163">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="d4b22-163">See also</span></span>

- [<span data-ttu-id="d4b22-164">Panoramica delle code</span><span class="sxs-lookup"><span data-stu-id="d4b22-164">Queues Overview</span></span>](queues-overview.md)
- [<span data-ttu-id="d4b22-165">Accodamento in WCF</span><span class="sxs-lookup"><span data-stu-id="d4b22-165">Queuing in WCF</span></span>](queuing-in-wcf.md)
