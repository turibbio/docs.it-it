---
title: Creazione di tracce di codice utente
ms.date: 03/30/2017
ms.assetid: fa54186a-8ffa-4332-b0e7-63867126fd49
ms.openlocfilehash: e8b2031165a83e24ba15a2fcf847a170f47e696a
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/09/2020
ms.locfileid: "84589292"
---
# <a name="emitting-user-code-traces"></a><span data-ttu-id="55255-102">Creazione di tracce di codice utente</span><span class="sxs-lookup"><span data-stu-id="55255-102">Emitting User-Code Traces</span></span>

<span data-ttu-id="55255-103">Oltre ad abilitare la traccia nella configurazione per raccogliere i dati di strumentazione generati da Windows Communication Foundation (WCF), è anche possibile creare tracce a livello di codice nel codice utente.</span><span class="sxs-lookup"><span data-stu-id="55255-103">In addition to enabling tracing in configuration to collect instrumentation data generated by Windows Communication Foundation (WCF), you can also emit traces programmatically in user code.</span></span> <span data-ttu-id="55255-104">In questo modo è possibile creare attivamente dati di strumentazione che possono essere successivamente usati a scopo diagnostico.</span><span class="sxs-lookup"><span data-stu-id="55255-104">In this way, you can proactively create instrumentation data that you can peruse later for diagnostic purpose.</span></span> <span data-ttu-id="55255-105">In questo argomento viene illustrata la procedura da seguire.</span><span class="sxs-lookup"><span data-stu-id="55255-105">This topic discusses how you can do this.</span></span>

<span data-ttu-id="55255-106">Inoltre, l'esempio di [estensione della traccia](../../samples/extending-tracing.md) include tutto il codice illustrato nelle sezioni seguenti.</span><span class="sxs-lookup"><span data-stu-id="55255-106">In addition, the [Extending Tracing](../../samples/extending-tracing.md) sample includes all the code demonstrated in the following sections.</span></span>

## <a name="creating-a-trace-source"></a><span data-ttu-id="55255-107">Creazione di un'origine di traccia</span><span class="sxs-lookup"><span data-stu-id="55255-107">Creating a Trace Source</span></span>

<span data-ttu-id="55255-108">Per creare un'origine di traccia dell'utente è possibile usare il codice seguente.</span><span class="sxs-lookup"><span data-stu-id="55255-108">You can use the following code to create a user trace source.</span></span>

```csharp
TraceSource ts = new TraceSource("myUserTraceSource");
```

## <a name="creating-activities"></a><span data-ttu-id="55255-109">Creazione di attività</span><span class="sxs-lookup"><span data-stu-id="55255-109">Creating Activities</span></span>

<span data-ttu-id="55255-110">Le attività sono unità logiche  di elaborazione.</span><span class="sxs-lookup"><span data-stu-id="55255-110">Activities are logical unit of processing.</span></span> <span data-ttu-id="55255-111">È possibile creare un'attività per ogni unità di elaborazione principale nella quale si desidera raggruppare le tracce.</span><span class="sxs-lookup"><span data-stu-id="55255-111">You can create one activity for each major processing unit in which you want traces to be grouped together.</span></span> <span data-ttu-id="55255-112">È possibile creare, ad esempio, un'attività per ogni richiesta inviata al servizio.</span><span class="sxs-lookup"><span data-stu-id="55255-112">For example, you can create one activity for each request to the service.</span></span> <span data-ttu-id="55255-113">A tale scopo, eseguire i passaggi seguenti.</span><span class="sxs-lookup"><span data-stu-id="55255-113">To do so, perform the following steps.</span></span>

1. <span data-ttu-id="55255-114">Salvare l'ID attività nell'ambito.</span><span class="sxs-lookup"><span data-stu-id="55255-114">Save the activity ID in scope.</span></span>

2. <span data-ttu-id="55255-115">Creare un nuovo ID attività.</span><span class="sxs-lookup"><span data-stu-id="55255-115">Create a new activity ID.</span></span>

3. <span data-ttu-id="55255-116">Eseguire il trasferimento dall'attività nell'ambito alla nuova attività, impostare la nuova attività nell'ambito e creare una traccia di inizio per questa attività.</span><span class="sxs-lookup"><span data-stu-id="55255-116">Transfer from the activity in scope to the new one, set the new activity in scope and emit a start trace for that activity.</span></span>

<span data-ttu-id="55255-117">Nell'esempio di codice seguente viene illustrato come eseguire questa operazione.</span><span class="sxs-lookup"><span data-stu-id="55255-117">The following code demonstrates how to do this.</span></span>

```csharp
Guid oldID = Trace.CorrelationManager.ActivityId;
Guid traceID = Guid.NewGuid();
ts.TraceTransfer(0, "transfer", traceID);
Trace.CorrelationManager.ActivityId = traceID; // Trace is static
ts.TraceEvent(TraceEventType.Start, 0, "Add request");
```

## <a name="emitting-traces-within-a-user-activity"></a><span data-ttu-id="55255-118">Creazione di tracce all'interno di un'attività utente</span><span class="sxs-lookup"><span data-stu-id="55255-118">Emitting Traces within a User Activity</span></span>

<span data-ttu-id="55255-119">Il codice seguente crea tracce all'interno di un'attività utente.</span><span class="sxs-lookup"><span data-stu-id="55255-119">The following code emits traces within a user activity.</span></span>

```csharp
double value1 = 100.00D;
double value2 = 15.99D;
ts.TraceInformation("Client sends message to Add " + value1 + ", " + value2);
double result = client.Add(value1, value2);
ts.TraceInformation("Client receives Add response '" + result + "'");
```

## <a name="stopping-the-activities"></a><span data-ttu-id="55255-120">Interruzione delle attività</span><span class="sxs-lookup"><span data-stu-id="55255-120">Stopping the Activities</span></span>

<span data-ttu-id="55255-121">Per interrompere le attività, tornare alla vecchia attività, interrompere l'ID dell'attività corrente e reimpostare l'ID della vecchia attività nell'ambito.</span><span class="sxs-lookup"><span data-stu-id="55255-121">To stop the activities, transfer back to the old activity, stop the current activity id, and reset the old activity id in scope.</span></span>

<span data-ttu-id="55255-122">Nell'esempio di codice seguente viene illustrato come eseguire questa operazione.</span><span class="sxs-lookup"><span data-stu-id="55255-122">The following code demonstrates how to do this.</span></span>

```csharp
ts.TraceTransfer(0, "transfer", oldID);
ts.TraceEvent(TraceEventType.Stop, 0, "Add request");
Trace.CorrelationManager.ActivityId = oldID;
```

## <a name="propagating-the-activity-id-to-a-service"></a><span data-ttu-id="55255-123">Propagazione dell'ID attività a un servizio</span><span class="sxs-lookup"><span data-stu-id="55255-123">Propagating the Activity ID to A Service</span></span>

<span data-ttu-id="55255-124">Se si imposta l'attributo `propagateActivity` su `true` per l'origine di traccia `System.ServiceModel` in entrambi i file di configurazione del client e del servizio, l'elaborazione del servizio per la richiesta Add si verifica nella stessa attività definita nel client.</span><span class="sxs-lookup"><span data-stu-id="55255-124">If you set the `propagateActivity` attribute to `true` for the `System.ServiceModel` trace source in both the client and service configuration files, the service processing for the Add request occurs in the same activity as the one defined in the client.</span></span> <span data-ttu-id="55255-125">Se il servizio definisce attività e trasferimenti specifici, le tracce del servizio non vengono visualizzate nell'attività propagata dal client.</span><span class="sxs-lookup"><span data-stu-id="55255-125">If the service defines its own activities and transfers, the service traces do not appear in the client-propagated activity.</span></span> <span data-ttu-id="55255-126">Vengono invece visualizzate in un'attività correlata mediante tracce di trasferimento all'attività il cui ID viene propagato dal client.</span><span class="sxs-lookup"><span data-stu-id="55255-126">Instead, they appear in an activity correlated by transfer traces to the activity whose ID is propagated by the client.</span></span>

> [!NOTE]
> <span data-ttu-id="55255-127">Se l' `propagateActivity` attributo è impostato `true` su sia nel client che nel servizio, l'attività di ambiente nell'ambito dell'operazione del servizio viene impostata da WCF.</span><span class="sxs-lookup"><span data-stu-id="55255-127">If the `propagateActivity` attribute is set to `true` on both the client and service, the ambient activity in the operation scope of the service is set by WCF.</span></span>

<span data-ttu-id="55255-128">È possibile utilizzare il codice seguente per verificare se un'attività è stata impostata nell'ambito da WCF.</span><span class="sxs-lookup"><span data-stu-id="55255-128">You can use the following code to check whether an activity was set in scope by WCF.</span></span>

```csharp
// Check if an activity was set in scope by WCF, if it was
// propagated from the client. If not, ( ambient activity is
// equal to Guid.Empty), create a new one.
if(Trace.CorrelationManager.ActivityId == Guid.Empty)
{
    Guid newGuid = Guid.NewGuid();
    Trace.CorrelationManager.ActivityId = newGuid;
}
// Emit your Start trace.
ts.TraceEvent(TraceEventType.Start, 0, "Add Activity");

// Emit the processing traces for that request.
serviceTs.TraceInformation("Service receives Add "
                            + n1 + ", " + n2);
// double result = n1 + n2;
serviceTs.TraceInformation("Service sends Add result" + result);

// Emit the Stop trace and exit the method scope.
ts.TraceEvent(TraceEventType.Stop, 0, "Add Activity");
// return result;
```

## <a name="tracing-exceptions-thrown-in-code"></a><span data-ttu-id="55255-129">Eccezioni di traccia generate nel codice</span><span class="sxs-lookup"><span data-stu-id="55255-129">Tracing Exceptions Thrown in Code</span></span>

<span data-ttu-id="55255-130">Quando si genera un'eccezione nel codice, è anche possibile tracciare l'eccezione a livello di avviso o a un livello superiore usando il codice seguente.</span><span class="sxs-lookup"><span data-stu-id="55255-130">When you throw an exception in code, you can also trace the exception at Warning level or up using the following code.</span></span>

```csharp
ts.TraceEvent(TraceEventType.Warning, 0, "Throwing exception " + "exceptionMessage");
```

## <a name="viewing-user-traces-in-the-service-trace-viewer-tool"></a><span data-ttu-id="55255-131">Visualizzazione di tracce utente nello strumento di visualizzazione delle tracce dei servizi</span><span class="sxs-lookup"><span data-stu-id="55255-131">Viewing User Traces in the Service Trace Viewer Tool</span></span>

<span data-ttu-id="55255-132">In questa sezione sono contenute le schermate delle tracce generate eseguendo l'esempio di [estensione della traccia](../../samples/extending-tracing.md) , quando vengono visualizzate tramite lo [strumento Visualizzatore di tracce dei servizi (SvcTraceViewer. exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span><span class="sxs-lookup"><span data-stu-id="55255-132">This section contains screenshots of traces generated by running the [Extending Tracing](../../samples/extending-tracing.md) sample, when viewed using the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span></span>

<span data-ttu-id="55255-133">Nel diagramma seguente l'attività "Aggiungi richiesta" creata in precedenza è selezionata nel riquadro sinistro.</span><span class="sxs-lookup"><span data-stu-id="55255-133">In the following diagram, the "Add request" activity created previously is selected on the left panel.</span></span> <span data-ttu-id="55255-134">L'attività è riportata insieme ad attività di operazioni matematiche (Divide, Subtract, Multiply) che costituiscono l'applicazione client.</span><span class="sxs-lookup"><span data-stu-id="55255-134">It is listed with three other Math operation activities (Divide, Subtract, Multiply) that constitute the application client program.</span></span> <span data-ttu-id="55255-135">Il codice utente ha definito una nuova attività per consentire a ogni operazione di isolare potenziali occorrenze di errore in richieste diverse.</span><span class="sxs-lookup"><span data-stu-id="55255-135">The user code has defined one new activity for each operation to isolate potential error occurrences in different requests.</span></span>

<span data-ttu-id="55255-136">Per illustrare l'utilizzo dei trasferimenti nell'esempio [Extending Tracing](../../samples/extending-tracing.md) , viene creata anche un'attività Calculator che incapsula le quattro richieste di operazione.</span><span class="sxs-lookup"><span data-stu-id="55255-136">To demonstrate the use of transfers in the [Extending Tracing](../../samples/extending-tracing.md) sample, a Calculator activity that encapsulates the four operation requests is also created.</span></span> <span data-ttu-id="55255-137">Per ogni richiesta si verifica un trasferimento dall'attività di calcolo all'attività di richiesta e viceversa (nella figura la traccia è evidenziata nel riquadro in alto a destra).</span><span class="sxs-lookup"><span data-stu-id="55255-137">For each request, there is a transfer back and forth from the Calculator activity to the request activity (trace is highlighted in the upper right panel in the figure).</span></span>

<span data-ttu-id="55255-138">Quando si seleziona un'attività nel riquadro sinistro, le tracce incluse da questa attività vengono mostrate nel riquadro in alto a destra.</span><span class="sxs-lookup"><span data-stu-id="55255-138">When you select an activity on the left panel, the traces included by this activity are shown on the upper right panel.</span></span> <span data-ttu-id="55255-139">Se `propagateActivity` si trova `true` a ogni endpoint nel percorso della richiesta, le tracce nell'attività di richiesta proverranno da tutti i processi che partecipano alla richiesta.</span><span class="sxs-lookup"><span data-stu-id="55255-139">If `propagateActivity` is `true` at every endpoint in the request path, traces in the request activity are from all processes that participate in the request.</span></span> <span data-ttu-id="55255-140">In questo esempio, nella quarta colonna del riquadro sono visualizzate tracce relative a entrambi il client e il servizio.</span><span class="sxs-lookup"><span data-stu-id="55255-140">In this example, you can see traces from both the client and service in the 4th column in the panel.</span></span>

<span data-ttu-id="55255-141">Questa attività mostra l'ordine di elaborazione seguente:</span><span class="sxs-lookup"><span data-stu-id="55255-141">This activity shows the following order of processing:</span></span>

1. <span data-ttu-id="55255-142">Il client invia un messaggio alla richiesta Add.</span><span class="sxs-lookup"><span data-stu-id="55255-142">Client sends message to Add.</span></span>

2. <span data-ttu-id="55255-143">Il servizio riceve il messaggio di richiesta Add.</span><span class="sxs-lookup"><span data-stu-id="55255-143">Service receives Add request message.</span></span>

3. <span data-ttu-id="55255-144">Il servizio invia la risposta Add.</span><span class="sxs-lookup"><span data-stu-id="55255-144">Service sends Add response.</span></span>

4. <span data-ttu-id="55255-145">Il client riceve la risposta Add.</span><span class="sxs-lookup"><span data-stu-id="55255-145">Client receives Add response.</span></span>

<span data-ttu-id="55255-146">Tutte queste tracce vengono create a livello di informazioni.</span><span class="sxs-lookup"><span data-stu-id="55255-146">All these traces were emitted at Information level.</span></span> <span data-ttu-id="55255-147">Facendo clic su una traccia nel riquadro in alto a destra è possibile visualizzare i dettagli della traccia nel riquadro in basso a destra.</span><span class="sxs-lookup"><span data-stu-id="55255-147">Clicking a trace in the upper-right panel shows the details of that trace in the lower-right panel.</span></span>

<span data-ttu-id="55255-148">Nel diagramma seguente è inoltre possibile vedere tracce di trasferimento da e verso l'attività di calcolo, nonché due coppie di tracce Start e Stop per ogni attività di richiesta, una per il client e una per il servizio (una per ogni origine di traccia).</span><span class="sxs-lookup"><span data-stu-id="55255-148">In the following diagram, we also see transfer traces from and to the Calculator activity, as well as two pairs of Start and Stop traces per request activity, one for the client and one for the service (one for each trace source).</span></span>

<span data-ttu-id="55255-149">![Visualizzatore di tracce: creazione di tracce di codice&#45;utente](media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd") Elenco di attività in base all'ora di creazione (riquadro sinistro) e alle relative attività annidate (riquadro superiore destro)</span><span class="sxs-lookup"><span data-stu-id="55255-149">![Trace Viewer: Emitting User&#45;code traces](media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd") List of activities by creation time (left panel) and their nested activities (upper-right panel)</span></span>

<span data-ttu-id="55255-150">Se il codice del servizio genera un'eccezione che determina a sua volta la generazione di un'eccezione nel client (ad esempio, quando il client non ha ottenuto la risposta alla richiesta), entrambi i messaggi di errore o di avviso del client e del servizio vengono restituiti nella stessa attività per correlazione diretta.</span><span class="sxs-lookup"><span data-stu-id="55255-150">If the service code throws an exception that causes the client to throw as well (for example, when the client did not get the response to its request), both the service and client warning or error messages occur in the same activity for direct correlation.</span></span> <span data-ttu-id="55255-151">Nell'immagine seguente il servizio genera un'eccezione che indica "il servizio rifiuta di elaborare la richiesta nel codice utente".</span><span class="sxs-lookup"><span data-stu-id="55255-151">In the following image, the service throws an exception that states "The service refuses to process this request in user code."</span></span> <span data-ttu-id="55255-152">Il client genera inoltre un'eccezione che indica che il server non è stato in grado di elaborare la richiesta a causa di un errore interno.</span><span class="sxs-lookup"><span data-stu-id="55255-152">The client also throws an exception that states "The server was unable to process the request due to an internal error."</span></span>

<span data-ttu-id="55255-153">Le immagini seguenti mostrano che gli errori tra gli endpoint per una determinata richiesta vengono visualizzati nella stessa attività se l'ID attività della richiesta è stato propagato:</span><span class="sxs-lookup"><span data-stu-id="55255-153">The following images shows that errors across endpoints for a given request appear in the same activity if the request activity id was propagated:</span></span>

![Screenshot che Mostra gli errori tra gli endpoint per una determinata richiesta.](./media/emitting-user-code-traces/trace-viewer-endpoint-errors.gif)

<span data-ttu-id="55255-155">Facendo doppio clic sull'attività Multiply nel riquadro sinistro è possibile visualizzare il grafico seguente, con le tracce relative all'attività Multiply per ogni processo coinvolto.</span><span class="sxs-lookup"><span data-stu-id="55255-155">Double-clicking the Multiply activity on the left panel shows the following graph, with the traces for the Multiply activity for each process involved.</span></span> <span data-ttu-id="55255-156">Si può notare un avviso verificatosi inizialmente nel servizio (eccezione generata), seguito da avvisi ed errori nel client in quanto la richiesta non è stata elaborata.</span><span class="sxs-lookup"><span data-stu-id="55255-156">We can see a warning first occurred at the service (exception thrown), which is followed by warnings and errors on the client because the request could not be processed.</span></span> <span data-ttu-id="55255-157">Si può pertanto presupporre la relazione di errore causale tra gli endpoint e derivare la causa radice dell'errore.</span><span class="sxs-lookup"><span data-stu-id="55255-157">Therefore, we can imply the causal error relationship between endpoints and derive the root cause of the error.</span></span>

<span data-ttu-id="55255-158">La figura seguente mostra una visualizzazione grafico della correlazione degli errori:</span><span class="sxs-lookup"><span data-stu-id="55255-158">The following image shows a graph view of error correlation:</span></span>

![Screenshot che mostra la visualizzazione grafico della correlazione degli errori.](./media/emitting-user-code-traces/trace-viewer-error-correlation.gif)

<span data-ttu-id="55255-160">Per ottenere le tracce precedenti è stato impostato `ActivityTracing` per le origini di traccia dell'utente e `propagateActivity=true` per l'origine di traccia `System.ServiceModel`.</span><span class="sxs-lookup"><span data-stu-id="55255-160">To obtain the previous traces, we set `ActivityTracing` for the user trace sources and `propagateActivity=true` for the `System.ServiceModel` trace source.</span></span> <span data-ttu-id="55255-161">Non è stato impostato `ActivityTracing` per l'origine di traccia `System.ServiceModel` per attivare la propagazione di attività codice utente-codice utente.</span><span class="sxs-lookup"><span data-stu-id="55255-161">We did not set `ActivityTracing` for the `System.ServiceModel` trace source to enable user code to user code activity propagation.</span></span> <span data-ttu-id="55255-162">Quando la traccia attività ServiceModel è attiva, l'ID attività definito nel client non viene propagato fino al codice utente del servizio. I trasferimenti, tuttavia, mettono in correlazione le attività del client e del codice utente del servizio alle attività WCF intermedie.</span><span class="sxs-lookup"><span data-stu-id="55255-162">(When ServiceModel activity tracing is on, the activity ID defined in the client is not propagated all the way to the service user code; Transfers, however, correlate the client and service user code activities to the intermediate WCF activities.)</span></span>

<span data-ttu-id="55255-163">La definizione delle attività e la propagazione dell'ID attività consentono di eseguire la correlazione diretta degli errori sui vari endpoint.</span><span class="sxs-lookup"><span data-stu-id="55255-163">Defining activities and propagating the activity ID enables us to perform direct error correlation across endpoints.</span></span> <span data-ttu-id="55255-164">In questo modo è possibile individuare più rapidamente la causa radice di un errore.</span><span class="sxs-lookup"><span data-stu-id="55255-164">In this way, we can locate the root cause of an error more quickly.</span></span>

## <a name="see-also"></a><span data-ttu-id="55255-165">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="55255-165">See also</span></span>

- [<span data-ttu-id="55255-166">Estensione della funzionalità di traccia</span><span class="sxs-lookup"><span data-stu-id="55255-166">Extending Tracing</span></span>](../../samples/extending-tracing.md)
