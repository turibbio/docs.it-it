---
title: Configurazione di un ambiente di profilatura
ms.date: 03/30/2017
helpviewer_keywords:
- environment variables, profiling API
- profiling API [.NET Framework], setting up environment
- COR_PROFILER environment variable
- Windows Service applications, profiling
- profiling API [.NET Framework], Windows Service applications
- COR_ENABLE_PROFILING environment variable
- profiling API [.NET Framework], enabling
ms.assetid: fefca07f-7555-4e77-be86-3c542e928312
ms.openlocfilehash: adf790e0b2d2b72b5a1f0b2a41b80db6d5026869
ms.sourcegitcommit: da21fc5a8cce1e028575acf31974681a1bc5aeed
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/08/2020
ms.locfileid: "84494020"
---
# <a name="setting-up-a-profiling-environment"></a><span data-ttu-id="f38d5-102">Configurazione di un ambiente di profilatura</span><span class="sxs-lookup"><span data-stu-id="f38d5-102">Setting Up a Profiling Environment</span></span>
> [!NOTE]
> <span data-ttu-id="f38d5-103">Sono state apportate modifiche sostanziali alla profilatura nell'.NET Framework 4.</span><span class="sxs-lookup"><span data-stu-id="f38d5-103">There have been substantial changes to profiling in the .NET Framework 4.</span></span>  
  
 <span data-ttu-id="f38d5-104">Quando viene avviato un processo gestito (applicazione o servizio), viene caricato Common Language Runtime (CLR).</span><span class="sxs-lookup"><span data-stu-id="f38d5-104">When a managed process (application or service) starts, it loads the common language runtime (CLR).</span></span> <span data-ttu-id="f38d5-105">Quando CLR viene inizializzato, valuta le due variabili di ambiente seguenti per decidere se è necessario connettere il processo a un profiler:</span><span class="sxs-lookup"><span data-stu-id="f38d5-105">When the CLR is initialized, it evaluates the following two environmental variables to decide whether the process should connect to a profiler:</span></span>  
  
- <span data-ttu-id="f38d5-106">COR_ENABLE_PROFILING: CLR si connette a un profiler solo se questa variabile di ambiente esiste ed è impostata su 1.</span><span class="sxs-lookup"><span data-stu-id="f38d5-106">COR_ENABLE_PROFILING: The CLR connects to a profiler only if this environment variable exists and is set to 1.</span></span>  
  
- <span data-ttu-id="f38d5-107">COR_PROFILER: se si passa il controllo COR_ENABLE_PROFILING, CLR si connette al profiler con questo CLSID o ProgID, che deve essere stato archiviato in precedenza nel Registro di sistema.</span><span class="sxs-lookup"><span data-stu-id="f38d5-107">COR_PROFILER: If the COR_ENABLE_PROFILING check passes, the CLR connects to the profiler that has this CLSID or ProgID, which must have been stored previously in the registry.</span></span> <span data-ttu-id="f38d5-108">La variabile di ambiente COR_PROFILER viene definita come stringa, come mostrato nei due esempi seguenti.</span><span class="sxs-lookup"><span data-stu-id="f38d5-108">The COR_PROFILER environment variable is defined as a string, as shown in the following two examples.</span></span>  
  
    ```cpp  
    set COR_PROFILER={32E2F4DA-1BEA-47ea-88F9-C5DAF691C94A}  
    set COR_PROFILER="MyProfiler"  
    ```  
  
 <span data-ttu-id="f38d5-109">Per profilare un'applicazione CLR, è necessario impostare le variabili di ambiente COR_ENABLE_PROFILING e COR_PROFILER prima di eseguire l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="f38d5-109">To profile a CLR application, you must set the COR_ENABLE_PROFILING and COR_PROFILER environment variables before you run the application.</span></span> <span data-ttu-id="f38d5-110">È anche necessario assicurarsi che il file DLL del profiler sia registrato.</span><span class="sxs-lookup"><span data-stu-id="f38d5-110">You must also make sure that the profiler DLL is registered.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="f38d5-111">A partire da .NET Framework 4, i profiler non devono essere registrati.</span><span class="sxs-lookup"><span data-stu-id="f38d5-111">Starting with the .NET Framework 4, profilers do not have to be registered.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="f38d5-112">Per usare .NET Framework le versioni 2,0, 3,0 e 3,5 dei profiler in .NET Framework 4 e versioni successive, è necessario impostare la variabile di ambiente COMPLUS_ProfAPI_ProfilerCompatibilitySetting.</span><span class="sxs-lookup"><span data-stu-id="f38d5-112">To use .NET Framework versions 2.0, 3.0, and 3.5 profilers in the .NET Framework 4 and later versions, you must set the COMPLUS_ProfAPI_ProfilerCompatibilitySetting environment variable.</span></span>  
  
## <a name="environment-variable-scope"></a><span data-ttu-id="f38d5-113">Ambito della variabile di ambiente</span><span class="sxs-lookup"><span data-stu-id="f38d5-113">Environment Variable Scope</span></span>  
 <span data-ttu-id="f38d5-114">La modalità di impostazione delle variabili di ambiente COR_ENABLE_PROFILING e COR_PROFILER ne determina l'ambito di influenza.</span><span class="sxs-lookup"><span data-stu-id="f38d5-114">How you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables will determine their scope of influence.</span></span> <span data-ttu-id="f38d5-115">È possibile impostare queste variabili in uno dei modi seguenti:</span><span class="sxs-lookup"><span data-stu-id="f38d5-115">You can set these variables in one of the following ways:</span></span>  
  
- <span data-ttu-id="f38d5-116">Se si impostano le variabili in una chiamata [ICorDebug:: CreateProcess](../debugging/icordebug-createprocess-method.md) , verranno applicate solo all'applicazione in esecuzione al momento.</span><span class="sxs-lookup"><span data-stu-id="f38d5-116">If you set the variables in an [ICorDebug::CreateProcess](../debugging/icordebug-createprocess-method.md) call, they will apply only to the application that you are running at the time.</span></span> <span data-ttu-id="f38d5-117">Si applicheranno anche ad altre applicazioni avviate dall'applicazione che eredita l'ambiente.</span><span class="sxs-lookup"><span data-stu-id="f38d5-117">(They will also apply to other applications started by that application that inherit the environment.)</span></span>  
  
- <span data-ttu-id="f38d5-118">Se si impostano le variabili in una finestra del prompt dei comandi, verranno applicate a tutte le applicazioni avviate da questa finestra.</span><span class="sxs-lookup"><span data-stu-id="f38d5-118">If you set the variables in a Command Prompt window, they will apply to all applications that are started from that window.</span></span>  
  
- <span data-ttu-id="f38d5-119">Se le variabili vengono impostate a livello di utente, verranno applicate a tutte le applicazioni avviate con Esplora file.</span><span class="sxs-lookup"><span data-stu-id="f38d5-119">If you set the variables at the user level, they will apply to all applications that you start with File Explorer.</span></span> <span data-ttu-id="f38d5-120">Una finestra del prompt dei comandi aperta dopo aver impostato le variabili avrà queste impostazioni di ambiente, così come tutte le applicazioni avviate da tale finestra.</span><span class="sxs-lookup"><span data-stu-id="f38d5-120">A Command Prompt window that you open after you set the variables will have these environment settings, and so will any application that you start from that window.</span></span> <span data-ttu-id="f38d5-121">Per impostare le variabili di ambiente a livello di utente, fare clic con il pulsante destro del mouse su **computer locale**, scegliere **Proprietà**, fare clic sulla scheda **Avanzate** , quindi su **variabili di ambiente**e aggiungere le variabili all'elenco **variabili utente** .</span><span class="sxs-lookup"><span data-stu-id="f38d5-121">To set environment variables at the user level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, and add the variables to the **User variables** list.</span></span>  
  
- <span data-ttu-id="f38d5-122">Se si impostano le variabili a livello di computer, verranno applicate a tutte le applicazioni avviate su tale computer.</span><span class="sxs-lookup"><span data-stu-id="f38d5-122">If you set the variables at the computer level, they will apply to all applications that are started on that computer.</span></span> <span data-ttu-id="f38d5-123">Una finestra del prompt dei comandi aperta nel computer avrà le impostazioni di ambiente specificate, così come tutte le applicazioni avviate da tale finestra.</span><span class="sxs-lookup"><span data-stu-id="f38d5-123">A Command Prompt window that you open on that computer will have these environment settings, and so will any application that you start from that window.</span></span> <span data-ttu-id="f38d5-124">Ciò significa che ogni processo gestito nel computer verrà avviato con il profiler.</span><span class="sxs-lookup"><span data-stu-id="f38d5-124">This means that every managed process on that computer will start with your profiler.</span></span> <span data-ttu-id="f38d5-125">Per impostare le variabili di ambiente a livello di computer, fare clic con il pulsante destro del mouse su **computer locale**, scegliere **Proprietà**, fare clic sulla scheda **Avanzate** , scegliere **variabili di ambiente**, aggiungere le variabili all'elenco variabili di **sistema** , quindi riavviare il computer.</span><span class="sxs-lookup"><span data-stu-id="f38d5-125">To set environment variables at the computer level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, add the variables to the **System variables** list, and then restart your computer.</span></span> <span data-ttu-id="f38d5-126">Dopo il riavvio le variabili saranno disponibili in tutto il sistema.</span><span class="sxs-lookup"><span data-stu-id="f38d5-126">After restarting, the variables will be available system-wide.</span></span>  
  
 <span data-ttu-id="f38d5-127">Se si esegue la profilatura di un servizio di Windows è necessario riavviare il computer dopo aver impostato le variabili di ambiente e registrare la DLL del profiler.</span><span class="sxs-lookup"><span data-stu-id="f38d5-127">If you are profiling a Windows Service, you must restart your computer after you set the environment variables and register the profiler DLL.</span></span> <span data-ttu-id="f38d5-128">Per ulteriori informazioni su queste considerazioni, vedere la sezione [profiling di un servizio Windows](#windows_service).</span><span class="sxs-lookup"><span data-stu-id="f38d5-128">For more information about these considerations, see the section [Profiling a Windows Service](#windows_service).</span></span>  
  
## <a name="additional-considerations"></a><span data-ttu-id="f38d5-129">Ulteriori considerazioni</span><span class="sxs-lookup"><span data-stu-id="f38d5-129">Additional Considerations</span></span>  
  
- <span data-ttu-id="f38d5-130">La classe profiler implementa le interfacce [ICorProfilerCallback](icorprofilercallback-interface.md) e [ICorProfilerCallback2](icorprofilercallback2-interface.md) .</span><span class="sxs-lookup"><span data-stu-id="f38d5-130">The profiler class implements the [ICorProfilerCallback](icorprofilercallback-interface.md) and [ICorProfilerCallback2](icorprofilercallback2-interface.md) interfaces.</span></span> <span data-ttu-id="f38d5-131">In .NET Framework versione 2.0, un profiler deve implementare `ICorProfilerCallback2`.</span><span class="sxs-lookup"><span data-stu-id="f38d5-131">In the .NET Framework version 2.0, a profiler must implement `ICorProfilerCallback2`.</span></span> <span data-ttu-id="f38d5-132">In caso contrario, `ICorProfilerCallback2` non verrà caricato.</span><span class="sxs-lookup"><span data-stu-id="f38d5-132">If it does not, `ICorProfilerCallback2` will not be loaded.</span></span>  
  
- <span data-ttu-id="f38d5-133">Un processo può essere profilato da un solo profiler in momento e in un ambiente specifici.</span><span class="sxs-lookup"><span data-stu-id="f38d5-133">Only one profiler can profile a process at one time in a given environment.</span></span> <span data-ttu-id="f38d5-134">È possibile registrare due profiler diversi in ambienti diversi, ma ognuno deve profilare processi separati.</span><span class="sxs-lookup"><span data-stu-id="f38d5-134">You can register two different profilers in different environments, but each must profile separate processes.</span></span> <span data-ttu-id="f38d5-135">Il profiler deve essere implementato come file DLL del server COM in-process, mappato allo stesso spazio degli indirizzi del processo che si sta profilando.</span><span class="sxs-lookup"><span data-stu-id="f38d5-135">The profiler must be implemented as an in-process COM server DLL, which is mapped into the same address space as the process that is being profiled.</span></span> <span data-ttu-id="f38d5-136">Ciò significa che il profiler viene eseguito in-process.</span><span class="sxs-lookup"><span data-stu-id="f38d5-136">This means that the profiler runs in-process.</span></span> <span data-ttu-id="f38d5-137">.NET Framework non supporta altri tipi di server COM.</span><span class="sxs-lookup"><span data-stu-id="f38d5-137">The .NET Framework does not support any other type of COM server.</span></span> <span data-ttu-id="f38d5-138">Ad esempio, per monitorare le applicazioni da un computer remoto, il profiler deve implementare agenti di raccolta in ogni computer.</span><span class="sxs-lookup"><span data-stu-id="f38d5-138">For example, if a profiler wants to monitor applications from a remote computer, it must implement collector agents on each computer.</span></span> <span data-ttu-id="f38d5-139">Questi agenti raccolgono i risultati e li comunicano al computer di raccolta dati centrale.</span><span class="sxs-lookup"><span data-stu-id="f38d5-139">These agents will batch results and communicate them to the central data collection computer.</span></span>  
  
- <span data-ttu-id="f38d5-140">Poiché il profiler è un oggetto COM di cui viene creata un'istanza in-process, ogni applicazione profilata disporrà della propria copia del profiler.</span><span class="sxs-lookup"><span data-stu-id="f38d5-140">Because the profiler is a COM object that is instantiated in-process, each profiled application will have its own copy of the profiler.</span></span> <span data-ttu-id="f38d5-141">Pertanto, una singola istanza del profiler non deve gestire i dati da più applicazioni.</span><span class="sxs-lookup"><span data-stu-id="f38d5-141">Therefore, a single profiler instance does not have to handle data from multiple applications.</span></span> <span data-ttu-id="f38d5-142">Tuttavia, sarà necessario aggiungere una logica al codice di registrazione del profiler per impedire che il file di log sia sovrascritto da altre applicazioni profilate.</span><span class="sxs-lookup"><span data-stu-id="f38d5-142">However, you will have to add logic to the profiler's logging code to prevent log file overwrites from other profiled applications.</span></span>  
  
## <a name="initializing-the-profiler"></a><span data-ttu-id="f38d5-143">Inizializzazione del profiler</span><span class="sxs-lookup"><span data-stu-id="f38d5-143">Initializing the Profiler</span></span>  
 <span data-ttu-id="f38d5-144">Quando vengono superati entrambi i controlli delle variabili di ambiente, CLR crea un'istanza del profiler in modo simile alla funzione COM `CoCreateInstance`.</span><span class="sxs-lookup"><span data-stu-id="f38d5-144">When both environment variable checks pass, the CLR creates an instance of the profiler in a similar manner to the COM `CoCreateInstance` function.</span></span> <span data-ttu-id="f38d5-145">Il profiler non viene caricato tramite una chiamata diretta a `CoCreateInstance`.</span><span class="sxs-lookup"><span data-stu-id="f38d5-145">The profiler is not loaded through a direct call to `CoCreateInstance`.</span></span> <span data-ttu-id="f38d5-146">Di conseguenza si evita la chiamata a `CoInitialize`, che richiede l'impostazione del modello di threading.</span><span class="sxs-lookup"><span data-stu-id="f38d5-146">Therefore, a call to `CoInitialize`, which requires setting the threading model, is avoided.</span></span> <span data-ttu-id="f38d5-147">CLR chiama quindi il metodo [ICorProfilerCallback:: Initialize](icorprofilercallback-initialize-method.md) nel profiler.</span><span class="sxs-lookup"><span data-stu-id="f38d5-147">The CLR then calls the [ICorProfilerCallback::Initialize](icorprofilercallback-initialize-method.md) method in the profiler.</span></span> <span data-ttu-id="f38d5-148">La firma di questo metodo è la seguente.</span><span class="sxs-lookup"><span data-stu-id="f38d5-148">The signature of this method is as follows.</span></span>  
  
```cpp  
HRESULT Initialize(IUnknown *pICorProfilerInfoUnk)  
```  
  
 <span data-ttu-id="f38d5-149">Il profiler deve eseguire `pICorProfilerInfoUnk` una query per ottenere un puntatore a interfaccia [ICorProfilerInfo](icorprofilerinfo-interface.md) o [ICorProfilerInfo2](icorprofilerinfo2-interface.md) e salvarlo in modo da poter richiedere altre informazioni successivamente durante la profilatura.</span><span class="sxs-lookup"><span data-stu-id="f38d5-149">The profiler must query `pICorProfilerInfoUnk` for an [ICorProfilerInfo](icorprofilerinfo-interface.md) or [ICorProfilerInfo2](icorprofilerinfo2-interface.md) interface pointer and save it so that it can request more information later during profiling.</span></span>  
  
## <a name="setting-event-notifications"></a><span data-ttu-id="f38d5-150">Impostazione delle notifiche degli eventi</span><span class="sxs-lookup"><span data-stu-id="f38d5-150">Setting Event Notifications</span></span>  
 <span data-ttu-id="f38d5-151">Il profiler chiama quindi il metodo [ICorProfilerInfo:: SetEventMask](icorprofilerinfo-seteventmask-method.md) per specificare le categorie di notifiche a cui è interessato.</span><span class="sxs-lookup"><span data-stu-id="f38d5-151">The profiler then calls the [ICorProfilerInfo::SetEventMask](icorprofilerinfo-seteventmask-method.md) method to specify which categories of notifications it is interested in.</span></span> <span data-ttu-id="f38d5-152">Ad esempio, se il profiler è interessato solo alle notifiche di entrata e uscita dalla funzione e alle notifiche di Garbage Collection, viene specificato quanto segue.</span><span class="sxs-lookup"><span data-stu-id="f38d5-152">For example, if the profiler is interested only in function enter and leave notifications and garbage collection notifications, it specifies the following.</span></span>  
  
```cpp  
ICorProfilerInfo* pInfo;  
pICorProfilerInfoUnk->QueryInterface(IID_ICorProfilerInfo, (void**)&pInfo);  
pInfo->SetEventMask(COR_PRF_MONITOR_ENTERLEAVE | COR_PRF_MONITOR_GC)  
```  
  
 <span data-ttu-id="f38d5-153">Impostando la maschera delle notifiche in questo modo, il profiler può limitare le notifiche ricevute.</span><span class="sxs-lookup"><span data-stu-id="f38d5-153">By setting the notifications mask in this manner, the profiler can limit which notifications it receives.</span></span> <span data-ttu-id="f38d5-154">Questo approccio consente di compilare un profiler semplice o per scopi specifici.</span><span class="sxs-lookup"><span data-stu-id="f38d5-154">This approach helps the user build a simple or special-purpose profiler.</span></span> <span data-ttu-id="f38d5-155">Riduce anche il tempo di CPU che andrebbe sprecato per l'invio di notifiche del tutto ignorate dal profiler.</span><span class="sxs-lookup"><span data-stu-id="f38d5-155">It also reduces CPU time that would be wasted sending notifications that the profiler would just ignore.</span></span>  
  
 <span data-ttu-id="f38d5-156">Alcuni eventi del profiler non sono modificabili.</span><span class="sxs-lookup"><span data-stu-id="f38d5-156">Certain profiler events are immutable.</span></span> <span data-ttu-id="f38d5-157">Ciò significa che, non appena si impostano questi eventi nel callback `ICorProfilerCallback::Initialize`, non è possibile disattivarli, né attivare nuovi eventi.</span><span class="sxs-lookup"><span data-stu-id="f38d5-157">This means that as soon as these events are set in the `ICorProfilerCallback::Initialize` callback, they cannot be turned off and new events cannot be turned on.</span></span> <span data-ttu-id="f38d5-158">Se si tenta di modificare un evento non modificabile, `ICorProfilerInfo::SetEventMask` restituisce un HRESULT di errore.</span><span class="sxs-lookup"><span data-stu-id="f38d5-158">Attempts to change an immutable event will result in `ICorProfilerInfo::SetEventMask` returning a failed HRESULT.</span></span>  
  
<a name="windows_service"></a>
## <a name="profiling-a-windows-service"></a><span data-ttu-id="f38d5-159">Profilatura di un servizio Windows</span><span class="sxs-lookup"><span data-stu-id="f38d5-159">Profiling a Windows Service</span></span>  
 <span data-ttu-id="f38d5-160">La profilatura di un servizio Windows è analoga a quella di un'applicazione Common Language Runtime.</span><span class="sxs-lookup"><span data-stu-id="f38d5-160">Profiling a Windows Service is like profiling a common language runtime application.</span></span> <span data-ttu-id="f38d5-161">Entrambe le operazioni di profilatura vengono abilitate con le variabili di ambiente.</span><span class="sxs-lookup"><span data-stu-id="f38d5-161">Both profiling operations are enabled through environment variables.</span></span> <span data-ttu-id="f38d5-162">Poiché un servizio Windows viene avviato all'avvio del sistema operativo, le variabili di ambiente descritte in precedenza in questo argomento devono essere già presenti e impostate sui valori richiesti.</span><span class="sxs-lookup"><span data-stu-id="f38d5-162">Because a Windows Service is started when the operating system starts, the environment variables discussed previously in this topic must already be present and set to the required values before the system starts.</span></span> <span data-ttu-id="f38d5-163">Inoltre, la DLL di profilatura deve già essere registrata nel sistema.</span><span class="sxs-lookup"><span data-stu-id="f38d5-163">In addition, the profiling DLL must already be registered on the system.</span></span>  
  
 <span data-ttu-id="f38d5-164">Dopo aver impostato le variabili di ambiente COR_ENABLE_PROFILING e COR_PROFILER e aver registrato il file DLL del profiler, è necessario riavviare il computer di destinazione in modo che il servizio Windows possa rilevare le modifiche.</span><span class="sxs-lookup"><span data-stu-id="f38d5-164">After you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables and register the profiler DLL, you should restart the target computer so that the Windows Service can detect those changes.</span></span>  
  
 <span data-ttu-id="f38d5-165">Queste modifiche abiliteranno la profilatura a livello di sistema.</span><span class="sxs-lookup"><span data-stu-id="f38d5-165">Note that these changes will enable profiling on a system-wide basis.</span></span> <span data-ttu-id="f38d5-166">Per evitare la profilatura di tutte le applicazioni gestite eseguite successivamente, è necessario eliminare le variabili di ambiente del sistema dopo aver riavviato il computer di destinazione.</span><span class="sxs-lookup"><span data-stu-id="f38d5-166">To prevent every managed application that subsequently runs from being profiled, you should delete the system environment variables after you restart the target computer.</span></span>  
  
 <span data-ttu-id="f38d5-167">Questa tecnica comporta anche la profilatura di tutti i processi CLR.</span><span class="sxs-lookup"><span data-stu-id="f38d5-167">This technique also leads to every CLR process getting profiled.</span></span> <span data-ttu-id="f38d5-168">Il profiler deve aggiungere la logica al callback [ICorProfilerCallback:: Initialize](icorprofilercallback-initialize-method.md) per rilevare se il processo corrente è di interesse.</span><span class="sxs-lookup"><span data-stu-id="f38d5-168">The profiler should add logic to its [ICorProfilerCallback::Initialize](icorprofilercallback-initialize-method.md) callback to detect whether the current process is of interest.</span></span> <span data-ttu-id="f38d5-169">Se non lo è, il profiler può interrompere il callback senza eseguire l'inizializzazione.</span><span class="sxs-lookup"><span data-stu-id="f38d5-169">If it is not, the profiler can fail the callback without performing the initialization.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="f38d5-170">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="f38d5-170">See also</span></span>

- [<span data-ttu-id="f38d5-171">Panoramica della profilatura</span><span class="sxs-lookup"><span data-stu-id="f38d5-171">Profiling Overview</span></span>](profiling-overview.md)
