---
title: 'Procedura: definire un metodo generico tramite reflection emit'
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- generics [.NET Framework], reflection emit
- reflection emit, generic methods
- generics [.NET Framework], dynamic types
ms.assetid: 93892fa4-90b3-4ec4-b147-4bec9880de2b
ms.openlocfilehash: d16f6728b01583fe3ffb8d892522f3892444c537
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 10/30/2019
ms.locfileid: "73130167"
---
# <a name="how-to-define-a-generic-method-with-reflection-emit"></a><span data-ttu-id="26992-102">Procedura: definire un metodo generico tramite reflection emit</span><span class="sxs-lookup"><span data-stu-id="26992-102">How to: Define a Generic Method with Reflection Emit</span></span>

<span data-ttu-id="26992-103">La prima procedura illustra come creare un metodo generico semplice con due parametri di tipo e come applicare a questi ultimi vincoli speciali, di interfaccia e di classe.</span><span class="sxs-lookup"><span data-stu-id="26992-103">The first procedure shows how to create a simple generic method with two type parameters, and how to apply class constraints, interface constraints, and special constraints to the type parameters.</span></span>

<span data-ttu-id="26992-104">La seconda procedura illustra come creare il corpo del metodo e usare i parametri di tipo del metodo generico per creare istanze di tipi generici e chiamare i relativi metodi.</span><span class="sxs-lookup"><span data-stu-id="26992-104">The second procedure shows how to emit the method body, and how to use the type parameters of the generic method to create instances of generic types and to call their methods.</span></span>

<span data-ttu-id="26992-105">La terza procedura illustra come richiamare il metodo generico.</span><span class="sxs-lookup"><span data-stu-id="26992-105">The third procedure shows how to invoke the generic method.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="26992-106">Un metodo non può essere considerato generico solo perché appartiene a un tipo generico e ne usa i parametri di tipo.</span><span class="sxs-lookup"><span data-stu-id="26992-106">A method is not generic just because it belongs to a generic type and uses the type parameters of that type.</span></span> <span data-ttu-id="26992-107">Per essere generico, un metodo deve avere un elenco specifico di parametri di tipo.</span><span class="sxs-lookup"><span data-stu-id="26992-107">A method is generic only if it has its own type parameter list.</span></span> <span data-ttu-id="26992-108">Un metodo generico può appartenere a un tipo non generico, come nell'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="26992-108">A generic method can appear on a nongeneric type, as in this example.</span></span> <span data-ttu-id="26992-109">Per un esempio di metodo non generico incluso in un tipo generico, vedere [Procedura: Definire un tipo generico tramite reflection emit](how-to-define-a-generic-type-with-reflection-emit.md).</span><span class="sxs-lookup"><span data-stu-id="26992-109">For an example of a nongeneric method on a generic type, see [How to: Define a Generic Type with Reflection Emit](how-to-define-a-generic-type-with-reflection-emit.md).</span></span>

### <a name="to-define-a-generic-method"></a><span data-ttu-id="26992-110">Per definire un metodo generico</span><span class="sxs-lookup"><span data-stu-id="26992-110">To define a generic method</span></span>

1. <span data-ttu-id="26992-111">Prima di iniziare, può essere utile esaminare un metodo generico scritto con un linguaggio di alto livello.</span><span class="sxs-lookup"><span data-stu-id="26992-111">Before beginning, it is useful to look at how the generic method appears when written using a high-level language.</span></span> <span data-ttu-id="26992-112">Il codice seguente è incluso nel codice di esempio di questo argomento insieme al codice usato per chiamare il metodo generico.</span><span class="sxs-lookup"><span data-stu-id="26992-112">The following code is included in the example code for this topic, along with code to call the generic method.</span></span> <span data-ttu-id="26992-113">Il metodo ha due parametri di tipo, `TInput` e `TOutput`, il secondo dei quali deve essere un tipo di riferimento (`class`), deve avere un costruttore senza parametri (`new`) e deve implementare `ICollection(Of TInput)` (`ICollection<TInput>` in C#).</span><span class="sxs-lookup"><span data-stu-id="26992-113">The method has two type parameters, `TInput` and `TOutput`, the second of which must be a reference type (`class`), must have a parameterless constructor (`new`), and must implement `ICollection(Of TInput)` (`ICollection<TInput>` in C#).</span></span> <span data-ttu-id="26992-114">Questo vincolo di interfaccia garantisce la possibilità di usare il metodo <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> per aggiungere elementi all'insieme `TOutput` creato dal metodo.</span><span class="sxs-lookup"><span data-stu-id="26992-114">This interface constraint ensures that the <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> method can be used to add elements to the `TOutput` collection that the method creates.</span></span> <span data-ttu-id="26992-115">Il metodo ha un unico parametro formale, `input`, che è una matrice di `TInput`.</span><span class="sxs-lookup"><span data-stu-id="26992-115">The method has one formal parameter, `input`, which is an array of `TInput`.</span></span> <span data-ttu-id="26992-116">Il metodo crea un insieme di tipo `TOutput` e copia gli elementi di `input` nell'insieme.</span><span class="sxs-lookup"><span data-stu-id="26992-116">The method creates a collection of type `TOutput` and copies the elements of `input` to the collection.</span></span>

    [!code-csharp[GenericMethodHowTo#20](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#20)]
    [!code-vb[GenericMethodHowTo#20](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#20)]

2. <span data-ttu-id="26992-117">Definire un assembly dinamico e un modulo dinamico per contenere il tipo a cui appartiene il metodo generico.</span><span class="sxs-lookup"><span data-stu-id="26992-117">Define a dynamic assembly and a dynamic module to contain the type the generic method belongs to.</span></span> <span data-ttu-id="26992-118">In questo caso l'assembly ha un unico modulo denominato `DemoMethodBuilder1` il cui nome corrisponde a quello dell'assembly seguito da un'estensione.</span><span class="sxs-lookup"><span data-stu-id="26992-118">In this case, the assembly has only one module, named `DemoMethodBuilder1`, and the module name is the same as the assembly name plus an extension.</span></span> <span data-ttu-id="26992-119">In questo esempio l'assembly viene salvato su disco e anche eseguito, pertanto è specificato <xref:System.Reflection.Emit.AssemblyBuilderAccess.RunAndSave?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="26992-119">In this example, the assembly is saved to disk and also executed, so <xref:System.Reflection.Emit.AssemblyBuilderAccess.RunAndSave?displayProperty=nameWithType> is specified.</span></span> <span data-ttu-id="26992-120">È possibile usare lo strumento [Ildasm.exe (IL Disassembler)](../tools/ildasm-exe-il-disassembler.md) per esaminare DemoMethodBuilder1.dll ed eseguirne un confronto con il codice Microsoft Intermediate Language (MSIL) relativo al metodo illustrato nel primo passaggio 1.</span><span class="sxs-lookup"><span data-stu-id="26992-120">You can use the [Ildasm.exe (IL Disassembler)](../tools/ildasm-exe-il-disassembler.md) to examine DemoMethodBuilder1.dll and to compare it to the Microsoft intermediate language (MSIL) for the method shown in step 1.</span></span>

    [!code-csharp[GenericMethodHowTo#2](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#2)]
    [!code-vb[GenericMethodHowTo#2](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#2)]

3. <span data-ttu-id="26992-121">Definire il tipo che a cui appartiene il metodo generico.</span><span class="sxs-lookup"><span data-stu-id="26992-121">Define the type the generic method belongs to.</span></span> <span data-ttu-id="26992-122">Il tipo non deve essere necessariamente generico.</span><span class="sxs-lookup"><span data-stu-id="26992-122">The type does not have to be generic.</span></span> <span data-ttu-id="26992-123">Un metodo generico può infatti appartenere a un tipo generico o non generico.</span><span class="sxs-lookup"><span data-stu-id="26992-123">A generic method can belong to either a generic or nongeneric type.</span></span> <span data-ttu-id="26992-124">In questo esempio il tipo è una classe, non è generico ed è denominato `DemoType`.</span><span class="sxs-lookup"><span data-stu-id="26992-124">In this example, the type is a class, is not generic, and is named `DemoType`.</span></span>

    [!code-csharp[GenericMethodHowTo#3](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#3)]
    [!code-vb[GenericMethodHowTo#3](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#3)]

4. <span data-ttu-id="26992-125">Definire il metodo generico.</span><span class="sxs-lookup"><span data-stu-id="26992-125">Define the generic method.</span></span> <span data-ttu-id="26992-126">Se i tipi dei parametri formali di un metodo generico sono specificati dai parametri di tipo generico di tale metodo, usare l'overload del metodo <xref:System.Reflection.Emit.TypeBuilder.DefineMethod%28System.String%2CSystem.Reflection.MethodAttributes%29> per definire il metodo.</span><span class="sxs-lookup"><span data-stu-id="26992-126">If the types of a generic method's formal parameters are specified by generic type parameters of the generic method, use the <xref:System.Reflection.Emit.TypeBuilder.DefineMethod%28System.String%2CSystem.Reflection.MethodAttributes%29> method overload to define the method.</span></span> <span data-ttu-id="26992-127">I parametri di tipo generico del metodo non sono ancora definiti e non è pertanto possibile specificare i tipi dei parametri formali del metodo nella chiamata a <xref:System.Reflection.Emit.TypeBuilder.DefineMethod%2A>.</span><span class="sxs-lookup"><span data-stu-id="26992-127">The generic type parameters of the method are not yet defined, so you cannot specify the types of the method's formal parameters in the call to <xref:System.Reflection.Emit.TypeBuilder.DefineMethod%2A>.</span></span> <span data-ttu-id="26992-128">In questo esempio il metodo è denominato `Factory`,</span><span class="sxs-lookup"><span data-stu-id="26992-128">In this example, the method is named `Factory`.</span></span> <span data-ttu-id="26992-129">è pubblico e `static` (`Shared` in Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="26992-129">The method is public and `static` (`Shared` in Visual Basic).</span></span>

    [!code-csharp[GenericMethodHowTo#4](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#4)]
    [!code-vb[GenericMethodHowTo#4](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#4)]

5. <span data-ttu-id="26992-130">Definire i parametri di tipo generico di `DemoMethod` passando una matrice di stringhe contenenti i nomi dei parametri al metodo <xref:System.Reflection.Emit.MethodBuilder.DefineGenericParameters%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="26992-130">Define the generic type parameters of `DemoMethod` by passing an array of strings containing the names of the parameters to the <xref:System.Reflection.Emit.MethodBuilder.DefineGenericParameters%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="26992-131">In questo modo si ottiene un metodo generico.</span><span class="sxs-lookup"><span data-stu-id="26992-131">This makes the method a generic method.</span></span> <span data-ttu-id="26992-132">Il codice seguente trasforma `Factory` in un metodo generico con i parametri di tipo `TInput` e `TOutput`.</span><span class="sxs-lookup"><span data-stu-id="26992-132">The following code makes `Factory` a generic method with type parameters `TInput` and `TOutput`.</span></span> <span data-ttu-id="26992-133">Per migliorare la leggibilità del codice, vengono create variabili con questi nomi per contenere gli oggetti <xref:System.Reflection.Emit.GenericTypeParameterBuilder> che rappresentano i due parametri di tipo.</span><span class="sxs-lookup"><span data-stu-id="26992-133">To make the code easier to read, variables with these names are created to hold the <xref:System.Reflection.Emit.GenericTypeParameterBuilder> objects representing the two type parameters.</span></span>

    [!code-csharp[GenericMethodHowTo#5](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#5)]
    [!code-vb[GenericMethodHowTo#5](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#5)]

6. <span data-ttu-id="26992-134">Facoltativamente, aggiungere vincoli speciali ai parametri di tipo.</span><span class="sxs-lookup"><span data-stu-id="26992-134">Optionally add special constraints to the type parameters.</span></span> <span data-ttu-id="26992-135">I vincoli speciali vengono aggiunti usando il metodo <xref:System.Reflection.Emit.GenericTypeParameterBuilder.SetGenericParameterAttributes%2A>.</span><span class="sxs-lookup"><span data-stu-id="26992-135">Special constraints are added using the <xref:System.Reflection.Emit.GenericTypeParameterBuilder.SetGenericParameterAttributes%2A> method.</span></span> <span data-ttu-id="26992-136">In questo esempio `TOutput` deve essere un tipo di riferimento e deve avere un costruttore senza parametri.</span><span class="sxs-lookup"><span data-stu-id="26992-136">In this example, `TOutput` is constrained to be a reference type and to have a parameterless constructor.</span></span>

    [!code-csharp[GenericMethodHowTo#6](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#6)]
    [!code-vb[GenericMethodHowTo#6](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#6)]

7. <span data-ttu-id="26992-137">Facoltativamente, aggiungere vincoli di interfaccia e di classe ai parametri di tipo.</span><span class="sxs-lookup"><span data-stu-id="26992-137">Optionally add class and interface constraints to the type parameters.</span></span> <span data-ttu-id="26992-138">In questo esempio il parametro di tipo `TOutput` è vincolato a tipi che implementano l'interfaccia `ICollection(Of TInput)` (`ICollection<TInput>` in C#).</span><span class="sxs-lookup"><span data-stu-id="26992-138">In this example, type parameter `TOutput` is constrained to types that implement the `ICollection(Of TInput)` (`ICollection<TInput>` in C#) interface.</span></span> <span data-ttu-id="26992-139">Questo vincolo garantisce la possibilità di usare il metodo <xref:System.Collections.Generic.ICollection%601.Add%2A> per l'aggiunta di elementi.</span><span class="sxs-lookup"><span data-stu-id="26992-139">This ensures that the <xref:System.Collections.Generic.ICollection%601.Add%2A> method can be used to add elements.</span></span>

    [!code-csharp[GenericMethodHowTo#7](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#7)]
    [!code-vb[GenericMethodHowTo#7](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#7)]

8. <span data-ttu-id="26992-140">Definire i parametri formali del metodo usando il metodo <xref:System.Reflection.Emit.MethodBuilder.SetParameters%2A>.</span><span class="sxs-lookup"><span data-stu-id="26992-140">Define the formal parameters of the method, using the <xref:System.Reflection.Emit.MethodBuilder.SetParameters%2A> method.</span></span> <span data-ttu-id="26992-141">In questo esempio il metodo `Factory` ha un unico parametro, una matrice di `TInput`.</span><span class="sxs-lookup"><span data-stu-id="26992-141">In this example, the `Factory` method has one parameter, an array of `TInput`.</span></span> <span data-ttu-id="26992-142">Il tipo viene creato chiamando il metodo <xref:System.Type.MakeArrayType%2A> in <xref:System.Reflection.Emit.GenericTypeParameterBuilder> che rappresenta `TInput`.</span><span class="sxs-lookup"><span data-stu-id="26992-142">This type is created by calling the <xref:System.Type.MakeArrayType%2A> method on the <xref:System.Reflection.Emit.GenericTypeParameterBuilder> that represents `TInput`.</span></span> <span data-ttu-id="26992-143">L'argomento di <xref:System.Reflection.Emit.MethodBuilder.SetParameters%2A> è una matrice di oggetti <xref:System.Type>.</span><span class="sxs-lookup"><span data-stu-id="26992-143">The argument of <xref:System.Reflection.Emit.MethodBuilder.SetParameters%2A> is an array of <xref:System.Type> objects.</span></span>

    [!code-csharp[GenericMethodHowTo#8](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#8)]
    [!code-vb[GenericMethodHowTo#8](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#8)]

9. <span data-ttu-id="26992-144">Definire il tipo restituito per il metodo usando il metodo <xref:System.Reflection.Emit.MethodBuilder.SetReturnType%2A>.</span><span class="sxs-lookup"><span data-stu-id="26992-144">Define the return type for the method, using the <xref:System.Reflection.Emit.MethodBuilder.SetReturnType%2A> method.</span></span> <span data-ttu-id="26992-145">In questo esempio viene restituita un'istanza di `TOutput`.</span><span class="sxs-lookup"><span data-stu-id="26992-145">In this example, an instance of `TOutput` is returned.</span></span>

    [!code-csharp[GenericMethodHowTo#9](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#9)]
    [!code-vb[GenericMethodHowTo#9](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#9)]

10. <span data-ttu-id="26992-146">Creare il corpo del metodo usando <xref:System.Reflection.Emit.ILGenerator>.</span><span class="sxs-lookup"><span data-stu-id="26992-146">Emit the method body, using <xref:System.Reflection.Emit.ILGenerator>.</span></span> <span data-ttu-id="26992-147">Per informazioni dettagliate, vedere la procedura associata per creare il corpo del metodo.</span><span class="sxs-lookup"><span data-stu-id="26992-147">For details, see the accompanying procedure for emitting the method body.</span></span>

    > [!IMPORTANT]
    > <span data-ttu-id="26992-148">Quando si creano chiamate a metodi di tipi generici e gli argomenti di tipo di questi ultimi sono parametri di tipo del metodo generico, è necessario usare gli overload dei metodi `static`<xref:System.Reflection.Emit.TypeBuilder.GetConstructor%28System.Type%2CSystem.Reflection.ConstructorInfo%29>, <xref:System.Reflection.Emit.TypeBuilder.GetMethod%28System.Type%2CSystem.Reflection.MethodInfo%29> e <xref:System.Reflection.Emit.TypeBuilder.GetField%28System.Type%2CSystem.Reflection.FieldInfo%29> della classe <xref:System.Reflection.Emit.TypeBuilder> per ottenere i formati costruiti dei metodi.</span><span class="sxs-lookup"><span data-stu-id="26992-148">When you emit calls to methods of generic types, and the type arguments of those types are type parameters of the generic method, you must use the `static`<xref:System.Reflection.Emit.TypeBuilder.GetConstructor%28System.Type%2CSystem.Reflection.ConstructorInfo%29>, <xref:System.Reflection.Emit.TypeBuilder.GetMethod%28System.Type%2CSystem.Reflection.MethodInfo%29>, and <xref:System.Reflection.Emit.TypeBuilder.GetField%28System.Type%2CSystem.Reflection.FieldInfo%29> method overloads of the <xref:System.Reflection.Emit.TypeBuilder> class to obtain constructed forms of the methods.</span></span> <span data-ttu-id="26992-149">Questo concetto è illustrato nella procedura associata per la creazione del corpo del metodo.</span><span class="sxs-lookup"><span data-stu-id="26992-149">The accompanying procedure for emitting the method body demonstrates this.</span></span>

11. <span data-ttu-id="26992-150">Completare il tipo contenente il metodo e salvare l'assembly.</span><span class="sxs-lookup"><span data-stu-id="26992-150">Complete the type that contains the method and save the assembly.</span></span> <span data-ttu-id="26992-151">Nella procedura associata per richiamare il metodo generico vengono indicati due modi per richiamare il metodo completato.</span><span class="sxs-lookup"><span data-stu-id="26992-151">The accompanying procedure for invoking the generic method shows two ways to invoke the completed method.</span></span>

    [!code-csharp[GenericMethodHowTo#14](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#14)]
    [!code-vb[GenericMethodHowTo#14](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#14)]

<a name="procedureSection1"></a>

### <a name="to-emit-the-method-body"></a><span data-ttu-id="26992-152">Per creare il corpo del metodo</span><span class="sxs-lookup"><span data-stu-id="26992-152">To emit the method body</span></span>

1. <span data-ttu-id="26992-153">Ottenere un generatore di codice e dichiarare le variabili locali e le etichette.</span><span class="sxs-lookup"><span data-stu-id="26992-153">Get a code generator and declare local variables and labels.</span></span> <span data-ttu-id="26992-154">Per dichiarare le variabili locali viene usato il metodo <xref:System.Reflection.Emit.ILGenerator.DeclareLocal%2A>.</span><span class="sxs-lookup"><span data-stu-id="26992-154">The <xref:System.Reflection.Emit.ILGenerator.DeclareLocal%2A> method is used to declare local variables.</span></span> <span data-ttu-id="26992-155">Il metodo `Factory` ha quattro variabili locali: `retVal` per contenere il nuovo oggetto `TOutput` restituito dal metodo, `ic` per contenere `TOutput` quando ne viene eseguito il cast in `ICollection(Of TInput)` (`ICollection<TInput>` in C#), `input` per contenere la matrice di input di oggetti `TInput` e `index` scorrere la matrice.</span><span class="sxs-lookup"><span data-stu-id="26992-155">The `Factory` method has four local variables: `retVal` to hold the new `TOutput` that is returned by the method, `ic` to hold the `TOutput` when it is cast to `ICollection(Of TInput)` (`ICollection<TInput>` in C#), `input` to hold the input array of `TInput` objects, and `index` to iterate through the array.</span></span> <span data-ttu-id="26992-156">Il metodo ha anche due etichette, una per l'ingresso nel ciclo (`enterLoop`) e una per l'inizio del ciclo (`loopAgain`), definite usando il metodo <xref:System.Reflection.Emit.ILGenerator.DefineLabel%2A>.</span><span class="sxs-lookup"><span data-stu-id="26992-156">The method also has two labels, one to enter the loop (`enterLoop`) and one for the top of the loop (`loopAgain`), defined using the <xref:System.Reflection.Emit.ILGenerator.DefineLabel%2A> method.</span></span>

    <span data-ttu-id="26992-157">La prima operazione eseguita dal metodo consiste nel caricare il relativo argomento mediante il codice operativo <xref:System.Reflection.Emit.OpCodes.Ldarg_0> e nel memorizzarlo nella variabile locale `input` mediante il codice operativo <xref:System.Reflection.Emit.OpCodes.Stloc_S>.</span><span class="sxs-lookup"><span data-stu-id="26992-157">The first thing the method does is to load its argument using <xref:System.Reflection.Emit.OpCodes.Ldarg_0> opcode and to store it in the local variable `input` using <xref:System.Reflection.Emit.OpCodes.Stloc_S> opcode.</span></span>

    [!code-csharp[GenericMethodHowTo#10](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#10)]
    [!code-vb[GenericMethodHowTo#10](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#10)]

2. <span data-ttu-id="26992-158">Creare il codice per generare un'istanza di `TOutput`, usando l'overload di metodo generico del metodo <xref:System.Activator.CreateInstance%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="26992-158">Emit code to create an instance of `TOutput`, using the generic method overload of the <xref:System.Activator.CreateInstance%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="26992-159">Per usare questo overload è necessario che il tipo specificato abbia un costruttore senza parametri. Per questo motivo questo vincolo viene aggiunto a `TOutput`.</span><span class="sxs-lookup"><span data-stu-id="26992-159">Using this overload requires the specified type to have a parameterless constructor, which is the reason for adding that constraint to `TOutput`.</span></span> <span data-ttu-id="26992-160">Creare il metodo generico costruito passando `TOutput` a <xref:System.Reflection.MethodInfo.MakeGenericMethod%2A>.</span><span class="sxs-lookup"><span data-stu-id="26992-160">Create the constructed generic method by passing `TOutput` to <xref:System.Reflection.MethodInfo.MakeGenericMethod%2A>.</span></span> <span data-ttu-id="26992-161">Dopo aver creato il codice per la chiamata al metodo, creare il codice per memorizzarlo nella variabile locale `retVal` usando <xref:System.Reflection.Emit.OpCodes.Stloc_S></span><span class="sxs-lookup"><span data-stu-id="26992-161">After emitting code to call the method, emit code to store it in the local variable `retVal` using <xref:System.Reflection.Emit.OpCodes.Stloc_S></span></span>

    [!code-csharp[GenericMethodHowTo#11](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#11)]
    [!code-vb[GenericMethodHowTo#11](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#11)]

3. <span data-ttu-id="26992-162">Creare il codice per eseguire il cast del nuovo oggetto `TOutput` in `ICollection(Of TInput)` e memorizzarlo nella variabile locale `ic`.</span><span class="sxs-lookup"><span data-stu-id="26992-162">Emit code to cast the new `TOutput` object to `ICollection(Of TInput)` and store it in the local variable `ic`.</span></span>

    [!code-csharp[GenericMethodHowTo#31](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#31)]
    [!code-vb[GenericMethodHowTo#31](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#31)]

4. <span data-ttu-id="26992-163">Ottenere un oggetto <xref:System.Reflection.MethodInfo> che rappresenta il metodo <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="26992-163">Get a <xref:System.Reflection.MethodInfo> representing the <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="26992-164">Poiché il metodo opera su `ICollection(Of TInput)` (`ICollection<TInput>` in C#), è necessario ottenere il metodo `Add` specifico per il tipo costruito.</span><span class="sxs-lookup"><span data-stu-id="26992-164">The method is acting on an `ICollection(Of TInput)` (`ICollection<TInput>` in C#), so it is necessary to get the `Add` method specific to that constructed type.</span></span> <span data-ttu-id="26992-165">Non è possibile usare il metodo <xref:System.Type.GetMethod%2A> per ottenere <xref:System.Reflection.MethodInfo> direttamente da `icollOfTInput`, perché <xref:System.Type.GetMethod%2A> non è supportato su un tipo costruito con un oggetto <xref:System.Reflection.Emit.GenericTypeParameterBuilder>.</span><span class="sxs-lookup"><span data-stu-id="26992-165">You cannot use the <xref:System.Type.GetMethod%2A> method to get this <xref:System.Reflection.MethodInfo> directly from `icollOfTInput`, because <xref:System.Type.GetMethod%2A> is not supported on a type that has been constructed with a <xref:System.Reflection.Emit.GenericTypeParameterBuilder>.</span></span> <span data-ttu-id="26992-166">Chiamare invece <xref:System.Type.GetMethod%2A> su `icoll`, che contiene la definizione di tipo generico per l'interfaccia generica <xref:System.Collections.Generic.ICollection%601>.</span><span class="sxs-lookup"><span data-stu-id="26992-166">Instead, call <xref:System.Type.GetMethod%2A> on `icoll`, which contains the generic type definition for the <xref:System.Collections.Generic.ICollection%601> generic interface.</span></span> <span data-ttu-id="26992-167">Usare quindi il metodo <xref:System.Reflection.Emit.TypeBuilder.GetMethod%28System.Type%2CSystem.Reflection.MethodInfo%29>`static` per produrre l'oggetto <xref:System.Reflection.MethodInfo> per il tipo costruito.</span><span class="sxs-lookup"><span data-stu-id="26992-167">Then use the <xref:System.Reflection.Emit.TypeBuilder.GetMethod%28System.Type%2CSystem.Reflection.MethodInfo%29>`static` method to produce the <xref:System.Reflection.MethodInfo> for the constructed type.</span></span> <span data-ttu-id="26992-168">Questo concetto è illustrato nel codice riportato di seguito.</span><span class="sxs-lookup"><span data-stu-id="26992-168">The following code demonstrates this.</span></span>

    [!code-csharp[GenericMethodHowTo#12](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#12)]
    [!code-vb[GenericMethodHowTo#12](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#12)]

5. <span data-ttu-id="26992-169">Creare il codice per inizializzare la variabile `index` caricando un intero 0 a 32 bit e memorizzandolo nella variabile.</span><span class="sxs-lookup"><span data-stu-id="26992-169">Emit code to initialize the `index` variable, by loading a 32-bit integer 0 and storing it in the variable.</span></span> <span data-ttu-id="26992-170">Creare il codice per la creazione del ramo dell'etichetta `enterLoop`.</span><span class="sxs-lookup"><span data-stu-id="26992-170">Emit code to branch to the label `enterLoop`.</span></span> <span data-ttu-id="26992-171">Poiché si trova all'interno del ciclo, l'etichetta non è ancora contrassegnata.</span><span class="sxs-lookup"><span data-stu-id="26992-171">This label has not yet been marked, because it is inside the loop.</span></span> <span data-ttu-id="26992-172">Il codice per il ciclo verrà creato nel passaggio successivo.</span><span class="sxs-lookup"><span data-stu-id="26992-172">Code for the loop is emitted in the next step.</span></span>

    [!code-csharp[GenericMethodHowTo#32](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#32)]
    [!code-vb[GenericMethodHowTo#32](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#32)]

6. <span data-ttu-id="26992-173">Creare il codice per il ciclo.</span><span class="sxs-lookup"><span data-stu-id="26992-173">Emit code for the loop.</span></span> <span data-ttu-id="26992-174">Il primo passaggio consiste nel contrassegnare l'inizio del ciclo chiamando <xref:System.Reflection.Emit.ILGenerator.MarkLabel%2A> con l'etichetta `loopAgain`.</span><span class="sxs-lookup"><span data-stu-id="26992-174">The first step is to mark the top of the loop, by calling <xref:System.Reflection.Emit.ILGenerator.MarkLabel%2A> with the `loopAgain` label.</span></span> <span data-ttu-id="26992-175">Le istruzioni per la creazione di un ramo che usano l'etichetta passeranno a questo punto del codice.</span><span class="sxs-lookup"><span data-stu-id="26992-175">Branch statements that use the label will now branch to this point in the code.</span></span> <span data-ttu-id="26992-176">Il passaggio successivo prevede l'inserimento nello stack dell'oggetto `TOutput` di cui è stato eseguito il cast in `ICollection(Of TInput)`.</span><span class="sxs-lookup"><span data-stu-id="26992-176">The next step is to push the `TOutput` object, cast to `ICollection(Of TInput)`, onto the stack.</span></span> <span data-ttu-id="26992-177">Questa operazione non deve essere eseguita immediatamente, ma deve comunque essere prevista per la chiamata al metodo `Add`.</span><span class="sxs-lookup"><span data-stu-id="26992-177">It is not needed immediately, but needs to be in position for calling the `Add` method.</span></span> <span data-ttu-id="26992-178">Dopo l'inserimento della matrice di input nello stack è necessario inserire la variabile `index` contenente l'indice corrente nella matrice.</span><span class="sxs-lookup"><span data-stu-id="26992-178">Next the input array is pushed onto the stack, then the `index` variable containing the current index into the array.</span></span> <span data-ttu-id="26992-179">Il codice operativo <xref:System.Reflection.Emit.OpCodes.Ldelem> estrae l'indice e la matrice dallo stack e inserisce l'elemento della matrice indicizzata nello stack.</span><span class="sxs-lookup"><span data-stu-id="26992-179">The <xref:System.Reflection.Emit.OpCodes.Ldelem> opcode pops the index and the array off the stack and pushes the indexed array element onto the stack.</span></span> <span data-ttu-id="26992-180">A questo punto lo stack è pronto per la chiamata al metodo <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> che estrae l'insieme e il nuovo elemento dallo stack e aggiunge il secondo al primo.</span><span class="sxs-lookup"><span data-stu-id="26992-180">The stack is now ready for the call to the <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> method, which pops the collection and the new element off the stack and adds the element to the collection.</span></span>

    <span data-ttu-id="26992-181">La parte del codice rimanente nel ciclo incrementa l'indice e verifica se il ciclo è terminato: l'indice e un intero 1 a 32 bit vengono inseriti nello stack e aggiunti tramite addizione, lasciando la somma risultante nello stack; la somma viene archiviata in `index`.</span><span class="sxs-lookup"><span data-stu-id="26992-181">The rest of the code in the loop increments the index and tests to see whether the loop is finished: The index and a 32-bit integer 1 are pushed onto the stack and added, leaving the sum on the stack; the sum is stored in `index`.</span></span> <span data-ttu-id="26992-182">Per impostare questo punto come punto di ingresso per il ciclo, viene chiamato il metodo <xref:System.Reflection.Emit.ILGenerator.MarkLabel%2A>.</span><span class="sxs-lookup"><span data-stu-id="26992-182"><xref:System.Reflection.Emit.ILGenerator.MarkLabel%2A> is called to set this point as the entry point for the loop.</span></span> <span data-ttu-id="26992-183">L'indice viene nuovamente caricato.</span><span class="sxs-lookup"><span data-stu-id="26992-183">The index is loaded again.</span></span> <span data-ttu-id="26992-184">La matrice di input viene inserita nello stack e viene creato <xref:System.Reflection.Emit.OpCodes.Ldlen> per ottenere la relativa lunghezza.</span><span class="sxs-lookup"><span data-stu-id="26992-184">The input array is pushed on the stack, and <xref:System.Reflection.Emit.OpCodes.Ldlen> is emitted to get its length.</span></span> <span data-ttu-id="26992-185">Per eseguire il confronto tra l'indice e la lunghezza, ora presenti nello stack, viene creato <xref:System.Reflection.Emit.OpCodes.Clt>.</span><span class="sxs-lookup"><span data-stu-id="26992-185">The index and the length are now on the stack, and <xref:System.Reflection.Emit.OpCodes.Clt> is emitted to compare them.</span></span> <span data-ttu-id="26992-186">Se l'indice è minore della lunghezza, <xref:System.Reflection.Emit.OpCodes.Brtrue_S> torna all'inizio del ciclo.</span><span class="sxs-lookup"><span data-stu-id="26992-186">If the index is less than the length, <xref:System.Reflection.Emit.OpCodes.Brtrue_S> branches back to the beginning of the loop.</span></span>

    [!code-csharp[GenericMethodHowTo#13](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#13)]
    [!code-vb[GenericMethodHowTo#13](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#13)]

7. <span data-ttu-id="26992-187">Creare il codice per inserire l'oggetto `TOutput` nello stack e uscire dal metodo.</span><span class="sxs-lookup"><span data-stu-id="26992-187">Emit code to push the `TOutput` object onto the stack and return from the method.</span></span> <span data-ttu-id="26992-188">Entrambe le variabili locali `retVal` e `ic` contengono riferimenti al nuovo `TOutput`; `ic` viene usato solo per accedere al metodo <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="26992-188">The local variables `retVal` and `ic` both contain references to the new `TOutput`; `ic` is used only to access the <xref:System.Collections.Generic.ICollection%601.Add%2A?displayProperty=nameWithType> method.</span></span>

    [!code-csharp[GenericMethodHowTo#33](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#33)]
    [!code-vb[GenericMethodHowTo#33](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#33)]

<a name="procedureSection2"></a>

### <a name="to-invoke-the-generic-method"></a><span data-ttu-id="26992-189">Per richiamare il metodo generico</span><span class="sxs-lookup"><span data-stu-id="26992-189">To invoke the generic method</span></span>

1. <span data-ttu-id="26992-190">`Factory` è una definizione di metodo generico.</span><span class="sxs-lookup"><span data-stu-id="26992-190">`Factory` is a generic method definition.</span></span> <span data-ttu-id="26992-191">Per richiamarla, è necessario assegnare tipi ai parametri di tipo generico.</span><span class="sxs-lookup"><span data-stu-id="26992-191">In order to invoke it, you must assign types to its generic type parameters.</span></span> <span data-ttu-id="26992-192">A questo scopo, usare il metodo <xref:System.Reflection.MethodInfo.MakeGenericMethod%2A>.</span><span class="sxs-lookup"><span data-stu-id="26992-192">Use the <xref:System.Reflection.MethodInfo.MakeGenericMethod%2A> method to do this.</span></span> <span data-ttu-id="26992-193">Il codice seguente crea un metodo generico costruito, specificando <xref:System.String> per `TInput` e `List(Of String)` (`List<string>` in C#) per `TOutput`, e visualizza una rappresentazione in formato stringa del metodo.</span><span class="sxs-lookup"><span data-stu-id="26992-193">The following code creates a constructed generic method, specifying <xref:System.String> for `TInput` and `List(Of String)` (`List<string>` in C#) for `TOutput`, and displays a string representation of the method.</span></span>

    [!code-csharp[GenericMethodHowTo#21](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#21)]
    [!code-vb[GenericMethodHowTo#21](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#21)]

2. <span data-ttu-id="26992-194">Per richiamare il metodo con associazione tardiva, usare il metodo <xref:System.Reflection.MethodBase.Invoke%2A>.</span><span class="sxs-lookup"><span data-stu-id="26992-194">To invoke the method late-bound, use the <xref:System.Reflection.MethodBase.Invoke%2A> method.</span></span> <span data-ttu-id="26992-195">Il codice seguente crea una matrice di <xref:System.Object>, contenente come unico elemento una matrice di stringhe, e passa la matrice come elenco di argomenti per il metodo generico.</span><span class="sxs-lookup"><span data-stu-id="26992-195">The following code creates an array of <xref:System.Object>, containing as its only element an array of strings, and passes it as the argument list for the generic method.</span></span> <span data-ttu-id="26992-196">Il primo parametro di <xref:System.Reflection.MethodBase.Invoke%2A> è un riferimento Null perché il metodo è `static`.</span><span class="sxs-lookup"><span data-stu-id="26992-196">The first parameter of <xref:System.Reflection.MethodBase.Invoke%2A> is a null reference because the method is `static`.</span></span> <span data-ttu-id="26992-197">Viene eseguito il cast del valore restituito in `List(Of String)` e viene visualizzato il primo elemento.</span><span class="sxs-lookup"><span data-stu-id="26992-197">The return value is cast to `List(Of String)`, and its first element is displayed.</span></span>

    [!code-csharp[GenericMethodHowTo#22](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#22)]
    [!code-vb[GenericMethodHowTo#22](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#22)]

3. <span data-ttu-id="26992-198">Per richiamare il metodo usando un delegato, è necessario avere un delegato che corrisponda alla firma del metodo generico costruito.</span><span class="sxs-lookup"><span data-stu-id="26992-198">To invoke the method using a delegate, you must have a delegate that matches the signature of the constructed generic method.</span></span> <span data-ttu-id="26992-199">Un modo semplice per eseguire questa operazione consiste nel creare un delegato generico.</span><span class="sxs-lookup"><span data-stu-id="26992-199">An easy way to do this is to create a generic delegate.</span></span> <span data-ttu-id="26992-200">Il codice seguente crea un'istanza del delegato generico `D` definito nel codice di esempio usando l'overload del metodo <xref:System.Delegate.CreateDelegate%28System.Type%2CSystem.Reflection.MethodInfo%29?displayProperty=nameWithType> e richiama il delegato.</span><span class="sxs-lookup"><span data-stu-id="26992-200">The following code creates an instance of the generic delegate `D` defined in the example code, using the <xref:System.Delegate.CreateDelegate%28System.Type%2CSystem.Reflection.MethodInfo%29?displayProperty=nameWithType> method overload, and invokes the delegate.</span></span> <span data-ttu-id="26992-201">I delegati offrono migliori prestazioni rispetto alle chiamate con associazione tardiva.</span><span class="sxs-lookup"><span data-stu-id="26992-201">Delegates perform better than late-bound calls.</span></span>

    [!code-csharp[GenericMethodHowTo#23](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#23)]
    [!code-vb[GenericMethodHowTo#23](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#23)]

4. <span data-ttu-id="26992-202">Il metodo creato può essere chiamato anche da un programma che fa riferimento all'assembly salvato.</span><span class="sxs-lookup"><span data-stu-id="26992-202">The emitted method can also be called from a program that refers to the saved assembly.</span></span>

## <a name="example"></a><span data-ttu-id="26992-203">Esempio</span><span class="sxs-lookup"><span data-stu-id="26992-203">Example</span></span>

<span data-ttu-id="26992-204">L'esempio di codice seguente crea il tipo non generico `DemoType` con il metodo generico `Factory`.</span><span class="sxs-lookup"><span data-stu-id="26992-204">The following code example creates a nongeneric type, `DemoType`, with a generic method, `Factory`.</span></span> <span data-ttu-id="26992-205">Il metodo ha due parametri di tipo generico, ovvero `TInput` per specificare un tipo di input e `TOutput` per specificare un tipo di output.</span><span class="sxs-lookup"><span data-stu-id="26992-205">This method has two generic type parameters, `TInput` to specify an input type and `TOutput` to specify an output type.</span></span> <span data-ttu-id="26992-206">Al parametro di tipo `TOutput` sono applicati vincoli affinché implementi `ICollection<TInput>` (`ICollection(Of TInput)` in Visual Basic), sia un tipo di riferimento e abbia un costruttore senza parametri.</span><span class="sxs-lookup"><span data-stu-id="26992-206">The `TOutput` type parameter is constrained to implement `ICollection<TInput>` (`ICollection(Of TInput)` in Visual Basic), to be a reference type, and to have a parameterless constructor.</span></span>

<span data-ttu-id="26992-207">Il metodo ha un unico parametro formale che è una matrice di `TInput`.</span><span class="sxs-lookup"><span data-stu-id="26992-207">The method has one formal parameter, which is an array of `TInput`.</span></span> <span data-ttu-id="26992-208">Il metodo restituisce un'istanza di `TOutput` che contiene gli elementi della matrice di input.</span><span class="sxs-lookup"><span data-stu-id="26992-208">The method returns an instance of `TOutput` that contains all the elements of the input array.</span></span> <span data-ttu-id="26992-209">`TOutput` può essere qualsiasi tipo di insieme generico che implementa l'interfaccia generica <xref:System.Collections.Generic.ICollection%601>.</span><span class="sxs-lookup"><span data-stu-id="26992-209">`TOutput` can be any generic collection type that implements the <xref:System.Collections.Generic.ICollection%601> generic interface.</span></span>

<span data-ttu-id="26992-210">Quando il codice viene eseguito, l'assembly dinamico viene salvato come DemoGenericMethod1.dll e può essere esaminato mediante lo strumento [Ildasm.exe (Disassembler IL)](../tools/ildasm-exe-il-disassembler.md).</span><span class="sxs-lookup"><span data-stu-id="26992-210">When the code is executed, the dynamic assembly is saved as DemoGenericMethod1.dll, and can be examined using the [Ildasm.exe (IL Disassembler)](../tools/ildasm-exe-il-disassembler.md).</span></span>

> [!NOTE]
> <span data-ttu-id="26992-211">Per acquisire familiarità con le procedure per la creazione di codice, si consiglia di scrivere un programma Visual Basic, C# o Visual C++ che esegua l'attività che si tenta di creare e usare il disassembler per esaminare il codice MSIL prodotto dal compilatore.</span><span class="sxs-lookup"><span data-stu-id="26992-211">A good way to learn how to emit code is to write a Visual Basic, C#, or Visual C++ program that performs the task you are trying to emit, and use the disassembler to examine the MSIL produced by the compiler.</span></span>

<span data-ttu-id="26992-212">L'esempio di codice include il codice sorgente equivalente al metodo creato.</span><span class="sxs-lookup"><span data-stu-id="26992-212">The code example includes source code that is equivalent to the emitted method.</span></span> <span data-ttu-id="26992-213">Il metodo creato viene richiamato con associazione tardiva e anche tramite un delegato generico dichiarato nell'esempio di codice.</span><span class="sxs-lookup"><span data-stu-id="26992-213">The emitted method is invoked late-bound and also by using a generic delegate declared in the code example.</span></span>

[!code-csharp[GenericMethodHowTo#1](../../../samples/snippets/csharp/VS_Snippets_CLR/GenericMethodHowTo/CS/source.cs#1)]
[!code-vb[GenericMethodHowTo#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/GenericMethodHowTo/VB/source.vb#1)]

## <a name="see-also"></a><span data-ttu-id="26992-214">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="26992-214">See also</span></span>

- <xref:System.Reflection.Emit.MethodBuilder>
- [<span data-ttu-id="26992-215">Procedura: Definire un tipo generico tramite reflection emit</span><span class="sxs-lookup"><span data-stu-id="26992-215">How to: Define a Generic Type with Reflection Emit</span></span>](how-to-define-a-generic-type-with-reflection-emit.md)
