---
title: Programmazione asincrona in C#
description: Panoramica del supporto del linguaggio C# per la programmazione asincrona con async, await, Task e Task<T>
ms.date: 06/04/2020
ms.openlocfilehash: 992ccd3a015653ea9ee13dfc309d47711ad0fca4
ms.sourcegitcommit: e02d17b2cf9c1258dadda4810a5e6072a0089aee
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 07/01/2020
ms.locfileid: "85619715"
---
# <a name="asynchronous-programming-with-async-and-await"></a><span data-ttu-id="9abf5-103">Programmazione asincrona con async e await</span><span class="sxs-lookup"><span data-stu-id="9abf5-103">Asynchronous programming with async and await</span></span>

<span data-ttu-id="9abf5-104">Il [modello di programmazione asincrona (TAP) dell'attività](task-asynchronous-programming-model.md) fornisce un'astrazione sul codice asincrono.</span><span class="sxs-lookup"><span data-stu-id="9abf5-104">The [Task asynchronous programming model (TAP)](task-asynchronous-programming-model.md) provides an abstraction over asynchronous code.</span></span> <span data-ttu-id="9abf5-105">Scrivere il codice come sequenza di istruzioni secondo la normale procedura.</span><span class="sxs-lookup"><span data-stu-id="9abf5-105">You write code as a sequence of statements, just like always.</span></span> <span data-ttu-id="9abf5-106">È possibile leggere il codice come se ogni istruzione venisse completata prima che venga iniziata quella successiva.</span><span class="sxs-lookup"><span data-stu-id="9abf5-106">You can read that code as though each statement completes before the next begins.</span></span> <span data-ttu-id="9abf5-107">Il compilatore esegue una serie di trasformazioni poiché alcune delle istruzioni potrebbero essere eseguite e restituire <xref:System.Threading.Tasks.Task> che rappresenta il lavoro in corso.</span><span class="sxs-lookup"><span data-stu-id="9abf5-107">The compiler performs a number of transformations because some of those statements may start work and return a <xref:System.Threading.Tasks.Task> that represents the ongoing work.</span></span>

<span data-ttu-id="9abf5-108">L'obiettivo di questa sintassi consiste nell'abilitare un codice che viene letto come una sequenza di istruzioni ma viene eseguito in un ordine più complesso in base all'allocazione delle risorse esterne e al completamento dell'attività.</span><span class="sxs-lookup"><span data-stu-id="9abf5-108">That's the goal of this syntax: enable code that reads like a sequence of statements, but executes in a much more complicated order based on external resource allocation and when tasks complete.</span></span> <span data-ttu-id="9abf5-109">Si tratta di un funzionamento analogo a quello in cui gli utenti specificano istruzioni per i processi che includono attività asincrone.</span><span class="sxs-lookup"><span data-stu-id="9abf5-109">It's analogous to how people give instructions for processes that include asynchronous tasks.</span></span> <span data-ttu-id="9abf5-110">In questo articolo si userà un esempio di istruzioni per la creazione di una colazione per vedere come le `async` `await` parole chiave e semplificano la motivazione del codice, che include una serie di istruzioni asincrone.</span><span class="sxs-lookup"><span data-stu-id="9abf5-110">Throughout this article, you'll use an example of instructions for making a breakfast to see how the `async` and `await` keywords make it easier to reason about code, that includes a series of asynchronous instructions.</span></span> <span data-ttu-id="9abf5-111">Si procederà a scrivere istruzioni come quelle dell'elenco seguente per descrivere come preparare una colazione:</span><span class="sxs-lookup"><span data-stu-id="9abf5-111">You'd write the instructions something like the following list to explain how to make a breakfast:</span></span>

1. <span data-ttu-id="9abf5-112">Versare una tazza di caffè.</span><span class="sxs-lookup"><span data-stu-id="9abf5-112">Pour a cup of coffee.</span></span>
1. <span data-ttu-id="9abf5-113">Scaldare una padella e friggere due uova.</span><span class="sxs-lookup"><span data-stu-id="9abf5-113">Heat up a pan, then fry two eggs.</span></span>
1. <span data-ttu-id="9abf5-114">Friggere tre fette di pancetta.</span><span class="sxs-lookup"><span data-stu-id="9abf5-114">Fry three slices of bacon.</span></span>
1. <span data-ttu-id="9abf5-115">Tostare due fette di pane.</span><span class="sxs-lookup"><span data-stu-id="9abf5-115">Toast two pieces of bread.</span></span>
1. <span data-ttu-id="9abf5-116">Aggiungere burro e marmellata alla fetta di pane tostata.</span><span class="sxs-lookup"><span data-stu-id="9abf5-116">Add butter and jam to the toast.</span></span>
1. <span data-ttu-id="9abf5-117">Versare un bicchiere di succo d'arancia.</span><span class="sxs-lookup"><span data-stu-id="9abf5-117">Pour a glass of orange juice.</span></span>

<span data-ttu-id="9abf5-118">Se si ha esperienza in cucina, queste istruzioni verranno eseguite **in modo asincrono**.</span><span class="sxs-lookup"><span data-stu-id="9abf5-118">If you have experience with cooking, you'd execute those instructions **asynchronously**.</span></span> <span data-ttu-id="9abf5-119">Si inizierà a scaldare la padella per le uova e si inizierà a cuocere la pancetta.</span><span class="sxs-lookup"><span data-stu-id="9abf5-119">You'd start warming the pan for eggs, then start the bacon.</span></span> <span data-ttu-id="9abf5-120">Si inserirà il pane nel tostapane, quindi si inizieranno a cuocere le uova.</span><span class="sxs-lookup"><span data-stu-id="9abf5-120">You'd put the bread in the toaster, then start the eggs.</span></span> <span data-ttu-id="9abf5-121">A ogni passaggio del processo si inizia un'attività, quindi ci si dedica alle attività che man mano richiedono attenzione.</span><span class="sxs-lookup"><span data-stu-id="9abf5-121">At each step of the process, you'd start a task, then turn your attention to tasks that are ready for your attention.</span></span>

<span data-ttu-id="9abf5-122">La preparazione della colazione è un buon esempio di lavoro asincrono non parallelo.</span><span class="sxs-lookup"><span data-stu-id="9abf5-122">Cooking breakfast is a good example of asynchronous work that isn't parallel.</span></span> <span data-ttu-id="9abf5-123">Tutte le attività possono essere gestite da una sola persona (o thread).</span><span class="sxs-lookup"><span data-stu-id="9abf5-123">One person (or thread) can handle all these tasks.</span></span> <span data-ttu-id="9abf5-124">Continuando con l'analogia della colazione, una sola persona può preparare la colazione in modo asincrono iniziando l'attività successiva prima che l'attività precedente venga completata.</span><span class="sxs-lookup"><span data-stu-id="9abf5-124">Continuing the breakfast analogy, one person can make breakfast asynchronously by starting the next task before the first completes.</span></span> <span data-ttu-id="9abf5-125">La preparazione procede indipendentemente dal fatto che venga controllata da qualcuno.</span><span class="sxs-lookup"><span data-stu-id="9abf5-125">The cooking progresses whether or not someone is watching it.</span></span> <span data-ttu-id="9abf5-126">Non appena si inizia a scaldare la padella per le uova, è possibile iniziare a friggere la pancetta.</span><span class="sxs-lookup"><span data-stu-id="9abf5-126">As soon as you start warming the pan for the eggs, you can begin frying the bacon.</span></span> <span data-ttu-id="9abf5-127">Dopo aver iniziato a cuocere la pancetta, è possibile inserire il pane nel tostapane.</span><span class="sxs-lookup"><span data-stu-id="9abf5-127">Once the bacon starts, you can put the bread into the toaster.</span></span>

<span data-ttu-id="9abf5-128">In un algoritmo parallelo sarebbero necessari più cuochi (o thread).</span><span class="sxs-lookup"><span data-stu-id="9abf5-128">For a parallel algorithm, you'd need multiple cooks (or threads).</span></span> <span data-ttu-id="9abf5-129">Un cuoco cucinerebbe le uova, un cuoco cucinerebbe la pancetta e così via.</span><span class="sxs-lookup"><span data-stu-id="9abf5-129">One would make the eggs, one the bacon, and so on.</span></span> <span data-ttu-id="9abf5-130">Ogni cuoco si dedicherebbe a una singola attività.</span><span class="sxs-lookup"><span data-stu-id="9abf5-130">Each one would be focused on just that one task.</span></span> <span data-ttu-id="9abf5-131">Ogni cuoco (o thread) verrebbe bloccato in modo sincrono in attesa che la pancetta sia pronta per essere girata o che la tostatura del pane venga completata.</span><span class="sxs-lookup"><span data-stu-id="9abf5-131">Each cook (or thread) would be blocked synchronously waiting for bacon to be ready to flip, or the toast to pop.</span></span>

<span data-ttu-id="9abf5-132">A questo punto, prendere in esame le stesse istruzioni scritte sotto forma di istruzioni C#:</span><span class="sxs-lookup"><span data-stu-id="9abf5-132">Now, consider those same instructions written as C# statements:</span></span>

:::code language="csharp" source="snippets/index/AsyncBreakfast-starter/Program.cs" highlight="8-27":::

:::image type="content" source="media/synchronous-breakfast.png" alt-text="colazione sincrona":::

<span data-ttu-id="9abf5-134">La colazione preparata in modo sincrono richiede circa 30 minuti perché il totale è la somma di ogni singola attività.</span><span class="sxs-lookup"><span data-stu-id="9abf5-134">The synchronously prepared breakfast, took roughly 30 minutes because the total is the sum of each individual task.</span></span>

> [!NOTE]
> <span data-ttu-id="9abf5-135">Le `Coffee` `Egg` classi,, `Bacon` , `Toast` e `Juice` sono vuote.</span><span class="sxs-lookup"><span data-stu-id="9abf5-135">The `Coffee`, `Egg`, `Bacon`, `Toast`, and `Juice` classes are empty.</span></span> <span data-ttu-id="9abf5-136">Sono semplicemente classi marcatore per lo scopo della dimostrazione, non contengono proprietà e non servono altri scopi.</span><span class="sxs-lookup"><span data-stu-id="9abf5-136">They are simply marker classes for the purpose of demonstration, contain no properties, and serve no other purpose.</span></span>

<span data-ttu-id="9abf5-137">I computer non interpretano le istruzioni allo stesso modo delle persone.</span><span class="sxs-lookup"><span data-stu-id="9abf5-137">Computers don't interpret those instructions the same way people do.</span></span> <span data-ttu-id="9abf5-138">Il computer si bloccherà in corrispondenza di ogni istruzione fino a quando non verrà completata prima di passare all'istruzione successiva.</span><span class="sxs-lookup"><span data-stu-id="9abf5-138">The computer will block on each statement until the work is complete before moving on to the next statement.</span></span> <span data-ttu-id="9abf5-139">In questo modo non verrà preparata una colazione soddisfacente.</span><span class="sxs-lookup"><span data-stu-id="9abf5-139">That creates an unsatisfying breakfast.</span></span> <span data-ttu-id="9abf5-140">Le attività successive non verranno iniziate prima del completamento delle attività precedenti.</span><span class="sxs-lookup"><span data-stu-id="9abf5-140">The later tasks wouldn't be started until the earlier tasks had completed.</span></span> <span data-ttu-id="9abf5-141">La preparazione della colazione richiederà più tempo e alcuni alimenti si raffredderanno prima di essere serviti.</span><span class="sxs-lookup"><span data-stu-id="9abf5-141">It would take much longer to create the breakfast, and some items would have gotten cold before being served.</span></span>

<span data-ttu-id="9abf5-142">Se si vuole che il computer esegua le istruzioni precedenti in modo asincrono, è necessario scrivere codice asincrono.</span><span class="sxs-lookup"><span data-stu-id="9abf5-142">If you want the computer to execute the above instructions asynchronously, you must write asynchronous code.</span></span>

<span data-ttu-id="9abf5-143">Queste considerazioni sono importanti per l'attuale scrittura dei programmi.</span><span class="sxs-lookup"><span data-stu-id="9abf5-143">These concerns are important for the programs you write today.</span></span> <span data-ttu-id="9abf5-144">Quando si scrivono programmi client, si vuole che l'interfaccia utente risponda all'input dell'utente.</span><span class="sxs-lookup"><span data-stu-id="9abf5-144">When you write client programs, you want the UI to be responsive to user input.</span></span> <span data-ttu-id="9abf5-145">L'applicazione non deve bloccare l'uso del telefono durante il download di dati dal Web.</span><span class="sxs-lookup"><span data-stu-id="9abf5-145">Your application shouldn't make a phone appear frozen while it's downloading data from the web.</span></span> <span data-ttu-id="9abf5-146">Quando si scrivono programmi server, non si vuole che i thread vengano bloccati.</span><span class="sxs-lookup"><span data-stu-id="9abf5-146">When you write server programs, you don't want threads blocked.</span></span> <span data-ttu-id="9abf5-147">I thread potrebbero essere impegnati a rispondere ad altre richieste.</span><span class="sxs-lookup"><span data-stu-id="9abf5-147">Those threads could be serving other requests.</span></span> <span data-ttu-id="9abf5-148">L'uso di codice sincrono quando sono presenti alternative asincrone riduce la possibilità di aumentare le istanze in modo meno costoso.</span><span class="sxs-lookup"><span data-stu-id="9abf5-148">Using synchronous code when asynchronous alternatives exist hurts your ability to scale out less expensively.</span></span> <span data-ttu-id="9abf5-149">I thread bloccati hanno un costo.</span><span class="sxs-lookup"><span data-stu-id="9abf5-149">You pay for those blocked threads.</span></span>

<span data-ttu-id="9abf5-150">Per applicazioni moderne efficienti è necessario creare codice asincrono.</span><span class="sxs-lookup"><span data-stu-id="9abf5-150">Successful modern applications require asynchronous code.</span></span> <span data-ttu-id="9abf5-151">Senza supporto del linguaggio, la scrittura di codice asincrono richiedeva callback, eventi di completamento o altri elementi che nascondevano la finalità originale del codice.</span><span class="sxs-lookup"><span data-stu-id="9abf5-151">Without language support, writing asynchronous code required callbacks, completion events, or other means that obscured the original intent of the code.</span></span> <span data-ttu-id="9abf5-152">Il vantaggio del codice sincrono risiede nella semplicità di comprensione.</span><span class="sxs-lookup"><span data-stu-id="9abf5-152">The advantage of the synchronous code is that it's easy to understand.</span></span> <span data-ttu-id="9abf5-153">Le azioni passo passo rendono più semplice l'analisi e la comprensione.</span><span class="sxs-lookup"><span data-stu-id="9abf5-153">The step-by-step actions make it easy to scan and understand.</span></span> <span data-ttu-id="9abf5-154">Nei modelli asincroni tradizionali era necessario porre l'attenzione sulla natura asincrona del codice anziché sulle azioni fondamentali del codice.</span><span class="sxs-lookup"><span data-stu-id="9abf5-154">Traditional asynchronous models forced you to focus on the asynchronous nature of the code, not on the fundamental actions of the code.</span></span>

## <a name="dont-block-await-instead"></a><span data-ttu-id="9abf5-155">Non bloccare, ma attendere</span><span class="sxs-lookup"><span data-stu-id="9abf5-155">Don't block, await instead</span></span>

<span data-ttu-id="9abf5-156">Il codice precedente illustra una prassi non corretta, ovvero la costruzione di codice sincrono per eseguire operazioni asincrone.</span><span class="sxs-lookup"><span data-stu-id="9abf5-156">The preceding code demonstrates a bad practice: constructing synchronous code to perform asynchronous operations.</span></span> <span data-ttu-id="9abf5-157">Come previsto, questo codice impedisce al thread che lo esegue di eseguire altre operazioni.</span><span class="sxs-lookup"><span data-stu-id="9abf5-157">As written, this code blocks the thread executing it from doing any other work.</span></span> <span data-ttu-id="9abf5-158">Non verrà interrotto mentre un'attività è in corso.</span><span class="sxs-lookup"><span data-stu-id="9abf5-158">It won't be interrupted while any of the tasks are in progress.</span></span> <span data-ttu-id="9abf5-159">Equivale a mettersi a osservare il tostapane dopo avere inserito il pane.</span><span class="sxs-lookup"><span data-stu-id="9abf5-159">It would be as though you stared at the toaster after putting the bread in.</span></span> <span data-ttu-id="9abf5-160">E a ignorare qualsiasi interlocutore fino a quando il pane non è pronto.</span><span class="sxs-lookup"><span data-stu-id="9abf5-160">You'd ignore anyone talking to you until the toast popped.</span></span>

<span data-ttu-id="9abf5-161">Si procederà ora ad aggiornare il codice in modo che il thread non venga bloccato mentre sono in esecuzione altre attività.</span><span class="sxs-lookup"><span data-stu-id="9abf5-161">Let's start by updating this code so that the thread doesn't block while tasks are running.</span></span> <span data-ttu-id="9abf5-162">La parola chiave `await` consente di iniziare un'attività senza alcun blocco e di continuare l'esecuzione al completamento dell'attività.</span><span class="sxs-lookup"><span data-stu-id="9abf5-162">The `await` keyword provides a non-blocking way to start a task, then continue execution when that task completes.</span></span> <span data-ttu-id="9abf5-163">Una versione asincrona semplice del codice della preparazione della colazione sarebbe simile al frammento seguente:</span><span class="sxs-lookup"><span data-stu-id="9abf5-163">A simple asynchronous version of the make a breakfast code would look like the following snippet:</span></span>

:::code language="csharp" source="snippets/index/AsyncBreakfast-V2/Program.cs" id="SnippetMain":::

> [!IMPORTANT]
> <span data-ttu-id="9abf5-164">Il tempo totale trascorso è approssimativamente uguale a quello della versione iniziale di Synchonous.</span><span class="sxs-lookup"><span data-stu-id="9abf5-164">The total elapsed time is roughly the same as the initial synchonous version.</span></span> <span data-ttu-id="9abf5-165">Il codice è ancora in uso per sfruttare alcune delle funzionalità principali della programmazione asincrona.</span><span class="sxs-lookup"><span data-stu-id="9abf5-165">The code has yet to take advantage of some of the key features of asynchronous programming.</span></span>

> [!TIP]
> <span data-ttu-id="9abf5-166">I corpi dei metodi di `FryEggsAsync` , `FryBaconAsync` e `ToastBreadAsync` sono stati aggiornati per restituire `Task<Egg>` `Task<Bacon>` rispettivamente, e `Task<Toast>` .</span><span class="sxs-lookup"><span data-stu-id="9abf5-166">The method bodies of the `FryEggsAsync`, `FryBaconAsync`, and `ToastBreadAsync` have all been updated to return `Task<Egg>`, `Task<Bacon>`, and `Task<Toast>` respectively.</span></span> <span data-ttu-id="9abf5-167">I metodi vengono rinominati dalla versione originale per includere il suffisso "Async".</span><span class="sxs-lookup"><span data-stu-id="9abf5-167">The methods are renamed from their original version to include the "Async" suffix.</span></span> <span data-ttu-id="9abf5-168">Le rispettive implementazioni vengono visualizzate come parte della [versione finale](#final-version) più avanti in questo articolo.</span><span class="sxs-lookup"><span data-stu-id="9abf5-168">Their implementations are shown as part of the [final version](#final-version) later in this article.</span></span>

<span data-ttu-id="9abf5-169">Questo codice non si blocca durante la cottura delle uova o della pancetta.</span><span class="sxs-lookup"><span data-stu-id="9abf5-169">This code doesn't block while the eggs or the bacon are cooking.</span></span> <span data-ttu-id="9abf5-170">Il codice tuttavia non inizia altre attività.</span><span class="sxs-lookup"><span data-stu-id="9abf5-170">This code won't start any other tasks though.</span></span> <span data-ttu-id="9abf5-171">Si inserisce il pane nel tostapane e si rimane a osservarlo fino al completamento della cottura.</span><span class="sxs-lookup"><span data-stu-id="9abf5-171">You'd still put the toast in the toaster and stare at it until it pops.</span></span> <span data-ttu-id="9abf5-172">Ma almeno si risponde a un interlocutore che richiede attenzione.</span><span class="sxs-lookup"><span data-stu-id="9abf5-172">But at least, you'd respond to anyone that wanted your attention.</span></span> <span data-ttu-id="9abf5-173">In un ristorante in cui vengono fatte più ordinazioni, il cuoco può iniziare a preparare un'altra colazione mentre la prima è in cottura.</span><span class="sxs-lookup"><span data-stu-id="9abf5-173">In a restaurant where multiple orders are placed, the cook could start another breakfast while the first is cooking.</span></span>

<span data-ttu-id="9abf5-174">Il thread impegnato nella preparazione della colazione non è bloccato in attesa che venga completata un'attività iniziata.</span><span class="sxs-lookup"><span data-stu-id="9abf5-174">Now, the thread working on the breakfast isn't blocked while awaiting any started task that hasn't yet finished.</span></span> <span data-ttu-id="9abf5-175">Per alcune applicazioni, questa modifica è tutto ciò che serve.</span><span class="sxs-lookup"><span data-stu-id="9abf5-175">For some applications, this change is all that's needed.</span></span> <span data-ttu-id="9abf5-176">Un'applicazione GUI risponde sempre all'utente solo con questa modifica.</span><span class="sxs-lookup"><span data-stu-id="9abf5-176">A GUI application still responds to the user with just this change.</span></span> <span data-ttu-id="9abf5-177">Tuttavia, per questo scenario si desidera un altro funzionamento.</span><span class="sxs-lookup"><span data-stu-id="9abf5-177">However, for this scenario, you want more.</span></span> <span data-ttu-id="9abf5-178">Non si vuole che ogni attività del componente venga eseguita in modo sequenziale.</span><span class="sxs-lookup"><span data-stu-id="9abf5-178">You don't want each of the component tasks to be executed sequentially.</span></span> <span data-ttu-id="9abf5-179">È preferibile iniziare ogni attività del componente prima del completamento dell'attività precedente.</span><span class="sxs-lookup"><span data-stu-id="9abf5-179">It's better to start each of the component tasks before awaiting the previous task's completion.</span></span>

## <a name="start-tasks-concurrently"></a><span data-ttu-id="9abf5-180">Iniziare più attività contemporaneamente</span><span class="sxs-lookup"><span data-stu-id="9abf5-180">Start tasks concurrently</span></span>

<span data-ttu-id="9abf5-181">In molti scenari si vuole iniziare immediatamente più attività indipendenti.</span><span class="sxs-lookup"><span data-stu-id="9abf5-181">In many scenarios, you want to start several independent tasks immediately.</span></span> <span data-ttu-id="9abf5-182">Quindi, man mano che ogni attività viene terminata, è possibile passare ad altre operazioni da eseguire.</span><span class="sxs-lookup"><span data-stu-id="9abf5-182">Then, as each task finishes, you can continue other work that's ready.</span></span> <span data-ttu-id="9abf5-183">Nell'analogia della colazione, questa modalità consente di preparare la colazione più rapidamente.</span><span class="sxs-lookup"><span data-stu-id="9abf5-183">In the breakfast analogy, that's how you get breakfast done more quickly.</span></span> <span data-ttu-id="9abf5-184">Inoltre, tutte le operazioni vengono terminate quasi nello stesso momento.</span><span class="sxs-lookup"><span data-stu-id="9abf5-184">You also get everything done close to the same time.</span></span> <span data-ttu-id="9abf5-185">Si otterrà una colazione calda.</span><span class="sxs-lookup"><span data-stu-id="9abf5-185">You'll get a hot breakfast.</span></span>

<span data-ttu-id="9abf5-186"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> e i tipi correlati sono classi che è possibile usare per motivare le attività in corso.</span><span class="sxs-lookup"><span data-stu-id="9abf5-186">The <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> and related types are classes you can use to reason about tasks that are in progress.</span></span> <span data-ttu-id="9abf5-187">in questo modo è possibile scrivere codice più simile al modo in cui effettivamente si prepara una colazione.</span><span class="sxs-lookup"><span data-stu-id="9abf5-187">That enables you to write code that more closely resembles the way you'd actually create breakfast.</span></span> <span data-ttu-id="9abf5-188">Si inizia a cuocere uova, pancetta e pane contemporaneamente.</span><span class="sxs-lookup"><span data-stu-id="9abf5-188">You'd start cooking the eggs, bacon, and toast at the same time.</span></span> <span data-ttu-id="9abf5-189">Man mano che ogni attività richiederà un'azione, si porrà l'attenzione su quell'attività, quindi sull'azione successiva e infine si rimarrà in attesa di altra attività da eseguire.</span><span class="sxs-lookup"><span data-stu-id="9abf5-189">As each requires action, you'd turn your attention to that task, take care of the next action, then await for something else that requires your attention.</span></span>

<span data-ttu-id="9abf5-190">Si inizia un'attività e la si mantiene nell'oggetto <xref:System.Threading.Tasks.Task> che rappresenta il lavoro.</span><span class="sxs-lookup"><span data-stu-id="9abf5-190">You start a task and hold on to the <xref:System.Threading.Tasks.Task> object that represents the work.</span></span> <span data-ttu-id="9abf5-191">Si rimarrà in attesa (`await`) di ogni attività prima di utilizzarne il risultato.</span><span class="sxs-lookup"><span data-stu-id="9abf5-191">You'll `await` each task before working with its result.</span></span>

<span data-ttu-id="9abf5-192">Verranno ora apportate queste modifiche al codice della colazione.</span><span class="sxs-lookup"><span data-stu-id="9abf5-192">Let's make these changes to the breakfast code.</span></span> <span data-ttu-id="9abf5-193">Il primo passaggio consiste nell'archiviare le attività delle operazioni quando vengono iniziate, anziché rimanere in attesa di esse:</span><span class="sxs-lookup"><span data-stu-id="9abf5-193">The first step is to store the tasks for operations when they start, rather than awaiting them:</span></span>

```csharp
Coffee cup = PourCoffee();
Console.WriteLine("coffee is ready");

Task<Egg> eggsTask = FryEggsAsync(2);
Egg eggs = await eggsTask;
Console.WriteLine("eggs are ready");

Task<Bacon> baconTask = FryBaconAsync(3);
Bacon bacon = await baconTask;
Console.WriteLine("bacon is ready");

Task<Toast> toastTask = ToastBreadAsync(2);
Toast toast = await toastTask;
ApplyButter(toast);
ApplyJam(toast);
Console.WriteLine("toast is ready");

Juice oj = PourOJ();
Console.WriteLine("oj is ready");
Console.WriteLine("Breakfast is ready!");
```

<span data-ttu-id="9abf5-194">Successivamente, è possibile spostare le istruzioni `await` della pancetta e delle uova alla fine del metodo, prima di servire la colazione:</span><span class="sxs-lookup"><span data-stu-id="9abf5-194">Next, you can move the `await` statements for the bacon and eggs to the end of the method, before serving breakfast:</span></span>

```csharp
Coffee cup = PourCoffee();
Console.WriteLine("coffee is ready");

Task<Egg> eggsTask = FryEggsAsync(2);
Task<Bacon> baconTask = FryBaconAsync(3);
Task<Toast> toastTask = ToastBreadAsync(2);

Toast toast = await toastTask;
ApplyButter(toast);
ApplyJam(toast);
Console.WriteLine("toast is ready");
Juice oj = PourOJ();
Console.WriteLine("oj is ready");

Egg eggs = await eggsTask;
Console.WriteLine("eggs are ready");
Bacon bacon = await baconTask;
Console.WriteLine("bacon is ready");

Console.WriteLine("Breakfast is ready!");
```

:::image type="content" source="media/asynchronous-breakfast.png" alt-text="colazione asincrona":::

<span data-ttu-id="9abf5-196">La preparazione in modo asincrono ha richiesto circa 20 minuti perché alcune attività erano in grado di essere eseguite contemporaneamente.</span><span class="sxs-lookup"><span data-stu-id="9abf5-196">The asynchronously prepared breakfast took roughly 20 minutes, this is because some tasks were able to run concurrently.</span></span>

<span data-ttu-id="9abf5-197">Il codice precedente ha un funzionamento migliore.</span><span class="sxs-lookup"><span data-stu-id="9abf5-197">The preceding code works better.</span></span> <span data-ttu-id="9abf5-198">Tutte le attività asincrone vengono iniziate contemporaneamente.</span><span class="sxs-lookup"><span data-stu-id="9abf5-198">You start all the asynchronous tasks at once.</span></span> <span data-ttu-id="9abf5-199">Si rimane in attesa di ogni attività solo quando è necessario avere a disposizione il risultato dell'attività.</span><span class="sxs-lookup"><span data-stu-id="9abf5-199">You await each task only when you need the results.</span></span> <span data-ttu-id="9abf5-200">Il codice precedente potrebbe essere simile al codice di un'applicazione Web che effettua le richieste di diversi microservizi, quindi unisce i risultati in una singola pagina.</span><span class="sxs-lookup"><span data-stu-id="9abf5-200">The preceding code may be similar to code in a web application that makes requests of different microservices, then combines the results into a single page.</span></span> <span data-ttu-id="9abf5-201">Si eseguiranno tutte le richieste immediatamente, quindi si rimarrà in attesa (`await`) di tutte le attività e si comporrà la pagina Web.</span><span class="sxs-lookup"><span data-stu-id="9abf5-201">You'll make all the requests immediately, then `await` all those tasks and compose the web page.</span></span>

## <a name="composition-with-tasks"></a><span data-ttu-id="9abf5-202">Composizione di attività</span><span class="sxs-lookup"><span data-stu-id="9abf5-202">Composition with tasks</span></span>

 <span data-ttu-id="9abf5-203">Tutti gli alimenti della colazione sono pronti contemporaneamente ad eccezione del pane.</span><span class="sxs-lookup"><span data-stu-id="9abf5-203">You have everything ready for breakfast at the same time except the toast.</span></span> <span data-ttu-id="9abf5-204">La preparazione del pane rappresenta la composizione di un'operazione asincrona (tostatura del pane) e di operazioni sincrone (aggiunta del burro e della marmellata).</span><span class="sxs-lookup"><span data-stu-id="9abf5-204">Making the toast is the composition of an asynchronous operation (toasting the bread), and synchronous operations (adding the butter and the jam).</span></span> <span data-ttu-id="9abf5-205">L'aggiornamento di questo codice illustra un concetto importante:</span><span class="sxs-lookup"><span data-stu-id="9abf5-205">Updating this code illustrates an important concept:</span></span>

> [!IMPORTANT]
> <span data-ttu-id="9abf5-206">La composizione di un'operazione asincrona, seguita da un lavoro sincrono è un'operazione asincrona.</span><span class="sxs-lookup"><span data-stu-id="9abf5-206">The composition of an asynchronous operation followed by synchronous work is an asynchronous operation.</span></span> <span data-ttu-id="9abf5-207">In altre parole, se una parte di un'operazione è asincrona, l'intera operazione è asincrona.</span><span class="sxs-lookup"><span data-stu-id="9abf5-207">Stated another way, if any portion of an operation is asynchronous, the entire operation is asynchronous.</span></span>

<span data-ttu-id="9abf5-208">Il codice precedente ha mostrato che è possibile usare gli oggetti <xref:System.Threading.Tasks.Task> o <xref:System.Threading.Tasks.Task%601> per attività in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="9abf5-208">The preceding code showed you that you can use <xref:System.Threading.Tasks.Task> or <xref:System.Threading.Tasks.Task%601> objects to hold running tasks.</span></span> <span data-ttu-id="9abf5-209">Si rimane in attesa (`await`) di ogni attività prima di usarne il risultato.</span><span class="sxs-lookup"><span data-stu-id="9abf5-209">You `await` each task before using its result.</span></span> <span data-ttu-id="9abf5-210">Il passaggio successivo consiste nel creare metodi che rappresentano la combinazione di altre operazioni.</span><span class="sxs-lookup"><span data-stu-id="9abf5-210">The next step is to create methods that represent the combination of other work.</span></span> <span data-ttu-id="9abf5-211">Prima di servire la colazione, si vuole attendere l'attività che rappresenta la tostatura del pane prima dell'aggiunta del butto e della marmellata.</span><span class="sxs-lookup"><span data-stu-id="9abf5-211">Before serving breakfast, you want to await the task that represents toasting the bread before adding butter and jam.</span></span> <span data-ttu-id="9abf5-212">È possibile rappresentare queste operazioni con il codice seguente:</span><span class="sxs-lookup"><span data-stu-id="9abf5-212">You can represent that work with the following code:</span></span>

:::code language="csharp" source="snippets/index/AsyncBreakfast-V3/Program.cs" id="SnippetComposeToastTask":::

<span data-ttu-id="9abf5-213">Il metodo precedente include il modificatore `async` nella firma.</span><span class="sxs-lookup"><span data-stu-id="9abf5-213">The preceding method has the `async` modifier in its signature.</span></span> <span data-ttu-id="9abf5-214">Il modificatore segnala al compilatore che il metodo contiene un'istruzione `await`; contiene operazioni asincrone.</span><span class="sxs-lookup"><span data-stu-id="9abf5-214">That signals to the compiler that this method contains an `await` statement; it contains asynchronous operations.</span></span> <span data-ttu-id="9abf5-215">Questo metodo rappresenta l'attività di tostatura del pane, quindi aggiunge il burro e la marmellata.</span><span class="sxs-lookup"><span data-stu-id="9abf5-215">This method represents the task that toasts the bread, then adds butter and jam.</span></span> <span data-ttu-id="9abf5-216">Questo metodo restituisce <xref:System.Threading.Tasks.Task%601> che rappresenta la composizione di queste tre operazioni.</span><span class="sxs-lookup"><span data-stu-id="9abf5-216">This method returns a <xref:System.Threading.Tasks.Task%601> that represents the composition of those three operations.</span></span> <span data-ttu-id="9abf5-217">Il blocco di codice principale sarà ora il seguente:</span><span class="sxs-lookup"><span data-stu-id="9abf5-217">The main block of code now becomes:</span></span>

:::code language="csharp" source="snippets/index/AsyncBreakfast-V3/Program.cs" id="SnippetMain":::

<span data-ttu-id="9abf5-218">La modifica precedente ha illustrato una tecnica importante per l'uso di codice asincrono.</span><span class="sxs-lookup"><span data-stu-id="9abf5-218">The previous change illustrated an important technique for working with asynchronous code.</span></span> <span data-ttu-id="9abf5-219">Si compongono le attività separando le operazioni in un nuovo metodo che restituisce un'attività.</span><span class="sxs-lookup"><span data-stu-id="9abf5-219">You compose tasks by separating the operations into a new method that returns a task.</span></span> <span data-ttu-id="9abf5-220">È possibile scegliere quando rimanere in attesa dell'attività.</span><span class="sxs-lookup"><span data-stu-id="9abf5-220">You can choose when to await that task.</span></span> <span data-ttu-id="9abf5-221">È possibile iniziare altre attività contemporaneamente.</span><span class="sxs-lookup"><span data-stu-id="9abf5-221">You can start other tasks concurrently.</span></span>

## <a name="await-tasks-efficiently"></a><span data-ttu-id="9abf5-222">Attendere le attività in modo efficiente</span><span class="sxs-lookup"><span data-stu-id="9abf5-222">Await tasks efficiently</span></span>

<span data-ttu-id="9abf5-223">La serie di istruzioni `await` alla fine del codice precedente può essere migliorata usando i metodi della classe `Task`.</span><span class="sxs-lookup"><span data-stu-id="9abf5-223">The series of `await` statements at the end of the preceding code can be improved by using methods of the `Task` class.</span></span> <span data-ttu-id="9abf5-224">Una delle API è <xref:System.Threading.Tasks.Task.WhenAll%2A> che restituisce <xref:System.Threading.Tasks.Task> che viene completata quando tutte le attività del relativo elenco di argomenti sono state completate, come illustrato nel codice seguente:</span><span class="sxs-lookup"><span data-stu-id="9abf5-224">One of those APIs is <xref:System.Threading.Tasks.Task.WhenAll%2A>, which returns a <xref:System.Threading.Tasks.Task> that completes when all the tasks in its argument list have completed, as shown in the following code:</span></span>

```csharp
await Task.WhenAll(eggsTask, baconTask, toastTask);
Console.WriteLine("eggs are ready");
Console.WriteLine("bacon is ready");
Console.WriteLine("toast is ready");
Console.WriteLine("Breakfast is ready!");
```

<span data-ttu-id="9abf5-225">Un'altra opzione consiste nell'usare <xref:System.Threading.Tasks.Task.WhenAny%2A> che restituisce `Task<Task>` che viene completata quando tutti i relativi argomenti vengono completati.</span><span class="sxs-lookup"><span data-stu-id="9abf5-225">Another option is to use <xref:System.Threading.Tasks.Task.WhenAny%2A>, which returns a `Task<Task>` that completes when any of its arguments completes.</span></span> <span data-ttu-id="9abf5-226">È possibile attendere l'attività restituita, sapendo che è già stata completata.</span><span class="sxs-lookup"><span data-stu-id="9abf5-226">You can await the returned task, knowing that it has already finished.</span></span> <span data-ttu-id="9abf5-227">Il codice seguente illustra come è possibile usare <xref:System.Threading.Tasks.Task.WhenAny%2A> per attendere il completamento della prima attività e quindi elaborarne il risultato.</span><span class="sxs-lookup"><span data-stu-id="9abf5-227">The following code shows how you could use <xref:System.Threading.Tasks.Task.WhenAny%2A> to await the first task to finish and then process its result.</span></span> <span data-ttu-id="9abf5-228">Dopo aver elaborato il risultato dell'attività completata, si rimuove l'attività completata dall'elenco delle attività passate a `WhenAny`.</span><span class="sxs-lookup"><span data-stu-id="9abf5-228">After processing the result from the completed task, you remove that completed task from the list of tasks passed to `WhenAny`.</span></span>

```csharp
var breakfastTasks = new List<Task> { eggsTask, baconTask, toastTask };
while (breakfastTasks.Count > 0)
{
    Task finishedTask = await Task.WhenAny(breakfastTasks);
    if (finishedTask == eggsTask)
    {
        Console.WriteLine("eggs are ready");
    }
    else if (finishedTask == baconTask)
    {
        Console.WriteLine("bacon is ready");
    }
    else if (finishedTask == toastTask)
    {
        Console.WriteLine("toast is ready");
    }
    breakfastTasks.Remove(finishedTask);
}
```

<span data-ttu-id="9abf5-229">Dopo aver apportato tutte le modifiche, la versione finale del codice è simile alla seguente:<a id="final-version"></a></span><span class="sxs-lookup"><span data-stu-id="9abf5-229">After all those changes, the final version of the code looks like this: <a id="final-version"></a></span></span>
:::code language="csharp" source="snippets/index/AsyncBreakfast-final/Program.cs" highlight="9-40":::

:::image type="content" source="media/whenany-async-breakfast.png" alt-text="Quando una qualsiasi colazione asincrona":::

<span data-ttu-id="9abf5-231">La versione finale della colazione preparata in modo asincrono richiede circa 15 minuti, perché alcune attività possono essere eseguite simultaneamente e il codice è stato in grado di monitorare più attività contemporaneamente e di intervenire solo quando necessario.</span><span class="sxs-lookup"><span data-stu-id="9abf5-231">The final version of the asynchronously prepared breakfast took roughly 15 minutes, this is because some tasks were able to run concurrently, and the code was able to monitor multiple tasks at once and only take action when it was needed.</span></span>

<span data-ttu-id="9abf5-232">Il codice finale è asincrono.</span><span class="sxs-lookup"><span data-stu-id="9abf5-232">This final code is asynchronous.</span></span> <span data-ttu-id="9abf5-233">Riflette con maggior precisione il modo in cui viene preparata una colazione.</span><span class="sxs-lookup"><span data-stu-id="9abf5-233">It more accurately reflects how a person would cook a breakfast.</span></span> <span data-ttu-id="9abf5-234">Confrontare il codice precedente con il primo esempio di codice di questo articolo.</span><span class="sxs-lookup"><span data-stu-id="9abf5-234">Compare the preceding code with the first code sample in this article.</span></span> <span data-ttu-id="9abf5-235">Le azioni principali risultano ancora chiare dalla lettura del codice.</span><span class="sxs-lookup"><span data-stu-id="9abf5-235">The core actions are still clear from reading the code.</span></span> <span data-ttu-id="9abf5-236">È possibile leggere il codice allo stesso modo in cui si leggerebbero le istruzioni per preparare una colazione riportate all'inizio di questo articolo.</span><span class="sxs-lookup"><span data-stu-id="9abf5-236">You can read this code the same way you'd read those instructions for making a breakfast at the beginning of this article.</span></span> <span data-ttu-id="9abf5-237">Le funzionalità del linguaggio per `async` e `await` offrono la traduzione che ogni persona farebbe per seguire le istruzioni scritte: iniziare le attività non appena possibile e non bloccarsi in attesa del completamento delle attività.</span><span class="sxs-lookup"><span data-stu-id="9abf5-237">The language features for `async` and `await` provide the translation every person makes to follow those written instructions: start tasks as you can and don't block waiting for tasks to complete.</span></span>

## <a name="next-steps"></a><span data-ttu-id="9abf5-238">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="9abf5-238">Next steps</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="9abf5-239">Informazioni sul modello di programmazione asincrona delle attività</span><span class="sxs-lookup"><span data-stu-id="9abf5-239">Learn about the task asynchronous programming model</span></span>](task-asynchronous-programming-model.md)
